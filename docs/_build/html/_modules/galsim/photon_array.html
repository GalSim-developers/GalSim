

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>galsim.photon_array &mdash; GalSim 2.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> GalSim
          

          
          </a>

          
            
            
              <div class="version">
                2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../image.html">Images and Related Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sb.html">Surface Brightness Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chromatic.html">Wavelength-dependent Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wcs.html">World Coordinate Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../random.html">Noise and Random Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wl.html">Weak Lensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../photon.html">Photon Shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Helper Functions and Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../errors.html">Errors and Warnings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">The Config Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hsm.html">The HSM Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../des.html">The DES Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wfirst.html">The WFIRST Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.html">Shared Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">Revision History</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GalSim</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>galsim.photon_array</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for galsim.photon_array</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2012-2019 by the GalSim developers team on GitHub</span>
<span class="c1"># https://github.com/GalSim-developers</span>
<span class="c1">#</span>
<span class="c1"># This file is part of GalSim: The modular galaxy image simulation toolkit.</span>
<span class="c1"># https://github.com/GalSim-developers/GalSim</span>
<span class="c1">#</span>
<span class="c1"># GalSim is free software: redistribution and use in source and binary forms,</span>
<span class="c1"># with or without modification, are permitted provided that the following</span>
<span class="c1"># conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#    list of conditions, and the disclaimer given in the accompanying LICENSE</span>
<span class="c1">#    file.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#    this list of conditions, and the disclaimer given in the documentation</span>
<span class="c1">#    and/or other materials provided with the distribution.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">_galsim</span>
<span class="kn">from</span> <span class="nn">.random</span> <span class="k">import</span> <span class="n">UniformDeviate</span><span class="p">,</span> <span class="n">BaseDeviate</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="k">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">.angle</span> <span class="k">import</span> <span class="n">radians</span><span class="p">,</span> <span class="n">arcsec</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="k">import</span> <span class="n">GalSimError</span><span class="p">,</span> <span class="n">GalSimRangeError</span><span class="p">,</span> <span class="n">GalSimValueError</span><span class="p">,</span> <span class="n">GalSimUndefinedBoundsError</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="k">import</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">,</span> <span class="n">convert_cpp_errors</span>

<span class="c1"># Add on more methods in the python layer</span>

<div class="viewcode-block" id="PhotonArray"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray">[docs]</a><span class="k">class</span> <span class="nc">PhotonArray</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The PhotonArray class encapsulates the concept of a collection of photons incident on</span>
<span class="sd">    a detector.</span>

<span class="sd">    A PhotonArray object is not typically constructed directly by the user.  Rather, it is</span>
<span class="sd">    typically constructed as the return value of the `GSObject.shoot` method.</span>
<span class="sd">    At this point, the photons only have x,y,flux values.</span>

<span class="sd">    Then there are a number of `Surface Operators`, which perform various modifications to the</span>
<span class="sd">    photons such as giving them wavelengths (`WavelengthSampler` or inclination angles</span>
<span class="sd">    (`FRatioAngles`) or move them around according to the effect of differential chromatic</span>
<span class="sd">    refraction (DCR; `PhotonDCR`).</span>

<span class="sd">    One could also add functionality to remove some photons due to fringing or vignetting,</span>
<span class="sd">    but these are not yet implemented.</span>

<span class="sd">    A PhotonArray instance has the following attributes, each of which is a numpy array:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        x:          The incidence x position at the top of the detector</span>
<span class="sd">        y:          The incidence y position at the top of the detector</span>
<span class="sd">        flux:       The flux of the photons</span>
<span class="sd">        dxdz:       The tangent of the inclination angles in the x direction</span>
<span class="sd">        dydz:       The tangent of the inclination angles in the y direction</span>
<span class="sd">        wavelength  The wavelength of the photons (in nm)</span>

<span class="sd">    Unlike most GalSim objects (but like `Image`), PhotonArrays are mutable.  It is permissible</span>
<span class="sd">    to write values to the above attributes with code like::</span>

<span class="sd">        &gt;&gt;&gt; photon_array.x += numpy.random.random(1000) * 0.01</span>
<span class="sd">        &gt;&gt;&gt; photon_array.flux *= 20.</span>
<span class="sd">        &gt;&gt;&gt; photon_array.wavelength = sed.sampleWavelength(photonarray.size(), bandpass)</span>
<span class="sd">        etc.</span>

<span class="sd">    All of these will update the existing numpy arrays being used by the photon_array instance.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Normal photons have flux=1, but we allow for &quot;fat&quot; photons that combine the effect of</span>
<span class="sd">        several photons at once for efficiency.  Also, some profiles need to use negative flux</span>
<span class="sd">        photons to properly implement photon shooting (e.g. `InterpolatedImage`, which uses negative</span>
<span class="sd">        flux photons to get the interpolation correct).  Finally, when we &quot;remove&quot; photons, for</span>
<span class="sd">        better efficiency, we actually just set the flux to 0 rather than recreate new numpy arrays.</span>

<span class="sd">    The initialization constructs a PhotonArray to hold N photons, but does not set the values of</span>
<span class="sd">    anything yet.  The constructor allocates space for the x,y,flux arrays, since those are always</span>
<span class="sd">    needed.  The other arrays are only allocated on demand if the user accesses these attributes.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        N:          The number of photons to store in this PhotonArray.  This value cannot be</span>
<span class="sd">                    changed.</span>
<span class="sd">        x:          Optionally, the initial x values. [default: None]</span>
<span class="sd">        y:          Optionally, the initial y values. [default: None]</span>
<span class="sd">        flux:       Optionally, the initial flux values. [default: None]</span>
<span class="sd">        dxdz:       Optionally, the initial dxdz values. [default: None]</span>
<span class="sd">        dydz:       Optionally, the initial dydz values. [default: None]</span>
<span class="sd">        wavelength: Optionally, the initial wavelength values (in nm). [default: None]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dxdz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dydz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wavelength</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Only x, y, flux are built by default, since these are always required.</span>
        <span class="c1"># The others we leave as None unless/until they are needed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dxdz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dydz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wave</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_corr</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># These give reasonable errors in x,y,flux are the wrong size/type</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">if</span> <span class="n">flux</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span>
        <span class="k">if</span> <span class="n">dxdz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dxdz</span> <span class="o">=</span> <span class="n">dxdz</span>
        <span class="k">if</span> <span class="n">dydz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dydz</span> <span class="o">=</span> <span class="n">dydz</span>
        <span class="k">if</span> <span class="n">wavelength</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength</span>

<div class="viewcode-block" id="PhotonArray.size"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.size">[docs]</a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the size of the photon array.  Equivalent to ``len(self)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The incidence x position at the top of the detector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span>
    <span class="nd">@x</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The incidence y position at the top of the detector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span>
    <span class="nd">@y</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The flux of the photons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flux</span>
    <span class="nd">@flux</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flux</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dxdz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The tangent of the inclination angles in the x direction: dx/dz.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocateAngles</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdz</span>
    <span class="nd">@dxdz</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dxdz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocateAngles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dxdz</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dydz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The tangent of the inclination angles in the y direction: dy/dz.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocateAngles</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dydz</span>
    <span class="nd">@dydz</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dydz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocateAngles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dydz</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wavelength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The wavelength of the photons (in nm).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocateWavelengths</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wave</span>
    <span class="nd">@wavelength</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">wavelength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocateWavelengths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wave</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="PhotonArray.hasAllocatedAngles"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.hasAllocatedAngles">[docs]</a>    <span class="k">def</span> <span class="nf">hasAllocatedAngles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether the arrays for the incidence angles `dxdz` and `dydz` have been</span>
<span class="sd">        allocated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dydz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PhotonArray.allocateAngles"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.allocateAngles">[docs]</a>    <span class="k">def</span> <span class="nf">allocateAngles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allocate memory for the incidence angles, `dxdz` and `dydz`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dxdz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dydz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_pa&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhotonArray.hasAllocatedWavelengths"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.hasAllocatedWavelengths">[docs]</a>    <span class="k">def</span> <span class="nf">hasAllocatedWavelengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether the `wavelength` array has been allocated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wave</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PhotonArray.allocateWavelengths"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.allocateWavelengths">[docs]</a>    <span class="k">def</span> <span class="nf">allocateWavelengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allocate the memory for the `wavelength` array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wave</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_pa&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhotonArray.isCorrelated"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.isCorrelated">[docs]</a>    <span class="k">def</span> <span class="nf">isCorrelated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether the photons are correlated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_corr</span></div>

<div class="viewcode-block" id="PhotonArray.setCorrelated"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.setCorrelated">[docs]</a>    <span class="k">def</span> <span class="nf">setCorrelated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_corr</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set whether the photons are correlated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_corr</span> <span class="o">=</span> <span class="n">is_corr</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_pa&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhotonArray.getTotalFlux"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.getTotalFlux">[docs]</a>    <span class="k">def</span> <span class="nf">getTotalFlux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total flux of all the photons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>

<div class="viewcode-block" id="PhotonArray.setTotalFlux"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.setTotalFlux">[docs]</a>    <span class="k">def</span> <span class="nf">setTotalFlux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rescale the photon fluxes to achieve the given total flux.</span>

<span class="sd">        Parameter:</span>
<span class="sd">            flux:       The target flux</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaleFlux</span><span class="p">(</span><span class="n">flux</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTotalFlux</span><span class="p">())</span></div>

<div class="viewcode-block" id="PhotonArray.scaleFlux"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.scaleFlux">[docs]</a>    <span class="k">def</span> <span class="nf">scaleFlux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rescale the photon fluxes by the given factor.</span>

<span class="sd">        Parameter:</span>
<span class="sd">            scale:      The factor by which to scale the fluxes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flux</span> <span class="o">*=</span> <span class="n">scale</span></div>

<div class="viewcode-block" id="PhotonArray.scaleXY"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.scaleXY">[docs]</a>    <span class="k">def</span> <span class="nf">scaleXY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scale the photon positions (`x` and `y`) by the given factor.</span>

<span class="sd">        Parameter:</span>
<span class="sd">            scale:      The factor by which to scale the positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhotonArray.assignAt"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.assignAt">[docs]</a>    <span class="k">def</span> <span class="nf">assignAt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">istart</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign the contents of another `PhotonArray` to this one starting at istart.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">istart</span> <span class="o">+</span> <span class="n">rhs</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">GalSimValueError</span><span class="p">(</span>
                <span class="s2">&quot;The given rhs does not fit into this array starting at </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">istart</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">istart</span><span class="p">,</span> <span class="n">istart</span> <span class="o">+</span> <span class="n">rhs</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">flux</span>
        <span class="k">if</span> <span class="n">rhs</span><span class="o">.</span><span class="n">hasAllocatedAngles</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dxdz</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">dxdz</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dydz</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">dydz</span>
        <span class="k">if</span> <span class="n">rhs</span><span class="o">.</span><span class="n">hasAllocatedWavelengths</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wavelength</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">wavelength</span></div>

<div class="viewcode-block" id="PhotonArray.convolve"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.convolve">[docs]</a>    <span class="k">def</span> <span class="nf">convolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convolve this `PhotonArray` with another.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rhs</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span><span class="s2">&quot;PhotonArray.convolve with unequal size arrays&quot;</span><span class="p">,</span>
                                                <span class="n">self_pa</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="o">=</span><span class="n">rhs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">BaseDeviate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pa</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">_pa</span><span class="p">,</span> <span class="n">rng</span><span class="o">.</span><span class="n">_rng</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;galsim.PhotonArray(</span><span class="si">%d</span><span class="s2">, x=array(</span><span class="si">%r</span><span class="s2">), y=array(</span><span class="si">%r</span><span class="s2">), flux=array(</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAllocatedAngles</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;, dxdz=array(</span><span class="si">%r</span><span class="s2">), dydz=array(</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dxdz</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dydz</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAllocatedWavelengths</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;, wavelength=array(</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelength</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;galsim.PhotonArray(</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_pa&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span>

    <span class="fm">__hash__</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">PhotonArray</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">hasAllocatedAngles</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">hasAllocatedAngles</span><span class="p">()</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">hasAllocatedWavelengths</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">hasAllocatedWavelengths</span><span class="p">()</span> <span class="ow">and</span>
                 <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dxdz</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">dxdz</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAllocatedAngles</span><span class="p">()</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dydz</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">dydz</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAllocatedAngles</span><span class="p">()</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">wavelength</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAllocatedWavelengths</span><span class="p">()</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span> <span class="p">))</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_pa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#assert(self._x.strides[0] == self._x.itemsize)</span>
        <span class="c1">#assert(self._y.strides[0] == self._y.itemsize)</span>
        <span class="c1">#assert(self._flux.strides[0] == self._flux.itemsize)</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span>
        <span class="n">_flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flux</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span>
        <span class="n">_dxdz</span> <span class="o">=</span> <span class="n">_dydz</span> <span class="o">=</span> <span class="n">_wave</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAllocatedAngles</span><span class="p">():</span>
            <span class="c1">#assert(self._dxdz.strides[0] == self._dxdz.itemsize)</span>
            <span class="c1">#assert(self._dydz.strides[0] == self._dydz.itemsize)</span>
            <span class="n">_dxdz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxdz</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span>
            <span class="n">_dydz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dydz</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAllocatedWavelengths</span><span class="p">():</span>
            <span class="c1">#assert(self._wave.strides[0] == self._wave.itemsize)</span>
            <span class="n">_wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wave</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span>
        <span class="k">with</span> <span class="n">convert_cpp_errors</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">_galsim</span><span class="o">.</span><span class="n">PhotonArray</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">()),</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_flux</span><span class="p">,</span> <span class="n">_dxdz</span><span class="p">,</span> <span class="n">_dydz</span><span class="p">,</span> <span class="n">_wave</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_is_corr</span><span class="p">)</span>

<div class="viewcode-block" id="PhotonArray.addTo"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.addTo">[docs]</a>    <span class="k">def</span> <span class="nf">addTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add flux of photons to an image by binning into pixels.</span>

<span class="sd">        Photons in this `PhotonArray` are binned into the pixels of the input</span>
<span class="sd">        `Image` and their flux summed into the pixels.  The `Image` is assumed to represent</span>
<span class="sd">        surface brightness, so photons&#39; fluxes are divided by image pixel area.</span>
<span class="sd">        Photons past the edges of the image are discarded.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            image:      The `Image` to which the photons&#39; flux will be added.</span>

<span class="sd">        Returns:</span>
<span class="sd">            the total flux of photons the landed inside the image bounds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">isDefined</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">GalSimUndefinedBoundsError</span><span class="p">(</span>
                <span class="s2">&quot;Attempting to PhotonArray::addTo an Image with undefined Bounds&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pa</span><span class="o">.</span><span class="n">addTo</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">_image</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhotonArray.makeFromImage"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.makeFromImage">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">makeFromImage</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">max_flux</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn an existing `Image` into a `PhotonArray` that would accumulate into this image.</span>

<span class="sd">        The flux in each non-zero pixel will be turned into 1 or more photons with random positions</span>
<span class="sd">        within the pixel bounds.  The ``max_flux`` parameter (which defaults to 1) sets an upper</span>
<span class="sd">        limit for the absolute value of the flux of any photon.  Pixels with abs values &gt; maxFlux</span>
<span class="sd">        will spawn multiple photons.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            image:      The image to turn into a `PhotonArray`</span>
<span class="sd">            max_flux:   The maximum flux value to use for any output photon [default: 1]</span>
<span class="sd">            rng:        A `BaseDeviate` to use for the random number generation [default: None]</span>

<span class="sd">        Returns:</span>
<span class="sd">            a `PhotonArray`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: This corresponds to the Nearest interpolant.  It would be worth figuring out how</span>
        <span class="c1">#       to implement other (presumably better) interpolation options here.</span>

        <span class="n">max_flux</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_flux</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">max_flux</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GalSimRangeError</span><span class="p">(</span><span class="s2">&quot;max_flux must be positive&quot;</span><span class="p">,</span> <span class="n">max_flux</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">total_flux</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># This goes a bit over what we actually need, but not by much.  Worth it to not have to</span>
        <span class="c1"># worry about array reallocations.</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">total_flux</span> <span class="o">/</span> <span class="n">max_flux</span><span class="p">)</span>
        <span class="n">photons</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">BaseDeviate</span><span class="p">()</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">photons</span><span class="o">.</span><span class="n">_pa</span><span class="o">.</span><span class="n">setFrom</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="n">max_flux</span><span class="p">,</span> <span class="n">rng</span><span class="o">.</span><span class="n">_rng</span><span class="p">)</span>
        <span class="n">photons</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">photons</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">N</span><span class="p">]</span>
        <span class="n">photons</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">photons</span><span class="o">.</span><span class="n">y</span><span class="p">[:</span><span class="n">N</span><span class="p">]</span>
        <span class="n">photons</span><span class="o">.</span><span class="n">_flux</span> <span class="o">=</span> <span class="n">photons</span><span class="o">.</span><span class="n">flux</span><span class="p">[:</span><span class="n">N</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">scale</span> <span class="o">!=</span> <span class="mf">1.</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">photons</span><span class="o">.</span><span class="n">scaleXY</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">photons</span></div>

<div class="viewcode-block" id="PhotonArray.write"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a `PhotonArray` to a FITS file.</span>

<span class="sd">        The output file will be a FITS binary table with a row for each photon in the `PhotonArray`.</span>
<span class="sd">        Columns will include &#39;id&#39; (sequential from 1 to nphotons), &#39;x&#39;, &#39;y&#39;, and &#39;flux&#39;.</span>
<span class="sd">        Additionally, the columns &#39;dxdz&#39;, &#39;dydz&#39;, and &#39;wavelength&#39; will be included if they are</span>
<span class="sd">        set for this `PhotonArray` object.</span>

<span class="sd">        The file can be read back in with the classmethod `PhotonArray.read`::</span>

<span class="sd">            &gt;&gt;&gt; photons.write(&#39;photons.fits&#39;)</span>
<span class="sd">            &gt;&gt;&gt; photons2 = galsim.PhotonArray.read(&#39;photons.fits&#39;)</span>

<span class="sd">        Parameters:</span>
<span class="sd">            file_name:  The file name of the output FITS file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">._pyfits</span> <span class="k">import</span> <span class="n">pyfits</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">fits</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">())))</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAllocatedAngles</span><span class="p">():</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dxdz&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dxdz</span><span class="p">))</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dydz&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dydz</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAllocatedWavelengths</span><span class="p">():</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelength</span><span class="p">))</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># pragma: no cover  (Might need this for older pyfits versions)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhotonArray.read"><a class="viewcode-back" href="../../photon_array.html#galsim.PhotonArray.read">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a `PhotonArray`, reading the photon data from a FITS file.</span>

<span class="sd">        The file being read in is not arbitrary.  It is expected to be a file that was written</span>
<span class="sd">        out with the `PhotonArray.write` method.::</span>

<span class="sd">            &gt;&gt;&gt; photons.write(&#39;photons.fits&#39;)</span>
<span class="sd">            &gt;&gt;&gt; photons2 = galsim.PhotonArray.read(&#39;photons.fits&#39;)</span>

<span class="sd">        Parameters:</span>
<span class="sd">            file_name:  The file name of the input FITS file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">._pyfits</span> <span class="k">import</span> <span class="n">pyfits</span>
        <span class="k">with</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fits</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span>

        <span class="n">photons</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">flux</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;dxdz&#39;</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">photons</span><span class="o">.</span><span class="n">dxdz</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dxdz&#39;</span><span class="p">]</span>
            <span class="n">photons</span><span class="o">.</span><span class="n">dydz</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dydz&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;wavelength&#39;</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">photons</span><span class="o">.</span><span class="n">wavelength</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">photons</span></div></div>

<div class="viewcode-block" id="WavelengthSampler"><a class="viewcode-back" href="../../surface.html#galsim.WavelengthSampler">[docs]</a><span class="k">class</span> <span class="nc">WavelengthSampler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is a sensor operation that uses sed.sampleWavelength to set the wavelengths</span>
<span class="sd">    array of a `PhotonArray`.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        sed:        The `SED` to use for the objects spectral energy distribution.</span>
<span class="sd">        bandpass:   A `Bandpass` object representing a filter, or None to sample over the full</span>
<span class="sd">                    `SED` wavelength range.</span>
<span class="sd">        rng:        If provided, a random number generator that is any kind of `BaseDeviate`</span>
<span class="sd">                    object. If ``rng`` is None, one will be automatically created, using the</span>
<span class="sd">                    time as a seed. [default: None]</span>
<span class="sd">        npoints:    Number of points `DistDeviate` should use for its internal interpolation</span>
<span class="sd">                    tables. [default: None, which uses the `DistDeviate` default]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sed</span><span class="p">,</span> <span class="n">bandpass</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sed</span> <span class="o">=</span> <span class="n">sed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandpass</span> <span class="o">=</span> <span class="n">bandpass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">BaseDeviate</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npoints</span> <span class="o">=</span> <span class="n">npoints</span>

<div class="viewcode-block" id="WavelengthSampler.applyTo"><a class="viewcode-back" href="../../surface.html#galsim.WavelengthSampler.applyTo">[docs]</a>    <span class="k">def</span> <span class="nf">applyTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photon_array</span><span class="p">,</span> <span class="n">local_wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign wavelengths to the photons sampled from the SED * Bandpass.&quot;&quot;&quot;</span>
        <span class="n">photon_array</span><span class="o">.</span><span class="n">wavelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sed</span><span class="o">.</span><span class="n">sampleWavelength</span><span class="p">(</span>
                <span class="n">photon_array</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandpass</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npoints</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="FRatioAngles"><a class="viewcode-back" href="../../surface.html#galsim.FRatioAngles">[docs]</a><span class="k">class</span> <span class="nc">FRatioAngles</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A surface-layer operator that assigns photon directions based on the f/ratio and</span>
<span class="sd">    obscuration.</span>

<span class="sd">    Assigns arrival directions at the focal plane for photons, drawing from a uniform</span>
<span class="sd">    brightness distribution between the obscuration angle and the edge of the pupil defined</span>
<span class="sd">    by the f/ratio of the telescope.  The angles are expressed in terms of slopes dx/dz</span>
<span class="sd">    and dy/dz.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        fratio:         The f/ratio of the telescope (e.g. 1.2 for LSST)</span>
<span class="sd">        obscuration:    Linear dimension of central obscuration as fraction of aperture</span>
<span class="sd">                        linear dimension. [0., 1.).  [default: 0.0]</span>
<span class="sd">        rng:            A random number generator to use or None, in which case an rng</span>
<span class="sd">                        will be automatically constructed for you. [default: None]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fratio</span><span class="p">,</span> <span class="n">obscuration</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">fratio</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimRangeError</span><span class="p">(</span><span class="s2">&quot;The f-ratio must be positive.&quot;</span><span class="p">,</span> <span class="n">fratio</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obscuration</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">obscuration</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimRangeError</span><span class="p">(</span><span class="s2">&quot;Invalid obscuration.&quot;</span><span class="p">,</span> <span class="n">obscuration</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">ud</span> <span class="o">=</span> <span class="n">UniformDeviate</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fratio</span> <span class="o">=</span> <span class="n">fratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obscuration</span> <span class="o">=</span> <span class="n">obscuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ud</span> <span class="o">=</span> <span class="n">ud</span>


<div class="viewcode-block" id="FRatioAngles.applyTo"><a class="viewcode-back" href="../../surface.html#galsim.FRatioAngles.applyTo">[docs]</a>    <span class="k">def</span> <span class="nf">applyTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photon_array</span><span class="p">,</span> <span class="n">local_wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign directions to the photons in photon_array.&quot;&quot;&quot;</span>

        <span class="n">dxdz</span> <span class="o">=</span> <span class="n">photon_array</span><span class="o">.</span><span class="n">dxdz</span>
        <span class="n">dydz</span> <span class="o">=</span> <span class="n">photon_array</span><span class="o">.</span><span class="n">dydz</span>
        <span class="n">n_photons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dxdz</span><span class="p">)</span>

        <span class="c1"># The f/ratio is the ratio of the focal length to the diameter of the aperture of</span>
        <span class="c1"># the telescope.  The angular radius of the field of view is defined by the</span>
        <span class="c1"># ratio of the radius of the aperture to the focal length</span>
        <span class="n">pupil_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fratio</span><span class="p">)</span>  <span class="c1"># radians</span>
        <span class="n">obscuration_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">obscuration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fratio</span><span class="p">)</span>

        <span class="c1"># Generate azimuthal angles for the photons</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_photons</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ud</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="c1"># Generate inclination angles for the photons, which are uniform in sin(theta) between</span>
        <span class="c1"># the sine of the obscuration angle and the sine of the pupil radius</span>
        <span class="n">sintheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_photons</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ud</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">sintheta</span><span class="p">)</span>
        <span class="n">sintheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">obscuration_angle</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pupil_angle</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">obscuration_angle</span><span class="p">))</span> \
            <span class="o">*</span> <span class="n">sintheta</span>

        <span class="c1"># Assign the directions to the arrays. In this class the convention for the</span>
        <span class="c1"># zero of phi does not matter but it would if the obscuration is dependent on</span>
        <span class="c1"># phi</span>
        <span class="n">tantheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sintheta</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sintheta</span><span class="p">)))</span>
        <span class="n">dxdz</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">tantheta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">dydz</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">tantheta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="PhotonDCR"><a class="viewcode-back" href="../../surface.html#galsim.PhotonDCR">[docs]</a><span class="k">class</span> <span class="nc">PhotonDCR</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;A surface-layer operator that applies the effect of differential chromatic refraction (DCR)</span>
<span class="sd">    and optionally the chromatic dilation due to atmospheric seeing.</span>

<span class="sd">    Due to DCR, blue photons land closer to the zenith than red photons.  Kolmogorov turbulence</span>
<span class="sd">    also predicts that blue photons get spread out more by the atmosphere than red photons,</span>
<span class="sd">    specifically FWHM is proportional to :math:`\lambda^{-0.2}`.  Both of these effects can be</span>
<span class="sd">    implemented by wavelength-dependent shifts of the photons.</span>

<span class="sd">    Since DCR depends on the zenith angle and the parallactic angle (which is the position angle of</span>
<span class="sd">    the zenith measured from North through East) of the object being drawn, these must be specified</span>
<span class="sd">    via keywords.  There are four ways to specify these values:</span>

<span class="sd">    1) explicitly provide ``zenith_angle`` as a keyword of type `Angle`, and ``parallactic_angle``</span>
<span class="sd">       will be assumed to be 0 by default.</span>
<span class="sd">    2) explicitly provide both ``zenith_angle`` and ``parallactic_angle`` as keywords of type</span>
<span class="sd">       `Angle`.</span>
<span class="sd">    3) provide the coordinates of the object ``obj_coord`` and the coordinates of the zenith</span>
<span class="sd">       ``zenith_coord`` as keywords of type `CelestialCoord`.</span>
<span class="sd">    4) provide the coordinates of the object ``obj_coord`` as a `CelestialCoord`, the hour angle</span>
<span class="sd">       of the object ``HA`` as an `Angle`, and the latitude of the observer ``latitude`` as an</span>
<span class="sd">       `Angle`.</span>

<span class="sd">    DCR also depends on temperature, pressure and water vapor pressure of the atmosphere.  The</span>
<span class="sd">    default values for these are expected to be appropriate for LSST at Cerro Pachon, Chile, but</span>
<span class="sd">    they are broadly reasonable for most observatories.</span>

<span class="sd">    This surface op is intended to match the functionality of `ChromaticAtmosphere`, but acting</span>
<span class="sd">    on the photon array rather than as a `ChromaticObject`.  The photons will need to have</span>
<span class="sd">    wavelengths defined in order to work.</span>

<span class="sd">    .. warning::</span>
<span class="sd">        The alpha parameter is only appropriate for stars.  This surface op will act on</span>
<span class="sd">        all of the photons, so applying a chromatic dilation according to the chromatic</span>
<span class="sd">        seeing is the wrong thing to do when the surface brightness being rendered is</span>
<span class="sd">        not a pure PSF.  As such, the default is alpha=0, not -0.2, which would be</span>
<span class="sd">        appropriate for Kolmogorov turbulence.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        base_wavelength:    Wavelength (in nm) represented by the fiducial photon positions</span>
<span class="sd">        scale_unit:         Units used for the positions of the photons.  [default: galsim.arcsec]</span>
<span class="sd">        alpha:              Power law index for wavelength-dependent seeing.  This should only</span>
<span class="sd">                            be used if doing a star-only simulation.  It is not correct when</span>
<span class="sd">                            drawing galaxies. [default: 0.]</span>
<span class="sd">        zenith_angle:       `Angle` from object to zenith, expressed as an `Angle`. [default: 0]</span>
<span class="sd">        parallactic_angle:  Parallactic angle, i.e. the position angle of the zenith, measured</span>
<span class="sd">                            from North through East.  [default: 0]</span>
<span class="sd">        obj_coord:          Celestial coordinates of the object being drawn as a `CelestialCoord`.</span>
<span class="sd">                            [default: None]</span>
<span class="sd">        zenith_coord:       Celestial coordinates of the zenith as a `CelestialCoord`.</span>
<span class="sd">                            [default: None]</span>
<span class="sd">        HA:                 Hour angle of the object as an `Angle`. [default: None]</span>
<span class="sd">        latitude:           Latitude of the observer as an `Angle`. [default: None]</span>
<span class="sd">        pressure:           Air pressure in kiloPascals.  [default: 69.328 kPa]</span>
<span class="sd">        temperature:        Temperature in Kelvins.  [default: 293.15 K]</span>
<span class="sd">        H2O_pressure:       Water vapor pressure in kiloPascals.  [default: 1.067 kPa]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_wavelength</span><span class="p">,</span> <span class="n">scale_unit</span><span class="o">=</span><span class="n">arcsec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">dcr</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">angle</span>

        <span class="c1"># This matches the code in ChromaticAtmosphere.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_wavelength</span> <span class="o">=</span> <span class="n">base_wavelength</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_unit</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">scale_unit</span> <span class="o">=</span> <span class="n">angle</span><span class="o">.</span><span class="n">AngleUnit</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">scale_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_unit</span> <span class="o">=</span> <span class="n">scale_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zenith_angle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallactic_angle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="n">dcr</span><span class="o">.</span><span class="n">parse_dcr_angles</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Any remaining kwargs will get forwarded to galsim.dcr.get_refraction</span>
        <span class="c1"># Check that they&#39;re valid</span>
        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O_pressure&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Got unexpected keyword: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kw</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_refraction</span> <span class="o">=</span> <span class="n">dcr</span><span class="o">.</span><span class="n">get_refraction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_wavelength</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zenith_angle</span><span class="p">,</span>
                                                         <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">)</span>

<div class="viewcode-block" id="PhotonDCR.applyTo"><a class="viewcode-back" href="../../surface.html#galsim.PhotonDCR.applyTo">[docs]</a>    <span class="k">def</span> <span class="nf">applyTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photon_array</span><span class="p">,</span> <span class="n">local_wcs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the DCR effect to the photons</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">dcr</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">photon_array</span><span class="o">.</span><span class="n">hasAllocatedWavelengths</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s2">&quot;PhotonDCR requires that wavelengths be set&quot;</span><span class="p">)</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">photon_array</span><span class="o">.</span><span class="n">wavelength</span>
        <span class="n">cenx</span> <span class="o">=</span> <span class="n">local_wcs</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span>
        <span class="n">ceny</span> <span class="o">=</span> <span class="n">local_wcs</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">y</span>

        <span class="c1"># Apply the wavelength-dependent scaling</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">base_wavelength</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="n">photon_array</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">photon_array</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">cenx</span><span class="p">)</span> <span class="o">+</span> <span class="n">cenx</span>
            <span class="n">photon_array</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">photon_array</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">ceny</span><span class="p">)</span> <span class="o">+</span> <span class="n">ceny</span>

        <span class="c1"># Apply DCR</span>
        <span class="n">shift_magnitude</span> <span class="o">=</span> <span class="n">dcr</span><span class="o">.</span><span class="n">get_refraction</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zenith_angle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">shift_magnitude</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_refraction</span>
        <span class="n">shift_magnitude</span> <span class="o">=</span> <span class="n">shift_magnitude</span> <span class="o">*</span> <span class="p">(</span><span class="n">radians</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_unit</span><span class="p">)</span>
        <span class="n">sinp</span><span class="p">,</span> <span class="n">cosp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallactic_angle</span><span class="o">.</span><span class="n">sincos</span><span class="p">()</span>

        <span class="n">du</span> <span class="o">=</span> <span class="o">-</span><span class="n">shift_magnitude</span> <span class="o">*</span> <span class="n">sinp</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">shift_magnitude</span> <span class="o">*</span> <span class="n">cosp</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">local_wcs</span><span class="o">.</span><span class="n">_x</span><span class="p">(</span><span class="n">du</span><span class="p">,</span> <span class="n">dv</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">local_wcs</span><span class="o">.</span><span class="n">_y</span><span class="p">(</span><span class="n">du</span><span class="p">,</span> <span class="n">dv</span><span class="p">)</span>
        <span class="n">photon_array</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">dx</span>
        <span class="n">photon_array</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">dy</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, GalSim-developers

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>