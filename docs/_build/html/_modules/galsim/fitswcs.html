<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>galsim.fitswcs &mdash; GalSim 2.7.2 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            GalSim
          </a>
              <div class="version">
                2.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../image.html">Images and Related Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sb.html">Surface Brightness Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chromatic.html">Wavelength-dependent Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wcs.html">World Coordinate Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../random.html">Noise and Random Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wl.html">Weak Lensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../photon.html">Photon Shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Helper Functions and Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../errors.html">Errors and Warnings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">The Config Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hsm.html">The HSM Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../des.html">The DES Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roman.html">The Roman Space Telescope Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpp.html">C++ Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.html">Shared Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">Revision History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GalSim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">galsim.fitswcs</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for galsim.fitswcs</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2012-2023 by the GalSim developers team on GitHub</span>
<span class="c1"># https://github.com/GalSim-developers</span>
<span class="c1">#</span>
<span class="c1"># This file is part of GalSim: The modular galaxy image simulation toolkit.</span>
<span class="c1"># https://github.com/GalSim-developers/GalSim</span>
<span class="c1">#</span>
<span class="c1"># GalSim is free software: redistribution and use in source and binary forms,</span>
<span class="c1"># with or without modification, are permitted provided that the following</span>
<span class="c1"># conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#    list of conditions, and the disclaimer given in the accompanying LICENSE</span>
<span class="c1">#    file.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#    this list of conditions, and the disclaimer given in the documentation</span>
<span class="c1">#    and/or other materials provided with the distribution.</span>
<span class="c1">#</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;AstropyWCS&#39;</span><span class="p">,</span> <span class="s1">&#39;PyAstWCS&#39;</span><span class="p">,</span> <span class="s1">&#39;WcsToolsWCS&#39;</span><span class="p">,</span> <span class="s1">&#39;GSFitsWCS&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FitsWCS&#39;</span><span class="p">,</span> <span class="s1">&#39;TanWCS&#39;</span><span class="p">,</span> <span class="s1">&#39;FittedSIPWCS&#39;</span><span class="p">,</span> <span class="p">]</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.wcs</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">.wcs</span> <span class="kn">import</span> <span class="n">CelestialWCS</span><span class="p">,</span> <span class="n">JacobianWCS</span><span class="p">,</span> <span class="n">AffineTransform</span><span class="p">,</span> <span class="n">PixelScale</span><span class="p">,</span> <span class="n">OffsetWCS</span>
<span class="kn">from</span> <span class="nn">.position</span> <span class="kn">import</span> <span class="n">PositionD</span><span class="p">,</span> <span class="n">_PositionD</span>
<span class="kn">from</span> <span class="nn">.angle</span> <span class="kn">import</span> <span class="n">radians</span><span class="p">,</span> <span class="n">arcsec</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">AngleUnit</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_galsim</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="kn">import</span> <span class="n">GalSimError</span><span class="p">,</span> <span class="n">GalSimValueError</span><span class="p">,</span> <span class="n">GalSimIncompatibleValuesError</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="kn">import</span> <span class="n">GalSimNotImplementedError</span><span class="p">,</span> <span class="n">convert_cpp_errors</span><span class="p">,</span> <span class="n">galsim_warn</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">horner2d</span><span class="p">,</span> <span class="n">least_squares</span>
<span class="kn">from</span> <span class="nn">.celestial</span> <span class="kn">import</span> <span class="n">CelestialCoord</span>
<span class="kn">from</span> <span class="nn">._pyfits</span> <span class="kn">import</span> <span class="n">pyfits</span>


<span class="c1">#########################################################################################</span>
<span class="c1">#</span>
<span class="c1"># We have the following WCS classes that know how to read the WCS from a FITS file:</span>
<span class="c1">#</span>
<span class="c1">#     AstropyWCS</span>
<span class="c1">#     PyAstWCS</span>
<span class="c1">#     WcsToolsWCS</span>
<span class="c1">#     GSFitsWCS</span>
<span class="c1">#</span>
<span class="c1"># As for all CelestialWCS classes, they must define the following:</span>
<span class="c1">#</span>
<span class="c1">#     _radec            function returning (ra, dec) in _radians_ at position (x,y)</span>
<span class="c1">#     _xy               function returning (x, y) given (ra, dec) in _radians_.</span>
<span class="c1">#     _writeHeader      function that writes the WCS to a fits header.</span>
<span class="c1">#     _readHeader       static function that reads the WCS from a fits header.</span>
<span class="c1">#     copy              return a copy</span>
<span class="c1">#     __eq__            check if this equals another WCS</span>
<span class="c1">#</span>
<span class="c1">#########################################################################################</span>


<div class="viewcode-block" id="AstropyWCS"><a class="viewcode-back" href="../../wcs.html#galsim.AstropyWCS">[docs]</a><span class="k">class</span> <span class="nc">AstropyWCS</span><span class="p">(</span><span class="n">CelestialWCS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This WCS uses astropy.wcs to read WCS information from a FITS file.</span>
<span class="sd">    It requires the astropy.wcs python module to be installed.</span>

<span class="sd">    Astropy may be installed using pip, fink, or port::</span>

<span class="sd">        &gt;&gt;&gt; pip install astropy</span>
<span class="sd">        &gt;&gt;&gt; fink install astropy-py27</span>
<span class="sd">        &gt;&gt;&gt; port install py27-astropy</span>

<span class="sd">    It also comes by default with Enthought and Anaconda. For more information, see their website:</span>

<span class="sd">        http://www.astropy.org/</span>

<span class="sd">    An AstropyWCS is initialized with one of the following commands::</span>

<span class="sd">        &gt;&gt;&gt; wcs = galsim.AstropyWCS(file_name=file_name)  # Open a file on disk</span>
<span class="sd">        &gt;&gt;&gt; wcs = galsim.AstropyWCS(header=header)        # Use an existing pyfits header</span>
<span class="sd">        &gt;&gt;&gt; wcs = galsim.AstropyWCS(wcs=wcs)              # Use an existing astropy.wcs.WCS instance</span>

<span class="sd">    Exactly one of the parameters ``file_name``, ``header`` or ``wcs`` is required.  Also, since</span>
<span class="sd">    the most common usage will probably be the first, you can also give a ``file_name`` without it</span>
<span class="sd">    being named::</span>

<span class="sd">        &gt;&gt;&gt; wcs = galsim.AstropyWCS(file_name)</span>

<span class="sd">    Parameters:</span>
<span class="sd">        file_name:        The FITS file from which to read the WCS information.  This is probably</span>
<span class="sd">                          the usual parameter to provide.  [default: None]</span>
<span class="sd">        dir:              Optional directory to prepend to ``file_name``. [default: None]</span>
<span class="sd">        hdu:              Optionally, the number of the HDU to use if reading from a file.</span>
<span class="sd">                          The default is to use either the primary or first extension as</span>
<span class="sd">                          appropriate for the given compression.  (e.g. for rice, the first</span>
<span class="sd">                          extension is the one you normally want.) [default: None]</span>
<span class="sd">        header:           The header of an open pyfits (or astropy.io) hdu.  Or, it can be</span>
<span class="sd">                          a FitsHeader object.  [default: None]</span>
<span class="sd">        compression:      Which decompression scheme to use (if any). See galsim.fits.read()</span>
<span class="sd">                          for the available options.  [default: &#39;auto&#39;]</span>
<span class="sd">        wcs:              An existing astropy.wcs.WCS instance [default: None]</span>
<span class="sd">        origin:           Optional origin position for the image coordinate system.</span>
<span class="sd">                          If provided, it should be a PositionD or PositionI.</span>
<span class="sd">                          [default: None]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_req_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;file_name&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">}</span>
    <span class="n">_opt_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;dir&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;hdu&quot;</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span> <span class="p">:</span> <span class="n">PositionD</span><span class="p">,</span>
                    <span class="s2">&quot;compression&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                 <span class="n">wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">scipy</span>  <span class="c1"># AstropyWCS constructor will do this, so check now.</span>
            <span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="c1"># Check this too, since it&#39;s actually what we need from scipy.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Write something useful here (see below). This is just used for the repr.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_origin</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

        <span class="c1"># Read the file if given.</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">file_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">+=</span> <span class="s1">&#39;, hdu=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">hdu</span>
            <span class="k">if</span> <span class="n">compression</span> <span class="o">!=</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">+=</span> <span class="s1">&#39;, compression=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">compression</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot provide both file_name and pyfits header&quot;</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot provide both file_name and wcs&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>
            <span class="n">hdu</span><span class="p">,</span> <span class="n">hdu_list</span><span class="p">,</span> <span class="n">fin</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">readFile</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">hdu</span><span class="p">,</span> <span class="n">compression</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>

            <span class="c1"># Load the wcs from the header.</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot provide both pyfits header and wcs&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>

                <span class="c1"># These can mess things up later if they stick around.</span>
                <span class="n">header</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;BZERO&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">header</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;BSCALE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">FitsHeader</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="c1"># Not sure if this can still trigger.  There used to be input files that</span>
                    <span class="c1"># caused various errors in astropy, but that no longer seems to be true</span>
                    <span class="c1"># with astropy 4.x.  Leave this check here though, so the user can potentially</span>
                    <span class="c1"># get a more comprehensible error message if astropy fails.</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Astropy failed to read WCS from </span><span class="si">%s</span><span class="s2">. Original error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
                                  <span class="n">file_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># New kind of error starting in astropy 2.0.5 (I think).  Sometimes, it</span>
                    <span class="c1"># gets through the above, but doesn&#39;t actually load the right WCS.</span>
                    <span class="c1"># E.g. ZPX gets marked as just a ZPN.</span>
                    <span class="c1"># As of version 4.0, ZPX is now the only one known to not work.  TPV has</span>
                    <span class="c1"># a similar behavior, but we can make it work by an adjustment to the header</span>
                    <span class="c1"># in _load_from_header.</span>
                    <span class="k">if</span> <span class="s1">&#39;ZPX&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;ZPX&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                            <span class="s2">&quot;Cannot read WCS in </span><span class="si">%s</span><span class="s2"> with astropy. &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;As of astropy version 4.0.1, ZPX WCS&#39;s were still not being &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;correctly read by astropy.wcs. If you believe this has been &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;fixed, please open a GalSim issue to remove this check.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Must provide one of file_name, header, or wcs&quot;</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fits</span><span class="o">.</span><span class="n">closeHDUList</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">,</span> <span class="n">fin</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">wcs</span><span class="o">.</span><span class="n">is_celestial</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s2">&quot;The WCS read in does not define a pair of celestial axes&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span> <span class="o">=</span> <span class="n">wcs</span>

    <span class="k">def</span> <span class="nf">_load_from_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;TAN&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;PV1_1&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;TAN&#39;</span><span class="p">,</span><span class="s1">&#39;TPV&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;TAN&#39;</span><span class="p">,</span><span class="s1">&#39;TPV&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="c1"># The constructor might emit warnings if it wants to fix the header</span>
            <span class="c1"># information (e.g. RADECSYS -&gt; RADESYSa).  We&#39;d rather ignore these</span>
            <span class="c1"># warnings, since we don&#39;t much care if the input file is non-standard</span>
            <span class="c1"># so long as we can make it work.</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">wcs</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wcs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The underlying ``astropy.wcs.WCS`` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The origin in image coordinates of the WCS function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_origin</span>

    <span class="k">def</span> <span class="nf">_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ra_dec_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># astropy outputs ra, dec in degrees.  Need to convert to radians.</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">degrees</span> <span class="o">/</span> <span class="n">radians</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sanity checks that the inputs are the same shape.</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">ra</span> <span class="o">*=</span> <span class="n">factor</span>
            <span class="n">dec</span> <span class="o">*=</span> <span class="n">factor</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span>

    <span class="k">def</span> <span class="nf">_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">radians</span> <span class="o">/</span> <span class="n">degrees</span>

        <span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ra_dec_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sanity checks that the inputs are the same shape.</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ra</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">dec</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">_newOrigin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_writeHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
        <span class="c1"># Make a new header with the contents of this WCS.</span>
        <span class="c1"># Note: relax = True means to write out non-standard FITS types.</span>
        <span class="c1"># Weirdly, this is the default when reading the header, but not when writing.</span>
        <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span><span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># And write the name as a special GalSim key</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_WCS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;AstropyWCS&quot;</span><span class="p">,</span> <span class="s2">&quot;GalSim WCS name&quot;</span><span class="p">)</span>
        <span class="c1"># And the image origin.</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_X0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;GalSim image origin x&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_Y0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;GalSim image origin y&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">header</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_readHeader</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GS_X0&quot;</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GS_Y0&quot;</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AstropyWCS</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">_PositionD</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">AstropyWCS</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">AstropyWCS</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">AstropyWCS</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span><span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span><span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;header=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;wcs=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span>
        <span class="k">return</span> <span class="s2">&quot;galsim.AstropyWCS(</span><span class="si">%s</span><span class="s2">, origin=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_wcs&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span></div>


<div class="viewcode-block" id="PyAstWCS"><a class="viewcode-back" href="../../wcs.html#galsim.PyAstWCS">[docs]</a><span class="k">class</span> <span class="nc">PyAstWCS</span><span class="p">(</span><span class="n">CelestialWCS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This WCS uses PyAst (the python front end for the Starlink AST code) to read WCS</span>
<span class="sd">    information from a FITS file.  It requires the starlink.Ast python module to be installed.</span>

<span class="sd">    Starlink may be installed using pip::</span>

<span class="sd">        &gt;&gt;&gt; pip install starlink-pyast</span>

<span class="sd">    For more information, see their website:</span>

<span class="sd">    https://pypi.python.org/pypi/starlink-pyast/</span>

<span class="sd">    A PyAstWCS is initialized with one of the following commands::</span>

<span class="sd">        &gt;&gt;&gt; wcs = galsim.PyAstWCS(file_name=file_name)  # Open a file on disk</span>
<span class="sd">        &gt;&gt;&gt; wcs = galsim.PyAstWCS(header=header)        # Use an existing pyfits header</span>
<span class="sd">        &gt;&gt;&gt; wcs = galsim.PyAstWCS(wcsinfo=wcsinfo)      # Use an existing starlink.Ast.FrameSet</span>

<span class="sd">    Exactly one of the parameters ``file_name``, ``header`` or ``wcsinfo`` is required.  Also,</span>
<span class="sd">    since the most common usage will probably be the first, you can also give a file name without</span>
<span class="sd">    it being named::</span>

<span class="sd">        &gt;&gt;&gt; wcs = galsim.PyAstWCS(file_name)</span>

<span class="sd">    Parameters:</span>
<span class="sd">        file_name:        The FITS file from which to read the WCS information.  This is probably</span>
<span class="sd">                          the usual parameter to provide.  [default: None]</span>
<span class="sd">        dir:              Optional directory to prepend to ``file_name``. [default: None]</span>
<span class="sd">        hdu:              Optionally, the number of the HDU to use if reading from a file.</span>
<span class="sd">                          The default is to use either the primary or first extension as</span>
<span class="sd">                          appropriate for the given compression.  (e.g. for rice, the first</span>
<span class="sd">                          extension is the one you normally want.) [default: None]</span>
<span class="sd">        header:           The header of an open pyfits (or astropy.io) hdu.  Or, it can be</span>
<span class="sd">                          a FitsHeader object.  [default: None]</span>
<span class="sd">        compression:      Which decompression scheme to use (if any). See galsim.fits.read()</span>
<span class="sd">                          for the available options.  [default:&#39;auto&#39;]</span>
<span class="sd">        wcsinfo:          An existing starlink.Ast.FrameSet [default: None]</span>
<span class="sd">        origin:           Optional origin position for the image coordinate system.</span>
<span class="sd">                          If provided, it should be a PositionD or PositionI.</span>
<span class="sd">                          [default: None]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_req_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;file_name&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">}</span>
    <span class="n">_opt_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;dir&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;hdu&quot;</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span> <span class="p">:</span> <span class="n">PositionD</span><span class="p">,</span>
                    <span class="s2">&quot;compression&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                 <span class="n">wcsinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Write something useful here (see below). This is just used for the repr.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_origin</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

        <span class="c1"># Read the file if given.</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">file_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">+=</span> <span class="s1">&#39;, hdu=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">hdu</span>
            <span class="k">if</span> <span class="n">compression</span> <span class="o">!=</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">+=</span> <span class="s1">&#39;, compression=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">compression</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot provide both file_name and pyfits header&quot;</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wcsinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot provide both file_name and wcsinfo&quot;</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">wcsinfo</span><span class="o">=</span><span class="n">wcsinfo</span><span class="p">)</span>
            <span class="n">hdu</span><span class="p">,</span> <span class="n">hdu_list</span><span class="p">,</span> <span class="n">fin</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">readFile</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">hdu</span><span class="p">,</span> <span class="n">compression</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>

            <span class="c1"># Load the wcs from the header.</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wcsinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot provide both pyfits header and wcsinfo&quot;</span><span class="p">,</span>
                        <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">wcsinfo</span><span class="o">=</span><span class="n">wcsinfo</span><span class="p">)</span>

                <span class="c1"># These can mess things up later if they stick around.</span>
                <span class="n">header</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;BZERO&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">header</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;BSCALE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">FitsHeader</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                <span class="n">wcsinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">wcsinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Must provide one of file_name, header, or wcsinfo&quot;</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">wcsinfo</span><span class="o">=</span><span class="n">wcsinfo</span><span class="p">)</span>

            <span class="c1">#  We can only handle WCS with 2 pixel axes (given by Nin) and 2 WCS axes</span>
            <span class="c1"># (given by Nout).</span>
            <span class="k">if</span> <span class="n">wcsinfo</span><span class="o">.</span><span class="n">Nin</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">wcsinfo</span><span class="o">.</span><span class="n">Nout</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s2">&quot;The world coordinate system is not 2-dimensional&quot;</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fits</span><span class="o">.</span><span class="n">closeHDUList</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">,</span> <span class="n">fin</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wcsinfo</span> <span class="o">=</span> <span class="n">wcsinfo</span>

    <span class="k">def</span> <span class="nf">_load_from_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starlink.Atl</span>
        <span class="c1"># Note: For much of this class implementation, I&#39;ve followed the example provided here:</span>
        <span class="c1">#       http://dsberry.github.io/starlink/node4.html</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># PyFITSAdapter requires an hdu, not a header, so just put it in a pyfits header object.</span>
        <span class="c1"># It turns out there are subtle differences between this and using the original FITS</span>
        <span class="c1"># file hdu that we read in above.  So there is a slight inefficiency here in creating</span>
        <span class="c1"># a new blank PrimaryHDU for this.  But in return we gain more reliable serializability.</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">FitsHeader</span><span class="p">(</span><span class="n">hdu_list</span><span class="o">=</span><span class="n">hdu</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="c1"># They aren&#39;t so good at keeping up with the latest pyfits and numpy syntax, so</span>
            <span class="c1"># this next line can emit deprecation warnings.</span>
            <span class="c1"># We can safely ignore them (for now...)</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">starlink</span><span class="o">.</span><span class="n">Ast</span><span class="o">.</span><span class="n">FitsChan</span><span class="p">(</span><span class="n">starlink</span><span class="o">.</span><span class="n">Atl</span><span class="o">.</span><span class="n">PyFITSAdapter</span><span class="p">(</span><span class="n">hdu</span><span class="p">))</span>
            <span class="c1">#  Read a FrameSet from the FITS header.</span>
            <span class="n">wcsinfo</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">wcsinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Failed to read WCS information from fits file&quot;</span><span class="p">)</span>

        <span class="c1"># The PyAst WCS might not have (RA,Dec) axes, which we want.  It might for instance have</span>
        <span class="c1"># (Dec, RA) instead.  If it&#39;s possible to convert to an (RA,Dec) system, this next line</span>
        <span class="c1"># will do so.  And if not, the result will be None.</span>
        <span class="c1"># cf. https://github.com/timj/starlink-pyast/issues/8</span>
        <span class="n">wcsinfo</span> <span class="o">=</span> <span class="n">wcsinfo</span><span class="o">.</span><span class="n">findframe</span><span class="p">(</span><span class="n">starlink</span><span class="o">.</span><span class="n">Ast</span><span class="o">.</span><span class="n">SkyFrame</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">wcsinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s2">&quot;The WCS read in does not define a pair of celestial axes&quot;</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">wcsinfo</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wcsinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The underlying ``starlink.Ast.FrameSet`` for this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcsinfo</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The origin in image coordinates of the WCS function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_origin</span>

    <span class="k">def</span> <span class="nf">_fix_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="c1"># We allow for the option to fix up the header information when a modification can</span>
        <span class="c1"># make it readable by PyAst.</span>

        <span class="c1"># There was an older proposed standard that used TAN with PV values, which is used by</span>
        <span class="c1"># SCamp, so we want to support it if possible.  The standard is now called TPV, which</span>
        <span class="c1"># PyAst understands.  All we need to do is change the names of the CTYPE values.</span>
        <span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;CTYPE1&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;TAN&#39;</span><span class="p">)</span> <span class="ow">and</span>
             <span class="s1">&#39;CTYPE2&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;TAN&#39;</span><span class="p">)</span> <span class="ow">and</span>
             <span class="s1">&#39;PV1_1&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="p">):</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;TAN&#39;</span><span class="p">,</span><span class="s1">&#39;TPV&#39;</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;TAN&#39;</span><span class="p">,</span><span class="s1">&#39;TPV&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Need this to look like</span>
        <span class="c1">#    [ [ x1, x2, x3... ], [ y1, y2, y3... ] ]</span>
        <span class="c1"># if input is either scalar x,y or two arrays.</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">y</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">tran</span><span class="p">(</span> <span class="n">xy</span> <span class="p">)</span>
        <span class="c1"># PyAst returns ra, dec in radians, so we&#39;re good.</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sanity checks that the inputs are the same shape.</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span>

    <span class="k">def</span> <span class="nf">_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ra</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">dec</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">tran</span><span class="p">(</span> <span class="n">rd</span><span class="p">,</span> <span class="kc">False</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sanity checks that the inputs are the same shape.</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ra</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">dec</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">_newOrigin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_writeHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starlink.Atl</span>
        <span class="c1"># See https://github.com/Starlink/starlink/issues/24 for helpful information from</span>
        <span class="c1"># David Berry, who assisted me in getting this working.</span>

        <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="c1"># Again, we can get deprecation warnings here.  Safe to ignore.</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">starlink</span><span class="o">.</span><span class="n">Ast</span><span class="o">.</span><span class="n">FitsChan</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">starlink</span><span class="o">.</span><span class="n">Atl</span><span class="o">.</span><span class="n">PyFITSAdapter</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span> <span class="p">,</span> <span class="s2">&quot;Encoding=FITS-WCS&quot;</span><span class="p">)</span>
            <span class="c1"># Let Ast know how big the image is that we&#39;ll be writing.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">,</span> <span class="s1">&#39;NAXIS1&#39;</span><span class="p">,</span> <span class="s1">&#39;NAXIS2&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>  <span class="c1"># pragma: no branch</span>
                    <span class="n">fc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcsinfo</span><span class="p">)</span>
            <span class="c1"># PyAst doesn&#39;t write out TPV or ZPX correctly.  It writes them as TAN and ZPN</span>
            <span class="c1"># respectively.  However, if the maximum error is less than 0.1 pixel, it claims</span>
            <span class="c1"># success nonetheless.  This doesn&#39;t seem accurate enough for many purposes,</span>
            <span class="c1"># so we need to countermand that.</span>
            <span class="c1"># The easiest way I found to check for them is that the string TPN is in the string</span>
            <span class="c1"># version of wcsinfo.  So check for that and set success = False in that case.</span>
            <span class="k">if</span> <span class="s1">&#39;TPN&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcsinfo</span><span class="p">):</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Likewise for SIP.  MPF seems to be an appropriate string to look for.</span>
            <span class="k">if</span> <span class="s1">&#39;MPF&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcsinfo</span><span class="p">):</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="c1"># This should always work, since it uses starlinks own proprietary encoding, but</span>
                <span class="c1"># it won&#39;t necessarily be readable by ds9.</span>
                <span class="n">fc</span> <span class="o">=</span> <span class="n">starlink</span><span class="o">.</span><span class="n">Ast</span><span class="o">.</span><span class="n">FitsChan</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">starlink</span><span class="o">.</span><span class="n">Atl</span><span class="o">.</span><span class="n">PyFITSAdapter</span><span class="p">(</span><span class="n">hdu</span><span class="p">))</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcsinfo</span><span class="p">)</span>
            <span class="n">fc</span><span class="o">.</span><span class="n">writefits</span><span class="p">()</span>
        <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># And write the name as a special GalSim key</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_WCS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;PyAstWCS&quot;</span><span class="p">,</span> <span class="s2">&quot;GalSim WCS name&quot;</span><span class="p">)</span>
        <span class="c1"># And the image origin.</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_X0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;GalSim image origin x&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_Y0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;GalSim image origin y&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">header</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_readHeader</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GS_X0&quot;</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GS_Y0&quot;</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyAstWCS</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">_PositionD</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">PyAstWCS</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">PyAstWCS</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">PyAstWCS</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcsinfo</span><span class="p">)</span> <span class="o">==</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">wcsinfo</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;header=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Ast doesn&#39;t have a good repr for a FrameSet, so do it ourselves.</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;wcsinfo=&lt;starlink.Ast.FrameSet at </span><span class="si">%s</span><span class="s1">&gt;&#39;</span><span class="o">%</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcsinfo</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;galsim.PyAstWCS(</span><span class="si">%s</span><span class="s2">, origin=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;_wcsinfo&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wcsinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span></div>


<span class="c1"># I can&#39;t figure out how to get wcstools installed in the travis environment (cf. .travis.yml).</span>
<span class="c1"># So until that gets resolved, we omit this class from the coverage report.</span>
<span class="c1"># This class was mostly useful as a refernce implementation anyway. It&#39;s much too slow for most</span>
<span class="c1"># users to ever want to use it.</span>
<div class="viewcode-block" id="WcsToolsWCS"><a class="viewcode-back" href="../../wcs.html#galsim.WcsToolsWCS">[docs]</a><span class="k">class</span> <span class="nc">WcsToolsWCS</span><span class="p">(</span><span class="n">CelestialWCS</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This WCS uses wcstools executables to perform the appropriate WCS transformations</span>
<span class="sd">    for a given FITS file.  It requires wcstools command line functions to be installed.</span>

<span class="sd">    Note: It uses the wcstools executables xy2sky and sky2xy, so it can be quite a bit less</span>
<span class="sd">    efficient than other options that keep the WCS in memory.</span>

<span class="sd">    See their website for information on downloading and installing wcstools:</span>

<span class="sd">        http://tdc-www.harvard.edu/software/wcstools/</span>

<span class="sd">    A WcsToolsWCS is initialized with the following command::</span>

<span class="sd">        &gt;&gt;&gt; wcs = galsim.WcsToolsWCS(file_name)</span>

<span class="sd">    Parameters:</span>
<span class="sd">        file_name:        The FITS file from which to read the WCS information.</span>
<span class="sd">        dir:              Optional directory to prepend to ``file_name``. [default: None]</span>
<span class="sd">        origin:           Optional origin position for the image coordinate system.</span>
<span class="sd">                          If provided, it should be a PositionD or PositionI.</span>
<span class="sd">                          [default: None]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_req_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;file_name&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">}</span>
    <span class="n">_opt_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;dir&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span> <span class="p">:</span> <span class="n">PositionD</span> <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_origin</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">dir</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Cannot find file &#39;</span><span class="o">+</span><span class="n">file_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span> <span class="o">=</span> <span class="n">file_name</span>

        <span class="c1"># Check wcstools is installed and that it can read the file.</span>
        <span class="c1"># If xy2sky is not installed, this will raise an OSError</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;xy2sky&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="s1">&#39;cannot&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;wcstools (specifically xy2sky) was unable to read &#39;</span><span class="o">+</span><span class="n">file_name</span><span class="p">)</span>

        <span class="c1"># wcstools supports LINEAR WCS&#39;s, but we don&#39;t want to allow them, since then</span>
        <span class="c1"># the CelestialWCS base class is inappropriate.  The clue to detect this is that</span>
        <span class="c1"># the results only have 4 values, rather than use usual 5 (missing epoch).</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s2">&quot;The WCS read in does not define a pair of celestial axes&quot;</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The file name of the FITS file with the WCS information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The origin in image coordinates of the WCS function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_origin</span>

    <span class="k">def</span> <span class="nf">_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Need this to look like</span>
        <span class="c1">#    [ x1, y1, x2, y2, ... ]</span>
        <span class="c1"># if input is either scalar x,y or two arrays.</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># The OS cannot handle arbitrarily long command lines, so we may need to split up</span>
        <span class="c1"># the list into smaller chunks.</span>
        <span class="k">if</span> <span class="s1">&#39;SC_ARG_MAX&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf_names</span><span class="p">:</span>
            <span class="n">arg_max</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s1">&#39;SC_ARG_MAX&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># A conservative guess. My machines have 131072, 262144, and 2621440</span>
            <span class="n">arg_max</span> <span class="o">=</span> <span class="mi">32768</span>

        <span class="c1"># Sometimes SC_ARG_MAX is listed as -1.  Apparently that means &quot;the configuration name</span>
        <span class="c1"># is known, but the value is not defined.&quot; So, just go with the above conservative value.</span>
        <span class="k">if</span> <span class="n">arg_max</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">arg_max</span> <span class="o">=</span> <span class="mi">32768</span>

        <span class="c1"># Just in case something weird happened.  This should be _very_ conservative.</span>
        <span class="c1"># It&#39;s the smallest value in this list of values for a bunch of systems:</span>
        <span class="c1"># http://www.in-ulm.de/~mascheck/various/argmax/</span>
        <span class="k">if</span> <span class="n">arg_max</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">:</span>
            <span class="n">arg_max</span> <span class="o">=</span> <span class="mi">4096</span>

        <span class="c1"># This corresponds to the total number of characters in the line.</span>
        <span class="c1"># But we really need to know how many arguments we are allowed to use in each call.</span>
        <span class="c1"># Lets be conservative again and assume each argument is at most 20 characters.</span>
        <span class="c1"># (We ignore the few characters at the start for the command name and such.)</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg_max</span> <span class="o">/</span> <span class="mi">40</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># Make sure it is even!</span>

        <span class="n">xy_strs</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">xy</span> <span class="p">]</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">xy_strs</span><span class="p">),</span><span class="n">nargs</span><span class="p">):</span>
            <span class="n">xy1</span> <span class="o">=</span> <span class="n">xy_strs</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">nargs</span><span class="p">]</span>
            <span class="c1"># We&#39;d like to get the output to 10 digits of accuracy.  This corresponds to</span>
            <span class="c1"># an accuracy of about 1.e-6 arcsec.  But sometimes xy2sky cannot handle it,</span>
            <span class="c1"># in which case the output will start with *************.  If this happens, just</span>
            <span class="c1"># decrease digits and try again.</span>
            <span class="k">for</span> <span class="n">digits</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1"># If xy2sky is not installed, this will raise an OSError</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;xy2sky&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">digits</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span><span class="p">]</span> <span class="o">+</span> <span class="n">xy1</span><span class="p">,</span>
                                    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;wcstools command xy2sky was unable to read &#39;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;wcstools command xy2sky was unable to read &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

            <span class="c1"># Each line of output should looke like:</span>
            <span class="c1">#    x y J2000 ra dec</span>
            <span class="c1"># But if there was an error, the J200 might be missing or the output might look like</span>
            <span class="c1">#    Off map x y</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s1">&#39;wcstools xy2sky returned invalid result near </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xy1</span><span class="p">))</span>
                <span class="n">ra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">dec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># wcstools reports ra, dec in degrees, so convert to radians</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">degrees</span> <span class="o">/</span> <span class="n">radians</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sanity checks that the inputs are the same shape.</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="n">factor</span>

    <span class="k">def</span> <span class="nf">_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">rd</span> <span class="o">*=</span> <span class="n">radians</span> <span class="o">/</span> <span class="n">degrees</span>

        <span class="c1"># The boilerplate here is exactly the same as in _radec.  See that function for an</span>
        <span class="c1"># explanation of how this works.</span>
        <span class="k">if</span> <span class="s1">&#39;SC_ARG_MAX&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf_names</span><span class="p">:</span>
            <span class="n">arg_max</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s1">&#39;SC_ARG_MAX&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arg_max</span> <span class="o">=</span> <span class="mi">32768</span>
        <span class="k">if</span> <span class="n">arg_max</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">arg_max</span> <span class="o">=</span> <span class="mi">32768</span>
        <span class="k">if</span> <span class="n">arg_max</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">:</span> <span class="n">arg_max</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg_max</span> <span class="o">/</span> <span class="mi">40</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="n">rd_strs</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">rd</span> <span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">rd_strs</span><span class="p">),</span><span class="n">nargs</span><span class="p">):</span>
            <span class="n">rd1</span> <span class="o">=</span> <span class="n">rd_strs</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">nargs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">digits</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;sky2xy&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">digits</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span><span class="p">]</span> <span class="o">+</span> <span class="n">rd1</span><span class="p">,</span>
                                    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;wcstools command sky2xy was unable to read &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;wcstools command sky2xy was unable to read &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span><span class="p">)</span>

            <span class="n">lines</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

            <span class="c1"># Each line of output should looke like:</span>
            <span class="c1">#    ra dec J2000 -&gt; x y</span>
            <span class="c1"># However, if there was an error, the J200 might be missing.</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s1">&#39;wcstools sky2xy returned invalid result for </span><span class="si">%f</span><span class="s1">,</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">galsim_warn</span><span class="p">(</span><span class="s2">&quot;wcstools sky2xy indicates that </span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2"> is off the image. &quot;</span>
                                <span class="s2">&quot;output is </span><span class="si">%r</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">,</span><span class="n">results</span><span class="p">))</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sanity checks that the inputs are the same shape.</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ra</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">dec</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_newOrigin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_writeHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
        <span class="c1"># These are all we need to load it back.  Just use the original file.</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_WCS&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;WcsToolsWCS&quot;</span><span class="p">,</span> <span class="s2">&quot;GalSim WCS name&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_FILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span><span class="p">,</span> <span class="s2">&quot;GalSim original file with WCS data&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_X0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;GalSim image origin x&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_Y0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;GalSim image origin y&quot;</span><span class="p">)</span>

        <span class="c1"># We also copy over some of the fields we need.  wcstools doesn&#39;t seem to have something</span>
        <span class="c1"># that lists _all_ the keys that define the WCS.  This just gets the approximate WCS.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;wcshead&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CROTA2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">header</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_readHeader</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_FILE&quot;</span><span class="p">]</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_X0&quot;</span><span class="p">]</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_Y0&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">WcsToolsWCS</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">_PositionD</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The copy module version of copying the dict works fine here.</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">WcsToolsWCS</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;galsim.WcsToolsWCS(</span><span class="si">%r</span><span class="s2">, origin=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>


<div class="viewcode-block" id="GSFitsWCS"><a class="viewcode-back" href="../../wcs.html#galsim.GSFitsWCS">[docs]</a><span class="k">class</span> <span class="nc">GSFitsWCS</span><span class="p">(</span><span class="n">CelestialWCS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This WCS uses a GalSim implementation to read a WCS from a FITS file.</span>

<span class="sd">    It doesn&#39;t do nearly as many WCS types as the other options, and it does not try to be</span>
<span class="sd">    as rigorous about supporting all possible valid variations in the FITS parameters.</span>
<span class="sd">    However, it does several popular WCS types properly, and it doesn&#39;t require any additional</span>
<span class="sd">    python modules to be installed, which can be helpful.</span>

<span class="sd">    Currrently, it is able to parse the following WCS types: TAN, STG, ZEA, ARC, TPV, TNX</span>

<span class="sd">    A GSFitsWCS is initialized with one of the following commands::</span>

<span class="sd">        &gt;&gt;&gt; wcs = galsim.GSFitsWCS(file_name=file_name)  # Open a file on disk</span>
<span class="sd">        &gt;&gt;&gt; wcs = galsim.GSFitsWCS(header=header)        # Use an existing pyfits header</span>

<span class="sd">    Also, since the most common usage will probably be the first, you can also give a file name</span>
<span class="sd">    without it being named::</span>

<span class="sd">        &gt;&gt;&gt; wcs = galsim.GSFitsWCS(file_name)</span>

<span class="sd">    In addition to reading from a FITS file, there is also a factory function that builds</span>
<span class="sd">    a GSFitsWCS object implementing a TAN projection.  See the docstring of `TanWCS` for</span>
<span class="sd">    more details.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        file_name:        The FITS file from which to read the WCS information.  This is probably</span>
<span class="sd">                          the usual parameter to provide.  [default: None]</span>
<span class="sd">        dir:              Optional directory to prepend to ``file_name``. [default: None]</span>
<span class="sd">        hdu:              Optionally, the number of the HDU to use if reading from a file.</span>
<span class="sd">                          The default is to use either the primary or first extension as</span>
<span class="sd">                          appropriate for the given compression.  (e.g. for rice, the first</span>
<span class="sd">                          extension is the one you normally want.) [default: None]</span>
<span class="sd">        header:           The header of an open pyfits (or astropy.io) hdu.  Or, it can be</span>
<span class="sd">                          a FitsHeader object.  [default: None]</span>
<span class="sd">        compression:      Which decompression scheme to use (if any). See galsim.fits.read()</span>
<span class="sd">                          for the available options.  [default: &#39;auto&#39;]</span>
<span class="sd">        origin:           Optional origin position for the image coordinate system.</span>
<span class="sd">                          If provided, it should be a PositionD or PositionI.</span>
<span class="sd">                          [default: None]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_req_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;file_name&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">}</span>
    <span class="n">_opt_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;dir&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;hdu&quot;</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span> <span class="p">:</span> <span class="n">PositionD</span><span class="p">,</span>
                    <span class="s2">&quot;compression&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                 <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_doiter</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Note: _data is not intended for end-user use.  It enables the equivalent of a</span>
        <span class="c1">#       private constructor of GSFitsWCS by the function TanWCS.  The details of its</span>
        <span class="c1">#       use are intentionally not documented above.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Write something useful here (see below). This is just used for the str.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_doiter</span> <span class="o">=</span> <span class="n">_doiter</span>

        <span class="c1"># If _data is given, copy the data and we&#39;re done.</span>
        <span class="k">if</span> <span class="n">_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crpix</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cd</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ab</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abp</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;TAN&#39;</span><span class="p">,</span> <span class="s1">&#39;TPV&#39;</span><span class="p">,</span> <span class="s1">&#39;TNX&#39;</span><span class="p">,</span> <span class="s1">&#39;TAN-SIP&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;gnomonic&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;STG&#39;</span><span class="p">,</span> <span class="s1">&#39;STG-SIP&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;stereographic&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ZEA&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEA-SIP&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;lambert&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ARC&#39;</span><span class="p">,</span> <span class="s1">&#39;ARC-SIP&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;postel&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid wcs_type in _data&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Read the file if given.</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">file_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">+=</span> <span class="s1">&#39;, hdu=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">hdu</span>
            <span class="k">if</span> <span class="n">compression</span> <span class="o">!=</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">+=</span> <span class="s1">&#39;, compression=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">compression</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot provide both file_name and pyfits header&quot;</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
            <span class="n">hdu</span><span class="p">,</span> <span class="n">hdu_list</span><span class="p">,</span> <span class="n">fin</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">readFile</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">hdu</span><span class="p">,</span> <span class="n">compression</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>

            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Must provide either file_name or header&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>

            <span class="c1"># Read the wcs information from the header.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fits</span><span class="o">.</span><span class="n">closeHDUList</span><span class="p">(</span><span class="n">hdu_list</span><span class="p">,</span> <span class="n">fin</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crpix</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">origin</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">origin</span><span class="o">.</span><span class="n">y</span> <span class="p">]</span>

    <span class="c1"># The origin is a required attribute/property, since it is used by some functions like</span>
    <span class="c1"># shiftOrigin to get the current origin value.  We don&#39;t use it in this class, though, so</span>
    <span class="c1"># just make origin a dummy property that returns 0,0.</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The origin in image coordinates of the WCS function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_PositionD</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="c1"># Start by reading the basic WCS stuff that most types have.</span>
        <span class="n">ctype1</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ctype2</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctype1</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DEC--&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ctype2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;RA---&#39;</span><span class="p">):</span>
            <span class="n">flip</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">ctype1</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;RA---&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ctype2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DEC--&#39;</span><span class="p">):</span>
            <span class="n">flip</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span>
                <span class="s2">&quot;GSFitsWCS only supports celestial coordinate systems.&quot;</span>
                <span class="s2">&quot;Expecting CTYPE1,2 to start with RA--- and DEC--.  Got </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ctype1</span><span class="p">,</span> <span class="n">ctype2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ctype1</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">ctype2</span><span class="p">[</span><span class="mi">5</span><span class="p">:]:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;ctype1, ctype2 do not seem to agree on the WCS type&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="o">=</span> <span class="n">ctype1</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;TAN&#39;</span><span class="p">,</span> <span class="s1">&#39;TPV&#39;</span><span class="p">,</span> <span class="s1">&#39;TNX&#39;</span><span class="p">,</span> <span class="s1">&#39;TAN-SIP&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;gnomonic&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;STG&#39;</span><span class="p">,</span> <span class="s1">&#39;STG-SIP&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;stereographic&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ZEA&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEA-SIP&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;lambert&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ARC&#39;</span><span class="p">,</span> <span class="s1">&#39;ARC-SIP&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;postel&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimValueError</span><span class="p">(</span><span class="s2">&quot;GSFitsWCS cannot read files using given wcs_type.&quot;</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span><span class="p">,</span>
                                   <span class="p">(</span><span class="s1">&#39;TAN&#39;</span><span class="p">,</span> <span class="s1">&#39;TPV&#39;</span><span class="p">,</span> <span class="s1">&#39;TNX&#39;</span><span class="p">,</span> <span class="s1">&#39;TAN-SIP&#39;</span><span class="p">,</span> <span class="s1">&#39;STG&#39;</span><span class="p">,</span> <span class="s1">&#39;STG-SIP&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEA&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;ZEA-SIP&#39;</span><span class="p">,</span> <span class="s1">&#39;ARC&#39;</span><span class="p">,</span> <span class="s1">&#39;ARC-SIP&#39;</span><span class="p">))</span>
        <span class="n">crval1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">])</span>
        <span class="n">crval2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">])</span>
        <span class="n">crpix1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">])</span>
        <span class="n">crpix2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;CD1_1&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">cd11</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CD1_1&#39;</span><span class="p">])</span>
            <span class="n">cd12</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CD1_2&#39;</span><span class="p">])</span>
            <span class="n">cd21</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CD2_1&#39;</span><span class="p">])</span>
            <span class="n">cd22</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CD2_2&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;CDELT1&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;PC1_1&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">cd11</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PC1_1&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span>
                <span class="n">cd12</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PC1_2&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span>
                <span class="n">cd21</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PC2_1&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">])</span>
                <span class="n">cd22</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PC2_2&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cd11</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span>
                <span class="n">cd12</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">cd21</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">cd22</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover  (all our test files have either CD or CDELT)</span>
            <span class="n">cd11</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">cd12</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">cd21</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">cd22</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="c1"># Usually the units are degrees, but make sure</span>
        <span class="k">if</span> <span class="s1">&#39;CUNIT1&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">cunit1</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">]</span>
            <span class="n">cunit2</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CUNIT2&#39;</span><span class="p">]</span>
            <span class="n">ra_units</span> <span class="o">=</span> <span class="n">AngleUnit</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">cunit1</span><span class="p">)</span>
            <span class="n">dec_units</span> <span class="o">=</span> <span class="n">AngleUnit</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">cunit2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ra_units</span> <span class="o">=</span> <span class="n">degrees</span>
            <span class="n">dec_units</span> <span class="o">=</span> <span class="n">degrees</span>

        <span class="k">if</span> <span class="n">flip</span><span class="p">:</span>
            <span class="n">crval1</span><span class="p">,</span> <span class="n">crval2</span> <span class="o">=</span> <span class="n">crval2</span><span class="p">,</span> <span class="n">crval1</span>
            <span class="n">ra_units</span><span class="p">,</span> <span class="n">dec_units</span> <span class="o">=</span> <span class="n">dec_units</span><span class="p">,</span> <span class="n">ra_units</span>
            <span class="n">cd11</span><span class="p">,</span> <span class="n">cd21</span> <span class="o">=</span> <span class="n">cd21</span><span class="p">,</span> <span class="n">cd11</span>
            <span class="n">cd12</span><span class="p">,</span> <span class="n">cd22</span> <span class="o">=</span> <span class="n">cd22</span><span class="p">,</span> <span class="n">cd12</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">crpix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="n">crpix1</span><span class="p">,</span> <span class="n">crpix2</span> <span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="p">[</span> <span class="n">cd11</span><span class="p">,</span> <span class="n">cd12</span> <span class="p">],</span>
                              <span class="p">[</span> <span class="n">cd21</span><span class="p">,</span> <span class="n">cd22</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">CelestialCoord</span><span class="p">(</span><span class="n">crval1</span> <span class="o">*</span> <span class="n">ra_units</span><span class="p">,</span> <span class="n">crval2</span> <span class="o">*</span> <span class="n">dec_units</span><span class="p">)</span>

        <span class="c1"># There was an older proposed standard that used TAN with PV values, which is used by</span>
        <span class="c1"># SCamp, so we want to support it if possible.  The standard is now called TPV, so</span>
        <span class="c1"># use that for our wcs_type if we see the PV values with TAN.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="o">==</span> <span class="s1">&#39;TAN&#39;</span> <span class="ow">and</span> <span class="s1">&#39;PV1_1&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="o">=</span> <span class="s1">&#39;TPV&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ab</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="o">==</span> <span class="s1">&#39;TPV&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_tpv</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="o">==</span> <span class="s1">&#39;TNX&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_tnx</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;TAN-SIP&#39;</span><span class="p">,</span> <span class="s1">&#39;STG-SIP&#39;</span><span class="p">,</span> <span class="s1">&#39;ZEA-SIP&#39;</span><span class="p">,</span> <span class="s1">&#39;ARC-SIP&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_sip</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># I think the CUNIT specification applies to the CD matrix as well, but I couldn&#39;t actually</span>
        <span class="c1"># find good documentation for this.  Plus all the examples I saw used degrees anyway, so</span>
        <span class="c1"># it&#39;s hard to tell.  Hopefully this will never matter, but if CUNIT is not deg, this</span>
        <span class="c1"># next bit might be wrong.</span>
        <span class="c1"># I did see documentation that the PV matrices always use degrees, so at least we shouldn&#39;t</span>
        <span class="c1"># have to worry about that.</span>
        <span class="k">if</span> <span class="n">ra_units</span> <span class="o">!=</span> <span class="n">degrees</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">ra_units</span> <span class="o">/</span> <span class="n">degrees</span>
        <span class="k">if</span> <span class="n">dec_units</span> <span class="o">!=</span> <span class="n">degrees</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">dec_units</span> <span class="o">/</span> <span class="n">degrees</span>

    <span class="k">def</span> <span class="nf">_read_tpv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="c1"># See http://fits.gsfc.nasa.gov/registry/tpvwcs/tpv.html for details about how</span>
        <span class="c1"># the TPV standard is defined.</span>

        <span class="c1"># The standard includes an option to have odd powers of r, which kind of screws</span>
        <span class="c1"># up the numbering of these coefficients.  We don&#39;t implement these terms, so</span>
        <span class="c1"># before going further, check to make sure none are present.</span>
        <span class="n">odd_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">39</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PV</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">odd_indices</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">GalSimNotImplementedError</span><span class="p">(</span><span class="s2">&quot;TPV not implemented for odd powers of r&quot;</span><span class="p">)</span>

        <span class="n">pv1</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PV1_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">k</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">odd_indices</span> <span class="p">]</span>
        <span class="n">pv2</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PV2_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">k</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">odd_indices</span> <span class="p">]</span>

        <span class="n">maxk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">pv1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">pv2</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># maxk = (order+1) * (order+2) / 2 - 1</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">maxk</span><span class="o">+</span><span class="mi">1</span><span class="p">))))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Another strange thing is that the two matrices are defined in the opposite order</span>
        <span class="c1"># with respect to their element ordering.  But at least now, without the odd terms,</span>
        <span class="c1"># we can just proceed in order in the k indices.  So what we call k=3..9 here were</span>
        <span class="c1"># originally PVi_4..10.</span>
        <span class="c1"># For reference, here is what it would look like for order = 3:</span>
        <span class="c1"># self.pv = np.array( [ [ [ pv1[0], pv1[2], pv1[5], pv1[9] ],</span>
        <span class="c1">#                         [ pv1[1], pv1[4], pv1[8],   0.   ],</span>
        <span class="c1">#                         [ pv1[3], pv1[7],   0.  ,   0.   ],</span>
        <span class="c1">#                         [ pv1[6],   0.  ,   0.  ,   0.   ] ],</span>
        <span class="c1">#                       [ [ pv2[0], pv2[1], pv2[3], pv2[6] ],</span>
        <span class="c1">#                         [ pv2[2], pv2[4], pv2[7],   0.   ],</span>
        <span class="c1">#                         [ pv2[5], pv2[8],   0.  ,   0.   ],</span>
        <span class="c1">#                         [ pv2[9],   0.  ,   0.  ,   0.   ] ] ] )</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">N</span><span class="o">-</span><span class="n">j</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_read_sip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="n">a_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;A_ORDER&#39;</span><span class="p">])</span>
        <span class="n">b_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;B_ORDER&#39;</span><span class="p">])</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a_order</span><span class="p">,</span><span class="n">b_order</span><span class="p">)</span>  <span class="c1"># Use the same order for both</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;A_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="mf">0.</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;B_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="mf">0.</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Standard A,B are a differential calculation.  It&#39;s more convenient to</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># keep this as an absolute calculation like PV does.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>

        <span class="c1"># The reverse transformation is not required to be there.</span>
        <span class="k">if</span> <span class="s1">&#39;AP_ORDER&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">ap_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;AP_ORDER&#39;</span><span class="p">])</span>
            <span class="n">bp_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BP_ORDER&#39;</span><span class="p">])</span>
            <span class="n">order</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ap_order</span><span class="p">,</span><span class="n">bp_order</span><span class="p">)</span>  <span class="c1"># Use the same order for both</span>
            <span class="n">ap</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AP_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="mf">0.</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span>
            <span class="n">ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BP_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="mf">0.</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">ap</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">bp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ap</span><span class="p">,</span> <span class="n">bp</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_read_tnx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>

        <span class="c1"># TNX has a few different options.  Rather than keep things in the native format,</span>
        <span class="c1"># we actually convert to the equivalent of TPV to make the actual operations faster.</span>
        <span class="c1"># See http://iraf.noao.edu/projects/ccdmosaic/tnx.html for details.</span>

        <span class="c1"># First, parse the input values, which are stored in WAT keywords:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">wat1</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;WAT1_</span><span class="si">%03d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">k</span>
        <span class="k">while</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">wat1</span> <span class="o">+=</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;WAT1_</span><span class="si">%03d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">k</span>
        <span class="n">wat1</span> <span class="o">=</span> <span class="n">wat1</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">wat2</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;WAT2_</span><span class="si">%03d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">k</span>
        <span class="k">while</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">wat2</span> <span class="o">+=</span> <span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;WAT2_</span><span class="si">%03d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">k</span>
        <span class="n">wat2</span> <span class="o">=</span> <span class="n">wat2</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">wat1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="ow">or</span>
             <span class="n">wat1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;wtype=tnx&#39;</span> <span class="ow">or</span>
             <span class="n">wat1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;axtype=ra&#39;</span> <span class="ow">or</span>
             <span class="n">wat1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;lngcor&#39;</span> <span class="ow">or</span>
             <span class="n">wat1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;=&#39;</span> <span class="ow">or</span>
             <span class="ow">not</span> <span class="n">wat1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">or</span>
             <span class="ow">not</span> <span class="n">wat1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s2">&quot;TNX WAT1 was not as expected&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">wat2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="ow">or</span>
             <span class="n">wat2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;wtype=tnx&#39;</span> <span class="ow">or</span>
             <span class="n">wat2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;axtype=dec&#39;</span> <span class="ow">or</span>
             <span class="n">wat2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;latcor&#39;</span> <span class="ow">or</span>
             <span class="n">wat2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;=&#39;</span> <span class="ow">or</span>
             <span class="ow">not</span> <span class="n">wat2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">or</span>
             <span class="ow">not</span> <span class="n">wat2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s2">&quot;TNX WAT2 was not as expected&quot;</span><span class="p">)</span>

        <span class="c1"># Break the next bit out into another function, since it is the same for x and y.</span>
        <span class="n">pv1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_tnx_data</span><span class="p">(</span><span class="n">wat1</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
        <span class="n">pv2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_tnx_data</span><span class="p">(</span><span class="n">wat2</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>

        <span class="c1"># Those just give the adjustments to the position, not the matrix that gives the final</span>
        <span class="c1"># position.  i.e. the TNX standard uses u = u + [1 u u^2 u^3] PV [1 v v^2 v^3]T.</span>
        <span class="c1"># So we need to add 1 to the correct term in each matrix to get what we really want.</span>
        <span class="n">pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>
        <span class="n">pv2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>

        <span class="c1"># Finally, store these as our pv 3-d array.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pv1</span><span class="p">,</span> <span class="n">pv2</span><span class="p">])</span>

        <span class="c1"># We&#39;ve now converted this to TPV, so call it that when we output to a fits header.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="o">=</span> <span class="s1">&#39;TPV&#39;</span>

    <span class="k">def</span> <span class="nf">_parse_tnx_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

        <span class="c1"># I&#39;m not sure if there is any requirement on there being a space before the final &quot; and</span>
        <span class="c1"># not before the initial &quot;.  But both the example in the description of the standard and</span>
        <span class="c1"># the one we have in our test directory are this way.  Here, if the &quot; is by itself, I</span>
        <span class="c1"># remove the item, and if it is part of a longer string, I just strip it off.  Seems the</span>
        <span class="c1"># most sensible thing to do.</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>  <span class="c1"># Weirdly, these integers are given with decimal points.</span>
        <span class="n">xorder</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
        <span class="n">yorder</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
        <span class="n">cross</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cross</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">GalSimNotImplementedError</span><span class="p">(</span><span class="s2">&quot;TNX only implemented for half-cross option.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xorder</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">yorder</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">GalSimNotImplementedError</span><span class="p">(</span><span class="s2">&quot;TNX only implemented for order = 4&quot;</span><span class="p">)</span>
        <span class="c1"># Note: order = 4 really means cubic.  order is how large the pv matrix is, i.e. 4x4.</span>

        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>

        <span class="n">pv1</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span> <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pv1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s2">&quot;Wrong number of items found in WAT data&quot;</span><span class="p">)</span>

        <span class="c1"># Put these into our matrix formulation.</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="p">[</span> <span class="n">pv1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pv1</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">pv1</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">pv1</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="p">],</span>
                         <span class="p">[</span> <span class="n">pv1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pv1</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">pv1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>   <span class="mf">0.</span>   <span class="p">],</span>
                         <span class="p">[</span> <span class="n">pv1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pv1</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>   <span class="mf">0.</span>  <span class="p">,</span>   <span class="mf">0.</span>   <span class="p">],</span>
                         <span class="p">[</span> <span class="n">pv1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>   <span class="mf">0.</span>  <span class="p">,</span>   <span class="mf">0.</span>  <span class="p">,</span>   <span class="mf">0.</span>   <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>

        <span class="c1"># Convert from Legendre or Chebyshev polynomials into regular polynomials.</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># pragma: no branch (The only test file I can find has code = 1)</span>
            <span class="c1"># Instead of 1, x, x^2, x^3, Chebyshev uses: 1, x&#39;, 2x&#39;^2 - 1, 4x&#39;^3 - 3x</span>
            <span class="c1"># where x&#39; = (2x - xmin - xmax) / (xmax-xmin).</span>
            <span class="c1"># Similarly, with y&#39; = (2y - ymin - ymin) / (ymax-ymin)</span>
            <span class="c1"># We&#39;d like to convert the pv matrix from being in terms of x&#39; and y&#39; to being</span>
            <span class="c1"># in terms of just x, y.  To see how this works, look at what pv[1,1] means:</span>
            <span class="c1">#</span>
            <span class="c1"># First, let&#39;s say we can write x as (a + bx), and we can write y&#39; as (c + dy).</span>
            <span class="c1"># Then the term for pv[1,1] is:</span>
            <span class="c1">#</span>
            <span class="c1"># term = x&#39; * pv[1,1] * y&#39;</span>
            <span class="c1">#      = (a + bx) * pv[1,1] * (d + ey)</span>
            <span class="c1">#      =       a * pv[1,1] * c  +      a * pv[1,1] * d * y</span>
            <span class="c1">#        + x * b * pv[1,1] * c  +  x * b * pv[1,1] * d * y</span>
            <span class="c1">#</span>
            <span class="c1"># So the single term initially will contribute to 4 different terms in the final</span>
            <span class="c1"># matrix.  And the contributions will just be pv[1,1] times the outer product</span>
            <span class="c1"># [a b]T [d e].  So if we can determine the matrix that converts from</span>
            <span class="c1"># [1, x, x^2, x^3] to the Chebyshev vector, the the matrix we want is simply</span>
            <span class="c1"># xmT pv ym.</span>
            <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xmax</span><span class="o">+</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ymax</span><span class="o">+</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span>
            <span class="n">xm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">ym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">xm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">xm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
            <span class="n">xm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">ym</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">ym</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
            <span class="n">ym</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                    <span class="c1"># The recursion rule is Pm = 2 x&#39; Pm-1 - Pm-2</span>
                    <span class="c1"># Pm = 2 a Pm-1 - Pm-2 + x * 2 b Pm-1</span>
                    <span class="n">xm</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">xm</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xm</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">xm</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">xm</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">ym</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">ym</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ym</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">ym</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ym</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="c1"># code == 2 means Legendre.  The same argument applies, but we have a</span>
                <span class="c1"># different recursion rule.</span>
                <span class="c1"># WARNING: This branch has not been tested!  I don&#39;t have any TNX files</span>
                <span class="c1"># with Legendre functions to test it on.  I think it&#39;s right, but beware!</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                    <span class="c1"># The recursion rule is Pm = ((2m-1) x&#39; Pm-1 - (m-1) Pm-2) / m</span>
                    <span class="c1"># Pm = ((2m-1) a Pm-1 - (m-1) Pm-2) / m</span>
                    <span class="c1">#      + x * ((2m-1) b Pm-1) / m</span>
                    <span class="n">xm</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mf">2.</span><span class="o">*</span><span class="n">m</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">xm</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">xm</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">m</span>
                    <span class="n">xm</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="p">((</span><span class="mf">2.</span><span class="o">*</span><span class="n">m</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">xm</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">m</span>
                    <span class="n">ym</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mf">2.</span><span class="o">*</span><span class="n">m</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">ym</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">ym</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">m</span>
                    <span class="n">ym</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="p">((</span><span class="mf">2.</span><span class="o">*</span><span class="n">m</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">ym</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">m</span>

            <span class="n">pv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xm</span><span class="o">.</span><span class="n">T</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">ym</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">pv2</span>

    <span class="k">def</span> <span class="nf">_apply_ab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ab</span><span class="p">):</span>
        <span class="c1"># Note: this is used for both pv and ab, since the action is the same.</span>
        <span class="c1"># They just occur at two different places in the calculation.</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">horner2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ab</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">triangle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">horner2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ab</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">triangle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span>

    <span class="k">def</span> <span class="nf">_apply_cd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># Do this in C++ layer for speed.</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_cd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_galsim</span><span class="o">.</span><span class="n">ApplyCD</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_cd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">_uv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># Most of the work for _radec.  But stop at (u,v).</span>

        <span class="c1"># Start with (u,v) = the image position</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ab</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ab</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="p">)</span>

        <span class="c1"># This converts to (u,v) in the tangent plane</span>
        <span class="c1"># Expanding this out is a bit faster than using np.dot for 2x2 matrix.</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_cd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ab</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">)</span>

        <span class="c1"># Convert (u,v) from degrees to radians</span>
        <span class="c1"># Also, the FITS standard defines u,v backwards relative to our standard.</span>
        <span class="c1"># They have +u increasing to the east, not west.  Hence the - for u.</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">degrees</span> <span class="o">/</span> <span class="n">radians</span>
        <span class="n">u</span> <span class="o">*=</span> <span class="o">-</span><span class="n">factor</span>
        <span class="n">v</span> <span class="o">*=</span> <span class="n">factor</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Get the position in the tangent plane</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="c1"># Then convert from (u,v) to (ra, dec) using the appropriate projection.</span>
        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">deproject_rad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sanity checks that the inputs are the same shape.</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span>

    <span class="k">def</span> <span class="nf">_invert_ab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">abp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># This is used both for inverting (u,v) = PV (u&#39;,v&#39;)</span>
        <span class="c1"># and for inverting (x,y) = AB (x&#39;,y&#39;)</span>
        <span class="c1"># Here (and in C++) the notation is (u,v) = AB(x,y), even though both (u,v) and (x,y)</span>
        <span class="c1"># in this context are either in CCD coordinates (normally called x,y) or tangent plane</span>
        <span class="c1"># coordinates (normally called u,v).</span>
        <span class="c1"># abp is an optional set of coefficients to make a good guess for x,y</span>

        <span class="n">uu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>  <span class="c1"># Don&#39;t overwrite the given u,v, since we need it at the end</span>
        <span class="n">vv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>  <span class="c1"># to check it we were provided scalars or arrays.</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>    <span class="c1"># Start with x,y = u,v.</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>    <span class="c1"># This may be updated below if abp is provided.</span>

        <span class="n">nab</span> <span class="o">=</span> <span class="n">ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nabp</span> <span class="o">=</span> <span class="n">abp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">abp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">_uu</span> <span class="o">=</span> <span class="n">uu</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_vv</span> <span class="o">=</span> <span class="n">vv</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_ab</span> <span class="o">=</span> <span class="n">ab</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_abp</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">abp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">abp</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">convert_cpp_errors</span><span class="p">():</span>
            <span class="n">_galsim</span><span class="o">.</span><span class="n">InvertAB</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nab</span><span class="p">,</span> <span class="n">_uu</span><span class="p">,</span> <span class="n">_vv</span><span class="p">,</span> <span class="n">_ab</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_doiter</span><span class="p">,</span> <span class="n">nabp</span><span class="p">,</span> <span class="n">_abp</span><span class="p">)</span>

        <span class="c1"># Return the right type for u,v</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>


    <span class="k">def</span> <span class="nf">_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">project_rad</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">)</span>

        <span class="c1"># Again, FITS has +u increasing to the east, not west.  Hence the - for u.</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">radians</span> <span class="o">/</span> <span class="n">degrees</span>
        <span class="n">u</span> <span class="o">*=</span> <span class="o">-</span><span class="n">factor</span>
        <span class="n">v</span> <span class="o">*=</span> <span class="n">factor</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invert_ab</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cdinv&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cdinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">)</span>
        <span class="c1"># This is a bit faster than using np.dot for 2x2 matrix.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdinv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdinv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdinv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdinv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ab</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invert_ab</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="p">,</span> <span class="n">abp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">abp</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

    <span class="c1"># Override the version in CelestialWCS, since we can do this more efficiently.</span>
    <span class="k">def</span> <span class="nf">_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">image_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;origin must be a PositionD or PositionI argument&quot;</span><span class="p">)</span>

        <span class="c1"># The key lemma here is that chain rule for jacobians is just matrix multiplication.</span>
        <span class="c1"># i.e. if s = s(u,v), t = t(u,v) and u = u(x,y), v = v(x,y), then</span>
        <span class="c1"># ( dsdx  dsdy ) = ( dsdu dudx + dsdv dvdx   dsdu dudy + dsdv dvdy )</span>
        <span class="c1"># ( dtdx  dtdy ) = ( dtdu dudx + dtdv dvdx   dtdu dudy + dtdv dvdy )</span>
        <span class="c1">#                = ( dsdu  dsdv )  ( dudx  dudy )</span>
        <span class="c1">#                  ( dtdu  dtdv )  ( dvdx  dvdy )</span>
        <span class="c1">#</span>
        <span class="c1"># So if we can find the jacobian for each step of the process, we just multiply the</span>
        <span class="c1"># jacobians.</span>
        <span class="c1">#</span>
        <span class="c1"># We also need to keep track of the position along the way, so we have to repeat many</span>
        <span class="c1"># of the steps in _radec.</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">image_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">image_pos</span><span class="o">.</span><span class="n">y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Start with unit jacobian</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># No effect on the jacobian from this step.</span>
        <span class="n">p1</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crpix</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ab</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">xpow</span> <span class="o">=</span> <span class="n">x</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ypow</span> <span class="o">=</span> <span class="n">y</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="p">,</span> <span class="n">ypow</span><span class="p">),</span> <span class="n">xpow</span><span class="p">)</span>

            <span class="n">dxpow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dypow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dxpow</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">order</span><span class="p">)</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">xpow</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dypow</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">order</span><span class="p">)</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">ypow</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">j1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="p">,</span> <span class="n">ypow</span><span class="p">),</span> <span class="n">dxpow</span><span class="p">)</span> <span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="p">,</span> <span class="n">dypow</span><span class="p">),</span> <span class="n">xpow</span><span class="p">)</span> <span class="p">])</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span><span class="n">jac</span><span class="p">)</span>

        <span class="c1"># The jacobian here is just the cd matrix.</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">,</span> <span class="n">jac</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Now we apply the distortion terms</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>

            <span class="n">upow</span> <span class="o">=</span> <span class="n">u</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">vpow</span> <span class="o">=</span> <span class="n">v</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">,</span> <span class="n">vpow</span><span class="p">),</span> <span class="n">upow</span><span class="p">)</span>

            <span class="c1"># The columns of the jacobian for this step are the same function with dupow</span>
            <span class="c1"># or dvpow.</span>
            <span class="n">dupow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dvpow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dupow</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">order</span><span class="p">)</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">upow</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dvpow</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">order</span><span class="p">)</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">vpow</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">j1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">,</span> <span class="n">vpow</span><span class="p">),</span> <span class="n">dupow</span><span class="p">)</span> <span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">,</span> <span class="n">dvpow</span><span class="p">),</span> <span class="n">upow</span><span class="p">)</span> <span class="p">])</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span><span class="n">jac</span><span class="p">)</span>

        <span class="n">unit_convert</span> <span class="o">=</span> <span class="p">[</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">degrees</span> <span class="o">/</span> <span class="n">radians</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">degrees</span> <span class="o">/</span> <span class="n">radians</span> <span class="p">]</span>
        <span class="n">p2</span> <span class="o">*=</span> <span class="n">unit_convert</span>
        <span class="c1"># Subtle point: Don&#39;t use jac *= ..., because jac might currently be self.cd, and</span>
        <span class="c1">#               that would change self.cd!</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">jac</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="p">[</span> <span class="n">unit_convert</span> <span class="p">]</span> <span class="p">)</span>

        <span class="c1"># Finally convert from (u,v) to (ra, dec).  We have a special function that computes</span>
        <span class="c1"># the jacobian of this step in the CelestialCoord class.</span>
        <span class="n">j2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">jac_deproject_rad</span><span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">)</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">j2</span><span class="p">,</span><span class="n">jac</span><span class="p">)</span>

        <span class="c1"># This now has units of radians/pixel.  We want instead arcsec/pixel.</span>
        <span class="n">jac</span> <span class="o">*=</span> <span class="n">radians</span> <span class="o">/</span> <span class="n">arcsec</span>

        <span class="k">return</span> <span class="n">JacobianWCS</span><span class="p">(</span><span class="n">jac</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">jac</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">jac</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">jac</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">_newOrigin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">crpix</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">crpix</span> <span class="o">+</span> <span class="p">[</span> <span class="n">origin</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">origin</span><span class="o">.</span><span class="n">y</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_writeHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GS_WCS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;GSFitsWCS&quot;</span><span class="p">,</span> <span class="s2">&quot;GalSim WCS name&quot;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RA---&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DEC--&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CD1_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CD1_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CD2_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CD2_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CUNIT1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;deg&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CUNIT2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;deg&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">ra</span> <span class="o">/</span> <span class="n">degrees</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">dec</span> <span class="o">/</span> <span class="n">degrees</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">odd_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">39</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="n">j</span>
                    <span class="n">header</span><span class="p">[</span><span class="s2">&quot;PV1_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">header</span><span class="p">[</span><span class="s2">&quot;PV2_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">odd_indices</span><span class="p">:</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ab</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;A_ORDER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">aij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">aij</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># Turn back into standard form.</span>
                    <span class="k">if</span> <span class="n">aij</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;A_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">aij</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;B_ORDER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">bij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">bij</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">bij</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;B_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bij</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;AP_ORDER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">apij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">apij</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">apij</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;AP_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">apij</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;BP_ORDER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">bpij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">bpij</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">bpij</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;BP_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bpij</span>
        <span class="k">return</span> <span class="n">header</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_readHeader</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GSFitsWCS</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The copy module version of copying the dict works fine here.</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">GSFitsWCS</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">wcs_type</span> <span class="ow">and</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crpix</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">crpix</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">cd</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">center</span> <span class="ow">and</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">pv</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">ab</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abp</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">abp</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pv_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pv_repr</span> <span class="o">=</span> <span class="s1">&#39;array(</span><span class="si">%r</span><span class="s1">)&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ab</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ab_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ab_repr</span> <span class="o">=</span> <span class="s1">&#39;array(</span><span class="si">%r</span><span class="s1">)&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">ab</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abp_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abp_repr</span> <span class="o">=</span> <span class="s1">&#39;array(</span><span class="si">%r</span><span class="s1">)&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">abp</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="s2">&quot;galsim.GSFitsWCS(_data = [</span><span class="si">%r</span><span class="s2">, array(</span><span class="si">%r</span><span class="s2">), array(</span><span class="si">%r</span><span class="s2">), </span><span class="si">%r</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">])&quot;</span><span class="o">%</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wcs_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crpix</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
                <span class="n">pv_repr</span><span class="p">,</span> <span class="n">ab_repr</span><span class="p">,</span> <span class="n">abp_repr</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;galsim.GSFitsWCS(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tag</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>


<div class="viewcode-block" id="TanWCS"><a class="viewcode-back" href="../../wcs.html#galsim.TanWCS">[docs]</a><span class="k">def</span> <span class="nf">TanWCS</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">world_origin</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">arcsec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is a function that returns a `GSFitsWCS` object for a TAN WCS projection.</span>

<span class="sd">    The TAN projection is essentially an affine transformation from image coordinates to</span>
<span class="sd">    Euclidean (u,v) coordinates on a tangent plane, and then a &quot;deprojection&quot; of this plane</span>
<span class="sd">    onto the sphere given a particular RA, Dec for the location of the tangent point.</span>
<span class="sd">    The tangent point will correspond to the location of (u,v) = (0,0) in the intermediate</span>
<span class="sd">    coordinate system.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        affine:          An `AffineTransform` defining the transformation from image coordinates</span>
<span class="sd">                         to the coordinates on the tangent plane.</span>
<span class="sd">        world_origin:    A `CelestialCoord` defining the location on the sphere where the</span>
<span class="sd">                         tangent plane is centered.</span>
<span class="sd">        units:           The angular units of the (u,v) intermediate coordinate system.</span>
<span class="sd">                         [default: galsim.arcsec]</span>

<span class="sd">    Returns:</span>
<span class="sd">        a `GSFitsWCS` describing this WCS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># These will raise the appropriate errors if affine is not the right type.</span>
    <span class="n">dudx</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">dudx</span> <span class="o">*</span> <span class="n">units</span> <span class="o">/</span> <span class="n">degrees</span>
    <span class="n">dudy</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">dudy</span> <span class="o">*</span> <span class="n">units</span> <span class="o">/</span> <span class="n">degrees</span>
    <span class="n">dvdx</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">dvdx</span> <span class="o">*</span> <span class="n">units</span> <span class="o">/</span> <span class="n">degrees</span>
    <span class="n">dvdy</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">dvdy</span> <span class="o">*</span> <span class="n">units</span> <span class="o">/</span> <span class="n">degrees</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">origin</span>
    <span class="c1"># The - signs are because the Fits standard is in terms of +u going east, rather than west</span>
    <span class="c1"># as we have defined.  So just switch the sign in the CD matrix.</span>
    <span class="n">cd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span> <span class="o">-</span><span class="n">dudx</span><span class="p">,</span> <span class="o">-</span><span class="n">dudy</span> <span class="p">],</span> <span class="p">[</span> <span class="n">dvdx</span><span class="p">,</span> <span class="n">dvdy</span> <span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">crpix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">origin</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">origin</span><span class="o">.</span><span class="n">y</span> <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># We also need to absorb the affine world_origin back into crpix, since GSFits is expecting</span>
    <span class="c1"># crpix to be the location of the tangent point in image coordinates. i.e. where (u,v) = (0,0)</span>
    <span class="c1"># (u,v) = CD * (x-x0,y-y0) + (u0,v0)</span>
    <span class="c1"># (0,0) = CD * (x0&#39;,y0&#39;) - CD * (x0,y0) + (u0,v0)</span>
    <span class="c1"># CD (x0&#39;,y0&#39;) = CD (x0,y0) - (u0,v0)</span>
    <span class="c1"># (x0&#39;,y0&#39;) = (x0,y0) - CD^-1 (u0,v0)</span>
    <span class="n">uv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="n">affine</span><span class="o">.</span><span class="n">world_origin</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">units</span> <span class="o">/</span> <span class="n">degrees</span><span class="p">,</span>
                     <span class="n">affine</span><span class="o">.</span><span class="n">world_origin</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">units</span> <span class="o">/</span> <span class="n">degrees</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">crpix</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cd</span><span class="p">)</span> <span class="p">,</span> <span class="n">uv</span><span class="p">)</span>

    <span class="c1"># Invoke the private constructor of GSFits using the _data kwarg.</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;TAN&#39;</span><span class="p">,</span> <span class="n">crpix</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">world_origin</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">GSFitsWCS</span><span class="p">(</span><span class="n">_data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>


<span class="c1"># This is a list of all the WCS types that can potentially read a WCS from a FITS file.</span>
<span class="c1"># The function FitsWCS will try each of these in order and return the first one that</span>
<span class="c1"># succeeds.  AffineTransform should be last, since it will always succeed.</span>
<span class="c1"># The list is defined here at global scope so that external modules can add extra</span>
<span class="c1"># WCS types to the list if desired.</span>

<span class="n">fits_wcs_types</span> <span class="o">=</span> <span class="p">[</span>

    <span class="n">GSFitsWCS</span><span class="p">,</span>      <span class="c1"># This doesn&#39;t work for very many WCS types, but it works for the very common</span>
                    <span class="c1"># TAN projection, and also TPV, which is used by SCamp.  If it does work, it</span>
                    <span class="c1"># is a good choice, since it is easily the fastest of any of these.</span>

    <span class="n">PyAstWCS</span><span class="p">,</span>       <span class="c1"># This requires ``import starlink.Ast`` to succeed.  This handles the largest</span>
                    <span class="c1"># number of WCS types of any of these.  In fact, it worked for every one</span>
                    <span class="c1"># we tried in our unit tests (which was not exhaustive).</span>

    <span class="n">AstropyWCS</span><span class="p">,</span>     <span class="c1"># This requires ``import astropy.wcs`` to succeed.  It doesn&#39;t support quite as</span>
                    <span class="c1"># many WCS types as PyAst.  It&#39;s also usually a little slower, so we prefer</span>
                    <span class="c1"># PyAstWCS when it is available.</span>

    <span class="n">WcsToolsWCS</span><span class="p">,</span>    <span class="c1"># This requires the wcstool command line functions to be installed.</span>
                    <span class="c1"># It is very slow, so it should only be used as a last resort.</span>

<span class="p">]</span>


<div class="viewcode-block" id="FitsWCS"><a class="viewcode-back" href="../../wcs.html#galsim.FitsWCS">[docs]</a><span class="k">def</span> <span class="nf">FitsWCS</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
            <span class="n">text_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This factory function will try to read the WCS from a FITS file and return a WCS that will</span>
<span class="sd">    work.  It tries a number of different WCS classes until it finds one that succeeds in reading</span>
<span class="sd">    the file.</span>

<span class="sd">    If none of them work, then the last class it tries, `AffineTransform`, is guaranteed to succeed,</span>
<span class="sd">    but it will only model the linear portion of the WCS (the CD matrix, CRPIX, and CRVAL), using</span>
<span class="sd">    reasonable defaults if even these are missing.  If you think that you have the right software</span>
<span class="sd">    for one of the WCS types, but FitsWCS still defaults to `AffineTransform`, it may be helpful to</span>
<span class="sd">    update your installation of astropy and/or starlink (if you don&#39;t already have the latest</span>
<span class="sd">    version).</span>

<span class="sd">    Note: The list of classes this function will try may be edited, e.g. by an external module</span>
<span class="sd">    that wants to add an additional WCS type.  The list is ``galsim.fitswcs.fits_wcs_types``.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        file_name:        The FITS file from which to read the WCS information.  This is probably</span>
<span class="sd">                          the usual parameter to provide.  [default: None]</span>
<span class="sd">        dir:              Optional directory to prepend to ``file_name``. [default: None]</span>
<span class="sd">        hdu:              Optionally, the number of the HDU to use if reading from a file.</span>
<span class="sd">                          The default is to use either the primary or first extension as</span>
<span class="sd">                          appropriate for the given compression.  (e.g. for rice, the first</span>
<span class="sd">                          extension is the one you normally want.) [default: None]</span>
<span class="sd">        header:           The header of an open pyfits (or astropy.io) hdu.  Or, it can be</span>
<span class="sd">                          a FitsHeader object.  [default: None]</span>
<span class="sd">        compression:      Which decompression scheme to use (if any). See galsim.fits.read()</span>
<span class="sd">                          for the available options.  [default: &#39;auto&#39;]</span>
<span class="sd">        text_file:        Normally a file is taken to be a fits file, but you can also give it a</span>
<span class="sd">                          text file with the header information (like the .head file output from</span>
<span class="sd">                          SCamp).  In this case you should set ``text_file = True`` to tell GalSim</span>
<span class="sd">                          to parse the file this way.  [default: False]</span>
<span class="sd">        suppress_warning: Whether to suppress a warning that the WCS could not be read from the</span>
<span class="sd">                          FITS header, so the WCS defaulted to either a `PixelScale` or</span>
<span class="sd">                          `AffineTransform`. [default: False]</span>
<span class="sd">                          (Note: this is (by default) set to True when this function is implicitly</span>
<span class="sd">                          called from one of the galsim.fits.read* functions.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot provide both file_name and pyfits header&quot;</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">FitsHeader</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="nb">dir</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="n">hdu</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                                 <span class="n">text_file</span><span class="o">=</span><span class="n">text_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;header&#39;</span> <span class="c1"># For sensible error messages below.</span>
    <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
            <span class="s2">&quot;Must provide either file_name or header&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">FitsHeader</span><span class="p">):</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">FitsHeader</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;CTYPE1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s1">&#39;CDELT1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_warning</span><span class="p">:</span>
            <span class="n">galsim_warn</span><span class="p">(</span><span class="s2">&quot;No WCS information found in </span><span class="si">%r</span><span class="s2">. Defaulting to PixelScale(1.0)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">PixelScale</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># For linear WCS specifications, AffineTransformation should work.</span>
    <span class="c1"># Note: Most files will have CTYPE1,2, but old style with only CDELT1,2 sometimes omits it.</span>
    <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">,</span> <span class="s1">&#39;LINEAR&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;LINEAR&#39;</span><span class="p">:</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">_readHeader</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="c1"># Convert to PixelScale if possible.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">dudx</span> <span class="o">==</span> <span class="n">wcs</span><span class="o">.</span><span class="n">dvdy</span> <span class="ow">and</span> <span class="n">wcs</span><span class="o">.</span><span class="n">dudy</span> <span class="o">==</span> <span class="n">wcs</span><span class="o">.</span><span class="n">dvdx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">wcs</span><span class="o">.</span><span class="n">x0</span> <span class="o">==</span> <span class="n">wcs</span><span class="o">.</span><span class="n">y0</span> <span class="o">==</span> <span class="n">wcs</span><span class="o">.</span><span class="n">u0</span> <span class="o">==</span> <span class="n">wcs</span><span class="o">.</span><span class="n">v0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">wcs</span> <span class="o">=</span> <span class="n">PixelScale</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">dudx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wcs</span> <span class="o">=</span> <span class="n">OffsetWCS</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">dudx</span><span class="p">,</span> <span class="n">wcs</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">wcs</span><span class="o">.</span><span class="n">world_origin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wcs</span>

    <span class="c1"># Otherwise (and typically), try the various wcs types that can read celestial coordinates.</span>
    <span class="k">for</span> <span class="n">wcs_type</span> <span class="ow">in</span> <span class="n">fits_wcs_types</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wcs</span> <span class="o">=</span> <span class="n">wcs_type</span><span class="o">.</span><span class="n">_readHeader</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="c1"># Give it a better tag for the repr if appropriate.</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span><span class="s1">&#39;_tag&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">file_name</span> <span class="o">!=</span> <span class="s1">&#39;header&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">wcs</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">file_name</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wcs</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">wcs</span><span class="o">.</span><span class="n">_tag</span> <span class="o">+=</span> <span class="s1">&#39;, hdu=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">hdu</span>
                <span class="k">if</span> <span class="n">compression</span> <span class="o">!=</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                    <span class="n">wcs</span><span class="o">.</span><span class="n">_tag</span> <span class="o">+=</span> <span class="s1">&#39;, compression=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">compression</span>
            <span class="k">return</span> <span class="n">wcs</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Finally, this one is really the last resort, since it only reads in the linear part of the</span>
        <span class="c1"># WCS.  It defaults to the equivalent of a pixel scale of 1.0 if even these are not present.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_warning</span><span class="p">:</span>
            <span class="n">galsim_warn</span><span class="p">(</span><span class="s2">&quot;All the fits WCS types failed to read </span><span class="si">%r</span><span class="s2">. Using AffineTransform &quot;</span>
                        <span class="s2">&quot;instead, which will not really be correct.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">AffineTransform</span><span class="o">.</span><span class="n">_readHeader</span><span class="p">(</span><span class="n">header</span><span class="p">)</span></div>

<span class="c1"># Let this function work like a class in config.</span>
<span class="n">FitsWCS</span><span class="o">.</span><span class="n">_req_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;file_name&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">}</span>
<span class="n">FitsWCS</span><span class="o">.</span><span class="n">_opt_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;dir&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;hdu&quot;</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;compression&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;text_file&#39;</span> <span class="p">:</span> <span class="nb">bool</span> <span class="p">}</span>

<div class="viewcode-block" id="FittedSIPWCS"><a class="viewcode-back" href="../../wcs.html#galsim.FittedSIPWCS">[docs]</a><span class="k">def</span> <span class="nf">FittedSIPWCS</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">wcs_type</span><span class="o">=</span><span class="s1">&#39;TAN&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A WCS constructed from a list of reference celestial and image</span>
<span class="sd">    coordinates.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        x:         Image x-coordinates of reference stars in pixels</span>
<span class="sd">        y:         Image y-coordinates of reference stars in pixels</span>
<span class="sd">        ra:        Right ascension of reference stars in radians</span>
<span class="sd">        dec:       Declination of reference stars in radians</span>
<span class="sd">        wcs_type:  The type of the tangent plane projection to use.  Should be</span>
<span class="sd">                   one of [&#39;TAN&#39;, &#39;STG&#39;, &#39;ZEA&#39;, or &#39;ARC&#39;].  [default: &#39;TAN&#39;]</span>
<span class="sd">        order:     The order of the Simple Imaging Polynomial (SIP) used to</span>
<span class="sd">                   describe the WCS distortion.  SIP coefficients kick in when</span>
<span class="sd">                   order &gt;= 2.  If you supply order=1, then just fit a WCS</span>
<span class="sd">                   without any SIP coefficients.  [default: 3]</span>
<span class="sd">        center:    A `CelestialCoord` defining the location on the sphere where</span>
<span class="sd">                   the tangent plane is centered.  [default: None, which means</span>
<span class="sd">                   use the average position of the list of reference stars]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">GalSimValueError</span><span class="p">(</span><span class="s2">&quot;Illegal SIP order&quot;</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

    <span class="n">nstar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># Make sure we have enough stars.</span>
    <span class="c1"># We need 1 star for crpix, 2 more for cd, and then</span>
    <span class="c1"># (order+2)*(order+1)/2 - 3 for ab.  The total is then (order+1)*(order+2)/2</span>
    <span class="n">nrequire</span> <span class="o">=</span> <span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">nstar</span> <span class="o">&lt;</span> <span class="n">nrequire</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span>
            <span class="s2">&quot;Require at least </span><span class="si">{:0}</span><span class="s2"> stars for SIP order </span><span class="si">{:1}</span><span class="s2">&quot;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nrequire</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Use deprojected 3D mean of ra/dec unit sphere points as center</span>
        <span class="n">wx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ra</span><span class="p">))</span>
        <span class="n">wy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ra</span><span class="p">))</span>
        <span class="n">wz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">CelestialCoord</span><span class="o">.</span><span class="n">from_xyz</span><span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">)</span>

    <span class="c1"># Project radec onto uv so we can linearly fit the CRPIX and CD matrix</span>
    <span class="c1"># initial guesses</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">project_rad</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">crpix_guess</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cd_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

    <span class="c1"># SIP coefficient initial guesses are just 0.0</span>
    <span class="n">ab_guess</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="n">order</span><span class="p">):</span>
                <span class="n">ab_guess</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">ab_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ab_guess</span><span class="p">)</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">crpix_guess</span><span class="p">,</span> <span class="n">cd_guess</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">ab_guess</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">_getWCS</span><span class="p">(</span><span class="n">wcs_type</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">crpix</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">ab</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">abp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doiter</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">wcs_type</span> <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">wcs_type</span><span class="o">+</span><span class="s1">&#39;-SIP&#39;</span><span class="p">,</span>
            <span class="n">crpix</span><span class="p">,</span>
            <span class="n">cd</span><span class="p">,</span>
            <span class="n">center</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span> <span class="c1"># pv, unused</span>
            <span class="n">ab</span><span class="p">,</span>
            <span class="n">abp</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">GSFitsWCS</span><span class="p">(</span><span class="n">_data</span><span class="o">=</span><span class="n">_data</span><span class="p">,</span> <span class="n">_doiter</span><span class="o">=</span><span class="n">doiter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_decodeSIP</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span> <span class="o">&gt;</span> <span class="n">order</span><span class="p">):</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># GSFitsWCS wants these with the identity included.</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ab</span>

    <span class="k">def</span> <span class="nf">_abLoss</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">wcs_type</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">crpix</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="n">_decodeSIP</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">_getWCS</span><span class="p">(</span><span class="n">wcs_type</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">crpix</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">ab</span><span class="p">)</span>
        <span class="n">ra_p</span><span class="p">,</span> <span class="n">dec_p</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">xyToradec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>
        <span class="n">u_p</span><span class="p">,</span> <span class="n">v_p</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">project_rad</span><span class="p">(</span><span class="n">ra_p</span><span class="p">,</span> <span class="n">dec_p</span><span class="p">)</span>
        <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">u</span><span class="o">-</span><span class="n">u_p</span><span class="p">,</span> <span class="n">v</span><span class="o">-</span><span class="n">v_p</span><span class="p">])</span>
        <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span><span class="o">*</span><span class="mi">3600</span><span class="o">*</span><span class="mf">1e6</span>  <span class="c1"># Work in microarcseconds</span>
        <span class="k">return</span> <span class="n">resid</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span>
        <span class="n">_abLoss</span><span class="p">,</span>
        <span class="n">guess</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">wcs_type</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># rmse = np.sqrt(2*result.cost/len(u))</span>
    <span class="c1"># print(f&quot;rmse: {rmse:.2f} microarcsec&quot;)</span>
    <span class="n">crpix</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">cd</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ab</span> <span class="o">=</span> <span class="n">_decodeSIP</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>

    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_getWCS</span><span class="p">(</span><span class="n">wcs_type</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">crpix</span><span class="p">,</span> <span class="n">cd</span><span class="p">)</span>

    <span class="c1"># Now go back holding crpix, cd, and ab constant, and solve for inverse</span>
    <span class="c1"># coefficients abp</span>
    <span class="c1"># ABP SIP coefficient initial guesses are just 0.0</span>
    <span class="n">abp_guess</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="n">order</span><span class="p">):</span>
                <span class="n">abp_guess</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    <span class="n">abp_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">abp_guess</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_abpLoss</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">wcs_type</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">crpix</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">abp</span> <span class="o">=</span> <span class="n">_decodeSIP</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">_getWCS</span><span class="p">(</span><span class="n">wcs_type</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">crpix</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">abp</span><span class="p">)</span>
        <span class="n">x_p</span><span class="p">,</span> <span class="n">y_p</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">radecToxy</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>
        <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">x</span><span class="o">-</span><span class="n">x_p</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">y_p</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span>  <span class="c1"># work in micropixels</span>
        <span class="k">return</span> <span class="n">resid</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span>
        <span class="n">_abpLoss</span><span class="p">,</span> <span class="n">abp_guess</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">wcs_type</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">crpix</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># rmse = np.sqrt(2*result.cost/len(u))</span>
    <span class="c1"># print(f&quot;rmse: {rmse:.2f} micropixels&quot;)</span>
    <span class="n">abp</span> <span class="o">=</span> <span class="n">_decodeSIP</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_getWCS</span><span class="p">(</span><span class="n">wcs_type</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">crpix</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">abp</span><span class="p">,</span> <span class="n">doiter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, GalSim-developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>