<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>galsim.real &mdash; GalSim 2.7.2 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            GalSim
          </a>
              <div class="version">
                2.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../image.html">Images and Related Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sb.html">Surface Brightness Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chromatic.html">Wavelength-dependent Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wcs.html">World Coordinate Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../random.html">Noise and Random Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wl.html">Weak Lensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../photon.html">Photon Shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Helper Functions and Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../errors.html">Errors and Warnings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">The Config Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hsm.html">The HSM Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../des.html">The DES Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roman.html">The Roman Space Telescope Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpp.html">C++ Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.html">Shared Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">Revision History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GalSim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">galsim.real</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for galsim.real</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2012-2023 by the GalSim developers team on GitHub</span>
<span class="c1"># https://github.com/GalSim-developers</span>
<span class="c1">#</span>
<span class="c1"># This file is part of GalSim: The modular galaxy image simulation toolkit.</span>
<span class="c1"># https://github.com/GalSim-developers/GalSim</span>
<span class="c1">#</span>
<span class="c1"># GalSim is free software: redistribution and use in source and binary forms,</span>
<span class="c1"># with or without modification, are permitted provided that the following</span>
<span class="c1"># conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#    list of conditions, and the disclaimer given in the accompanying LICENSE</span>
<span class="c1">#    file.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#    this list of conditions, and the disclaimer given in the documentation</span>
<span class="c1">#    and/or other materials provided with the distribution.</span>
<span class="c1">#</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;RealGalaxy&#39;</span><span class="p">,</span> <span class="s1">&#39;RealGalaxyCatalog&#39;</span><span class="p">,</span> <span class="s1">&#39;ChromaticRealGalaxy&#39;</span><span class="p">,</span> <span class="p">]</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Lock</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_galsim</span>
<span class="kn">from</span> <span class="nn">.gsobject</span> <span class="kn">import</span> <span class="n">GSObject</span>
<span class="kn">from</span> <span class="nn">.gsparams</span> <span class="kn">import</span> <span class="n">GSParams</span>
<span class="kn">from</span> <span class="nn">.bounds</span> <span class="kn">import</span> <span class="n">BoundsI</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">lazy_property</span><span class="p">,</span> <span class="n">doc_inherit</span><span class="p">,</span> <span class="n">convert_interpolant</span><span class="p">,</span> <span class="n">merge_sorted</span>
<span class="kn">from</span> <span class="nn">.interpolant</span> <span class="kn">import</span> <span class="n">Quintic</span>
<span class="kn">from</span> <span class="nn">.interpolatedimage</span> <span class="kn">import</span> <span class="n">InterpolatedImage</span><span class="p">,</span> <span class="n">_InterpolatedKImage</span>
<span class="kn">from</span> <span class="nn">.convolve</span> <span class="kn">import</span> <span class="n">Convolve</span><span class="p">,</span> <span class="n">Deconvolve</span>
<span class="kn">from</span> <span class="nn">.image</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageCD</span>
<span class="kn">from</span> <span class="nn">.correlatednoise</span> <span class="kn">import</span> <span class="n">UncorrelatedNoise</span><span class="p">,</span> <span class="n">BaseCorrelatedNoise</span><span class="p">,</span> <span class="n">CovarianceSpectrum</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="kn">import</span> <span class="n">GalSimValueError</span><span class="p">,</span> <span class="n">GalSimIncompatibleValuesError</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="kn">import</span> <span class="n">GalSimIndexError</span>
<span class="kn">from</span> <span class="nn">.table</span> <span class="kn">import</span> <span class="n">LookupTable</span>
<span class="kn">from</span> <span class="nn">.random</span> <span class="kn">import</span> <span class="n">BaseDeviate</span><span class="p">,</span> <span class="n">UniformDeviate</span>
<span class="kn">from</span> <span class="nn">.sed</span> <span class="kn">import</span> <span class="n">SED</span>
<span class="kn">from</span> <span class="nn">.bandpass</span> <span class="kn">import</span> <span class="n">Bandpass</span>
<span class="kn">from</span> <span class="nn">.chromatic</span> <span class="kn">import</span> <span class="n">ChromaticSum</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">meta_data</span>
<span class="kn">from</span> <span class="nn">._pyfits</span> <span class="kn">import</span> <span class="n">pyfits</span>


<span class="n">HST_area</span> <span class="o">=</span> <span class="mf">45238.93416</span>  <span class="c1"># Area of HST primary mirror in cm^2 from Synphot User&#39;s Guide.</span>

<span class="c1"># Currently, have bandpasses available for HST COSMOS, AEGIS, and CANDELS.</span>
<span class="c1"># ACS zeropoints (AB magnitudes) from</span>
<span class="c1"># http://www.stsci.edu/hst/acs/analysis/zeropoints/old_page/localZeropoints#tablestart</span>
<span class="c1"># WFC3 zeropoints (AB magnitudes) from</span>
<span class="c1"># http://www.stsci.edu/hst/wfc3/phot_zp_lbn</span>
<span class="c1"># Format of dictionary entry is:</span>
<span class="c1">#    &#39;KEY&#39; : tuple(bandpass filename, zeropoint)</span>
<span class="n">real_galaxy_bandpasses</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;F275W&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;WFC3_uvis_F275W.dat&#39;</span><span class="p">,</span> <span class="mf">24.1305</span><span class="p">),</span>
        <span class="s1">&#39;F336W&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;WFC3_uvis_F336W.dat&#39;</span><span class="p">,</span> <span class="mf">24.6682</span><span class="p">),</span>
        <span class="s1">&#39;F435W&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ACS_wfc_F435W.dat&#39;</span><span class="p">,</span> <span class="mf">25.65777</span><span class="p">),</span>
        <span class="s1">&#39;F606W&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ACS_wfc_F606W.dat&#39;</span><span class="p">,</span> <span class="mf">26.49113</span><span class="p">),</span>
        <span class="s1">&#39;F775W&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ACS_wfc_F775W.dat&#39;</span><span class="p">,</span> <span class="mf">25.66504</span><span class="p">),</span>
        <span class="s1">&#39;F814W&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ACS_wfc_F814W.dat&#39;</span><span class="p">,</span> <span class="mf">25.94333</span><span class="p">),</span>
        <span class="s1">&#39;F850LP&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ACS_wfc_F850LP.dat&#39;</span><span class="p">,</span> <span class="mf">24.84245</span><span class="p">),</span>
        <span class="s1">&#39;F105W&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;WFC3_ir_F105W.dat&#39;</span><span class="p">,</span> <span class="mf">26.2687</span><span class="p">),</span>
        <span class="s1">&#39;F125W&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;WFC3_ir_F125W.dat&#39;</span><span class="p">,</span> <span class="mf">26.2303</span><span class="p">),</span>
        <span class="s1">&#39;F160W&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;WFC3_ir_F160W.dat&#39;</span><span class="p">,</span> <span class="mf">25.9463</span><span class="p">)</span>
<span class="p">}</span>

<div class="viewcode-block" id="RealGalaxy"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxy">[docs]</a><span class="k">class</span> <span class="nc">RealGalaxy</span><span class="p">(</span><span class="n">GSObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class describing real galaxies from some training dataset.  Its underlying implementation</span>
<span class="sd">    uses a Convolution instance of an `InterpolatedImage` (for the observed galaxy) with a</span>
<span class="sd">    `Deconvolution` of another `InterpolatedImage` (for the PSF).</span>

<span class="sd">    This class uses a catalog describing galaxies in some training data (for more details, see the</span>
<span class="sd">    `RealGalaxyCatalog` documentation) to read in data about realistic galaxies that can be used for</span>
<span class="sd">    simulations based on those galaxies.  Also included in the class is additional information that</span>
<span class="sd">    might be needed to make or interpret the simulations, e.g., the noise properties of the training</span>
<span class="sd">    data.  Users who wish to draw RealGalaxies that have well-defined flux scalings in various</span>
<span class="sd">    passbands, and/or parametric representations, should use the COSMOSGalaxy class.</span>

<span class="sd">    Because RealGalaxy involves a `Deconvolution`, ``method = &#39;phot&#39;`` is unavailable for the</span>
<span class="sd">    `GSObject.drawImage` function, and it is essential that users convolve each RealGalaxy with a</span>
<span class="sd">    PSF that is at least as large as the original HST PSF (stored as an attribute) before rendering</span>
<span class="sd">    any images.  This is necessary to eliminate noise that was amplified due to deconvolution of the</span>
<span class="sd">    HST PSF.</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; real_galaxy = galsim.RealGalaxy(real_galaxy_catalog, index=None, id=None, random=False,</span>
<span class="sd">        ...                                 rng=None, x_interpolant=None, k_interpolant=None,</span>
<span class="sd">        ...                                 flux=None, pad_factor=4, noise_pad_size=0,</span>
<span class="sd">        ...                                 gsparams=None)</span>

<span class="sd">    This initializes ``real_galaxy`` with three `InterpolatedImage` objects (one for the deconvolved</span>
<span class="sd">    galaxy, and saved versions of the original HST image and PSF). Note that there are multiple</span>
<span class="sd">    keywords for choosing a galaxy; exactly one must be set.</span>

<span class="sd">    Note that tests suggest that for optimal balance between accuracy and speed, ``k_interpolant``</span>
<span class="sd">    and ``pad_factor`` should be kept at their default values.  The user should be aware that</span>
<span class="sd">    significant inaccuracy can result from using other combinations of these parameters; more</span>
<span class="sd">    details can be found in http://arxiv.org/abs/1401.2636, especially table 1, and in comment</span>
<span class="sd">    https://github.com/GalSim-developers/GalSim/issues/389#issuecomment-26166621 and the following</span>
<span class="sd">    comments.</span>

<span class="sd">    If you don&#39;t set a flux, the flux of the returned object will be the flux of the original</span>
<span class="sd">    HST data, scaled to correspond to a 1 second HST exposure (though see the ``area_norm``</span>
<span class="sd">    parameter below, and also caveats related to using the ``flux`` parameter).  If you want a flux</span>
<span class="sd">    appropriate for a longer exposure, or for a telescope with a different collecting area than HST,</span>
<span class="sd">    you can either renormalize the object with the ``flux_rescale`` parameter, or by using the</span>
<span class="sd">    ``exptime`` and ``area`` parameters to `GSObject.drawImage`.</span>

<span class="sd">    Note that RealGalaxy objects use arcsec for the units of their linear dimension.  If you</span>
<span class="sd">    are using a different unit for other things (the PSF, WCS, etc.), then you should dilate</span>
<span class="sd">    the resulting object with ``gal.dilate(galsim.arcsec / scale_unit)``.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        real_galaxy_catalog:    A `RealGalaxyCatalog` object with basic information about where to</span>
<span class="sd">                                find the data, etc.</span>
<span class="sd">        index:                  Index of the desired galaxy in the catalog. [One of ``index``,</span>
<span class="sd">                                ``id``, or ``random`` is required.]</span>
<span class="sd">        id:                     Object ID for the desired galaxy in the catalog. [One of ``index``,</span>
<span class="sd">                                ``id``, or ``random`` is required.]</span>
<span class="sd">        random:                 If True, then select a random galaxy from the catalog.  If the</span>
<span class="sd">                                catalog has a &#39;weight&#39; associated with it to allow for correction of</span>
<span class="sd">                                selection effects in which galaxies were included, the &#39;weight&#39;</span>
<span class="sd">                                factor is used to remove those selection effects rather than</span>
<span class="sd">                                selecting a completely random object.</span>
<span class="sd">                                [One of ``index``, ``id``, or ``random`` is required.]</span>
<span class="sd">        rng:                    A random number generator to use for selecting a random galaxy</span>
<span class="sd">                                (may be any kind of `BaseDeviate` or None) and to use in generating</span>
<span class="sd">                                any noise field when padding. [default: None]</span>
<span class="sd">        x_interpolant:          Either an `Interpolant` instance or a string indicating which</span>
<span class="sd">                                real-space interpolant should be used.  Options are &#39;nearest&#39;,</span>
<span class="sd">                                &#39;sinc&#39;, &#39;linear&#39;, &#39;cubic&#39;, &#39;quintic&#39;, or &#39;lanczosN&#39; where N should</span>
<span class="sd">                                be the integer order to use. [default: galsim.Quintic()]</span>
<span class="sd">        k_interpolant:          Either an `Interpolant` instance or a string indicating which</span>
<span class="sd">                                k-space interpolant should be used.  Options are &#39;nearest&#39;, &#39;sinc&#39;,</span>
<span class="sd">                                &#39;linear&#39;, &#39;cubic&#39;, &#39;quintic&#39;, or &#39;lanczosN&#39; where N should be the</span>
<span class="sd">                                integer order to use.  We strongly recommend leaving this parameter</span>
<span class="sd">                                at its default value; see text above for details.</span>
<span class="sd">                                [default: galsim.Quintic()]</span>
<span class="sd">        flux:                   Total flux, if None then original flux in image is adopted without</span>
<span class="sd">                                change.  Note that, technically, this parameter sets the flux of the</span>
<span class="sd">                                postage stamp image and not the flux of the contained galaxy.</span>
<span class="sd">                                These two values will be strongly correlated when the signal-to-</span>
<span class="sd">                                noise ratio of the galaxy is large, but may be considerably</span>
<span class="sd">                                different if the flux of the galaxy is small with respect to the</span>
<span class="sd">                                noise variations in the postage stamp.  To avoid complications with</span>
<span class="sd">                                faint galaxies, consider using the flux_rescale parameter.</span>
<span class="sd">                                [default: None]</span>
<span class="sd">        flux_rescale:           Flux rescaling factor; if None, then no rescaling is done.  Either</span>
<span class="sd">                                ``flux`` or ``flux_rescale`` may be set, but not both.</span>
<span class="sd">                                [default: None]</span>
<span class="sd">        pad_factor:             Factor by which to pad the `Image` when creating the</span>
<span class="sd">                                `InterpolatedImage`.  We strongly recommend leaving this parameter</span>
<span class="sd">                                at its default value; see text above for details.  [default: 4]</span>
<span class="sd">        noise_pad_size:         If provided, the image will be padded out to this size (in arcsec)</span>
<span class="sd">                                with the noise specified in the real galaxy catalog. This is</span>
<span class="sd">                                important if you are planning to whiten the resulting image.  You</span>
<span class="sd">                                should make sure that the padded image is larger than the postage</span>
<span class="sd">                                stamp onto which you are drawing this object.</span>
<span class="sd">                                [default: None]</span>
<span class="sd">        area_norm:              Area in cm^2 by which to normalize the flux of the returned object.</span>
<span class="sd">                                When area_norm=1 (the default), drawing with `GSObject.drawImage`</span>
<span class="sd">                                keywords exptime=1 and area=1 will simulate an image with the</span>
<span class="sd">                                appropriate number of counts for a 1 second exposure with the</span>
<span class="sd">                                original telescope/camera (e.g., with HST when using the COSMOS</span>
<span class="sd">                                catalog).</span>
<span class="sd">                                If you would rather explicitly specify the collecting area of the</span>
<span class="sd">                                telescope when using `GSObject.drawImage` with a `RealGalaxy`,</span>
<span class="sd">                                then you should set area_norm equal to the collecting area of the</span>
<span class="sd">                                source catalog telescope when creating the `RealGalaxy` (e.g.,</span>
<span class="sd">                                area_norm=45238.93416 for HST).  [default: 1]</span>
<span class="sd">        gsparams:               An optional `GSParams` argument. [default: None]</span>
<span class="sd">        logger:                 A logger object for output of progress statements if the user wants</span>
<span class="sd">                                them.  [default: None]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_opt_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;x_interpolant&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">,</span>
                    <span class="s2">&quot;k_interpolant&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">,</span>
                    <span class="s2">&quot;flux&quot;</span> <span class="p">:</span> <span class="nb">float</span> <span class="p">,</span>
                    <span class="s2">&quot;flux_rescale&quot;</span> <span class="p">:</span> <span class="nb">float</span> <span class="p">,</span>
                    <span class="s2">&quot;pad_factor&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s2">&quot;noise_pad_size&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s2">&quot;area_norm&quot;</span> <span class="p">:</span> <span class="nb">float</span>
                  <span class="p">}</span>
    <span class="n">_single_params</span> <span class="o">=</span> <span class="p">[</span> <span class="p">{</span> <span class="s2">&quot;index&quot;</span> <span class="p">:</span> <span class="nb">int</span> <span class="p">,</span> <span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">,</span> <span class="s2">&quot;random&quot;</span> <span class="p">:</span> <span class="nb">bool</span> <span class="p">}</span> <span class="p">]</span>
    <span class="n">_takes_rng</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">_has_hard_edges</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_is_axisymmetric</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_is_analytic_x</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_is_analytic_k</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">real_galaxy_catalog</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_interpolant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k_interpolant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flux_rescale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">pad_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">noise_pad_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">area_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">BaseDeviate</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">BaseDeviate</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The rng provided to RealGalaxy is not a BaseDeviate&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>

        <span class="k">if</span> <span class="n">flux</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">flux_rescale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot supply a flux and a flux rescaling factor.&quot;</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="n">flux</span><span class="p">,</span> <span class="n">flux_rescale</span><span class="o">=</span><span class="n">flux_rescale</span><span class="p">)</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>  <span class="c1"># So don&#39;t need to check `if logger:` all the time.</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">real_galaxy_catalog</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># Special (undocumented) way to build a RealGalaxy without needing the rgc directly</span>
            <span class="c1"># by providing the things we need from it.  Used by COSMOSGalaxy.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gal_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_image</span><span class="p">,</span> <span class="n">noise_image</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">real_galaxy_catalog</span>
            <span class="n">use_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># For the logger statements below.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RealGalaxy </span><span class="si">%d</span><span class="s1">: Start RealGalaxy constructor.&#39;</span><span class="p">,</span><span class="n">use_index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get the index to use in the catalog</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">random</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                        <span class="s2">&quot;Too many methods for selecting a galaxy.&quot;</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">)</span>
                <span class="n">use_index</span> <span class="o">=</span> <span class="n">index</span>
            <span class="k">elif</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">random</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                        <span class="s2">&quot;Too many methods for selecting a galaxy.&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">)</span>
                <span class="n">use_index</span> <span class="o">=</span> <span class="n">real_galaxy_catalog</span><span class="o">.</span><span class="n">getIndexForID</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">random</span><span class="p">:</span>
                <span class="n">ud</span> <span class="o">=</span> <span class="n">UniformDeviate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
                <span class="n">use_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">real_galaxy_catalog</span><span class="o">.</span><span class="n">nobjects</span> <span class="o">*</span> <span class="n">ud</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">real_galaxy_catalog</span><span class="o">.</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># If weight factors are available, make sure the random selection uses the</span>
                    <span class="c1"># weights to remove the catalog-level selection effects (flux_radius-dependent</span>
                    <span class="c1"># probability of making a postage stamp for a given object).</span>
                    <span class="k">while</span> <span class="n">ud</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">real_galaxy_catalog</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">use_index</span><span class="p">]:</span>
                        <span class="c1"># Pick another one to try.</span>
                        <span class="n">use_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">real_galaxy_catalog</span><span class="o">.</span><span class="n">nobjects</span> <span class="o">*</span> <span class="n">ud</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;No method specified for selecting a galaxy.&quot;</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RealGalaxy </span><span class="si">%d</span><span class="s1">: Start RealGalaxy constructor.&#39;</span><span class="p">,</span><span class="n">use_index</span><span class="p">)</span>

            <span class="c1"># Read in the galaxy, PSF images; for now, rely on pyfits to make I/O errors.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gal_image</span> <span class="o">=</span> <span class="n">real_galaxy_catalog</span><span class="o">.</span><span class="n">getGalImage</span><span class="p">(</span><span class="n">use_index</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RealGalaxy </span><span class="si">%d</span><span class="s1">: Got gal_image&#39;</span><span class="p">,</span><span class="n">use_index</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">psf_image</span> <span class="o">=</span> <span class="n">real_galaxy_catalog</span><span class="o">.</span><span class="n">getPSFImage</span><span class="p">(</span><span class="n">use_index</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RealGalaxy </span><span class="si">%d</span><span class="s1">: Got psf_image&#39;</span><span class="p">,</span><span class="n">use_index</span><span class="p">)</span>

            <span class="c1">#self._gal_noise = real_galaxy_catalog.getNoise(use_index, self.rng, gsparams)</span>
            <span class="c1"># We need to duplication some of the RealGalaxyCatalog.getNoise() function, since we</span>
            <span class="c1"># want it to be possible to have the RealGalaxyCatalog in another process, and the</span>
            <span class="c1"># BaseCorrelatedNoise object is not picklable.  So we just build it here instead.</span>
            <span class="n">noise_image</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">real_galaxy_catalog</span><span class="o">.</span><span class="n">getNoiseProperties</span><span class="p">(</span><span class="n">use_index</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RealGalaxy </span><span class="si">%d</span><span class="s1">: Got noise_image&#39;</span><span class="p">,</span><span class="n">use_index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog_file</span> <span class="o">=</span> <span class="n">real_galaxy_catalog</span><span class="o">.</span><span class="n">getFileName</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">real_galaxy_catalog</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span> <span class="o">=</span> <span class="n">GSParams</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">gsparams</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">noise_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gal_noise</span> <span class="o">=</span> <span class="n">UncorrelatedNoise</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">pixel_scale</span><span class="p">,</span>
                                                <span class="n">gsparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">InterpolatedImage</span><span class="p">(</span><span class="n">noise_image</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="s2">&quot;sb&quot;</span><span class="p">,</span>
                                   <span class="n">calculate_stepk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calculate_maxk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">x_interpolant</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gal_noise</span> <span class="o">=</span> <span class="n">BaseCorrelatedNoise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">noise_image</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gal_noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gal_noise</span><span class="o">.</span><span class="n">withVariance</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RealGalaxy </span><span class="si">%d</span><span class="s1">: Finished building noise&#39;</span><span class="p">,</span><span class="n">use_index</span><span class="p">)</span>

        <span class="c1"># Save any other relevant information as instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">use_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pixel_scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_interpolant</span> <span class="o">=</span> <span class="n">x_interpolant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_k_interpolant</span> <span class="o">=</span> <span class="n">k_interpolant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pad_factor</span> <span class="o">=</span> <span class="n">pad_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_noise_pad_size</span> <span class="o">=</span> <span class="n">noise_pad_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_flux</span> <span class="o">=</span> <span class="n">flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flux_rescale</span> <span class="o">=</span> <span class="n">flux_rescale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_area_norm</span> <span class="o">=</span> <span class="n">area_norm</span>

        <span class="c1"># Convert noise_pad to the right noise to pass to InterpolatedImage</span>
        <span class="k">if</span> <span class="n">noise_pad_size</span><span class="p">:</span>
            <span class="n">noise_pad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gal_noise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">noise_pad</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># Build the InterpolatedImage of the PSF.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_psf</span> <span class="o">=</span> <span class="n">InterpolatedImage</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psf_image</span><span class="p">,</span> <span class="n">x_interpolant</span><span class="o">=</span><span class="n">x_interpolant</span><span class="p">,</span> <span class="n">k_interpolant</span><span class="o">=</span><span class="n">k_interpolant</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RealGalaxy </span><span class="si">%d</span><span class="s1">: Made original_psf&#39;</span><span class="p">,</span><span class="n">use_index</span><span class="p">)</span>

        <span class="c1"># Build the InterpolatedImage of the galaxy.</span>
        <span class="c1"># Use the stepk value of the PSF as a maximum value for stepk of the galaxy.</span>
        <span class="c1"># (Otherwise, low surface brightness galaxies can get a spuriously high stepk, which</span>
        <span class="c1"># leads to problems.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_gal</span> <span class="o">=</span> <span class="n">InterpolatedImage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gal_image</span><span class="p">,</span> <span class="n">x_interpolant</span><span class="o">=</span><span class="n">x_interpolant</span><span class="p">,</span> <span class="n">k_interpolant</span><span class="o">=</span><span class="n">k_interpolant</span><span class="p">,</span>
                <span class="n">pad_factor</span><span class="o">=</span><span class="n">pad_factor</span><span class="p">,</span> <span class="n">noise_pad_size</span><span class="o">=</span><span class="n">noise_pad_size</span><span class="p">,</span>
                <span class="n">calculate_stepk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">original_psf</span><span class="o">.</span><span class="n">stepk</span><span class="p">,</span>
                <span class="n">calculate_maxk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">original_psf</span><span class="o">.</span><span class="n">maxk</span><span class="p">,</span>
                <span class="n">noise_pad</span><span class="o">=</span><span class="n">noise_pad</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RealGalaxy </span><span class="si">%d</span><span class="s1">: Made original_gal&#39;</span><span class="p">,</span><span class="n">use_index</span><span class="p">)</span>

        <span class="c1"># Only alter normalization if a change is requested</span>
        <span class="k">if</span> <span class="n">flux</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">flux_rescale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">area_norm</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flux_rescale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">flux_rescale</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">flux_rescale</span> <span class="o">/=</span> <span class="n">area_norm</span>
            <span class="k">if</span> <span class="n">flux</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">flux_rescale</span> <span class="o">*=</span> <span class="n">flux</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">original_gal</span><span class="o">.</span><span class="n">flux</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_gal</span> <span class="o">*=</span> <span class="n">flux_rescale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gal_noise</span> <span class="o">*=</span> <span class="n">flux_rescale</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RealGalaxy </span><span class="si">%d</span><span class="s1">: Finished building RealGalaxy&#39;</span><span class="p">,</span><span class="n">use_index</span><span class="p">)</span>

<div class="viewcode-block" id="RealGalaxy.withGSParams"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxy.withGSParams">[docs]</a>    <span class="nd">@doc_inherit</span>
    <span class="k">def</span> <span class="nf">withGSParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">gsparams</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">gsparams</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_gsparams</span> <span class="o">=</span> <span class="n">GSParams</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">gsparams</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">original_gal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_gal</span><span class="o">.</span><span class="n">withGSParams</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">original_psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_psf</span><span class="o">.</span><span class="n">withGSParams</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">_gal_noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gal_noise</span><span class="o">.</span><span class="n">withGSParams</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="RealGalaxy.makeFromImage"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxy.makeFromImage">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">makeFromImage</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">PSF</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a `RealGalaxy` directly from image, PSF, and noise description.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            image:  `Image` of the galaxy you want to simulate.</span>
<span class="sd">            PSF:    `GSObject` representing the PSF of the galaxy image.  Note that this PSF</span>
<span class="sd">                    should include the response of the pixel convolution.</span>
<span class="sd">            xi:     `BaseCorrelatedNoise` object characterizing the noise correlations in the input</span>
<span class="sd">                    image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">noise_image</span> <span class="o">=</span> <span class="n">xi</span><span class="o">.</span><span class="n">drawImage</span><span class="p">()</span>
        <span class="n">pixel_scale</span> <span class="o">=</span> <span class="n">noise_image</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">xi</span><span class="o">.</span><span class="n">getVariance</span><span class="p">()</span>
        <span class="n">psf_image</span> <span class="o">=</span> <span class="n">PSF</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;no_pixel&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RealGalaxy</span><span class="p">((</span><span class="n">image</span><span class="p">,</span> <span class="n">psf_image</span><span class="p">,</span> <span class="n">noise_image</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">RealGalaxy</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">catalog</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_x_interpolant</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_x_interpolant</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_k_interpolant</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_k_interpolant</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_pad_factor</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_pad_factor</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_noise_pad_size</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_noise_pad_size</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_input_flux</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_input_flux</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_flux_rescale</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_flux_rescale</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_area_norm</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_area_norm</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="s2">&quot;galsim.RealGalaxy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_interpolant</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_k_interpolant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_factor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noise_pad_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_flux</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_flux_rescale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_area_norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;galsim.RealGalaxy(</span><span class="si">%r</span><span class="s1">, index=</span><span class="si">%r</span><span class="s1">, &#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_interpolant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;x_interpolant=</span><span class="si">%r</span><span class="s1">, &#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_interpolant</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_interpolant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;k_interpolant=</span><span class="si">%r</span><span class="s1">, &#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_k_interpolant</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_factor</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;pad_factor=</span><span class="si">%r</span><span class="s1">, &#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_pad_factor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noise_pad_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;noise_pad_size=</span><span class="si">%r</span><span class="s1">, &#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_noise_pad_size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_flux</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;flux=</span><span class="si">%r</span><span class="s1">, &#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_flux</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flux_rescale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;flux_rescale=</span><span class="si">%r</span><span class="s1">, &#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_flux_rescale</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_area_norm</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;area_norm=</span><span class="si">%r</span><span class="s1">, &#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_area_norm</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;rng=</span><span class="si">%r</span><span class="s1">, &#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;gsparams=</span><span class="si">%r</span><span class="s1">)&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># I think this is more intuitive without the RealGalaxyCatalog parameter listed.</span>
        <span class="k">return</span> <span class="s1">&#39;galsim.RealGalaxy(index=</span><span class="si">%s</span><span class="s1">, flux=</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_conv&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_psf_inv&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_psf_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Deconvolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_psf</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_conv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Convolve</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">original_gal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psf_inv</span><span class="p">],</span> <span class="n">gsparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We just store the original noise, not convolved with psf_inv until we need it,</span>
        <span class="c1"># mostly so we don&#39;t have to invalidate this if gsparams changes.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gal_noise</span><span class="o">.</span><span class="n">convolvedWith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_psf_inv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_maxk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="o">.</span><span class="n">_maxk</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_stepk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="o">.</span><span class="n">_stepk</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="o">.</span><span class="n">_centroid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="o">.</span><span class="n">_flux</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_positive_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="o">.</span><span class="n">_positive_flux</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_negative_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="o">.</span><span class="n">_negative_flux</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_flux_per_photon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_flux_per_photon</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_max_sb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="o">.</span><span class="n">_max_sb</span>

    <span class="k">def</span> <span class="nf">_kValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpos</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="o">.</span><span class="n">_kValue</span><span class="p">(</span><span class="n">kpos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_drawKImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conv</span><span class="o">.</span><span class="n">_drawKImage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">jac</span><span class="p">)</span></div>


<div class="viewcode-block" id="RealGalaxyCatalog"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxyCatalog">[docs]</a><span class="k">class</span> <span class="nc">RealGalaxyCatalog</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class containing a catalog with information about real galaxy training data.</span>

<span class="sd">    The RealGalaxyCatalog class reads in and stores information about a specific training sample of</span>
<span class="sd">    realistic galaxies. We assume that all files containing the images (galaxies and PSFs) live in</span>
<span class="sd">    one directory; they could be individual files, or multiple HDUs of the same file.  Currently</span>
<span class="sd">    there is no functionality that lets this be a FITS data cube, because we assume that the object</span>
<span class="sd">    postage stamps will in general need to be different sizes depending on the galaxy size.</span>

<span class="sd">    Note that when simulating galaxies based on HST but using either realistic or parametric galaxy</span>
<span class="sd">    models, the COSMOSCatalog class may be more useful.  It allows the imposition of selection</span>
<span class="sd">    criteria and other subtleties that are more difficult to impose with RealGalaxyCatalog.</span>

<span class="sd">    While you could create your own catalog to use with this class, the typical use cases would</span>
<span class="sd">    be to use one of the catalogs that we have created and distributed.  There are three such</span>
<span class="sd">    catalogs currently, which can be use with one of the following initializations:</span>

<span class="sd">    1. A small example catalog is distributed with the GalSim distribution.  This catalog only</span>
<span class="sd">       has 100 galaxies, so it is not terribly useful as a representative galaxy population.</span>
<span class="sd">       But for simplistic use cases, it might be sufficient.  We use it for our unit tests and</span>
<span class="sd">       in some of the demo scripts (demo6, demo10, and demo11).  To use this catalog, you would</span>
<span class="sd">       initialize with::</span>

<span class="sd">           &gt;&gt;&gt; rgc = galsim.RealGalaxyCatalog(&#39;real_galaxy_catalog_23.5_example.fits&#39;,</span>
<span class="sd">                                              dir=&#39;path/to/GalSim/examples/data&#39;)</span>

<span class="sd">    2. There are two larger catalogs based on HST observations of the COSMOS field with around</span>
<span class="sd">       26,000 and 56,000 galaxies each with a limiting magnitude of F814W=23.5.  (The former is</span>
<span class="sd">       a subset of the latter.) For information about how to download these catalogs, see the</span>
<span class="sd">       RealGalaxy Data Download Page on the GalSim Wiki:</span>

<span class="sd">       https://github.com/GalSim-developers/GalSim/wiki/RealGalaxy%20Data</span>

<span class="sd">       Be warned that the catalogs are quite large.  The larger one is around 11 GB after unpacking</span>
<span class="sd">       the tarball.  To use one of these catalogs, you would initialize with::</span>

<span class="sd">           &gt;&gt;&gt; rgc = galsim.RealGalaxyCatalog(&#39;real_galaxy_catalog_23.5.fits&#39;,</span>
<span class="sd">                                              dir=&#39;path/to/download/directory&#39;)</span>

<span class="sd">    3. There is a catalog containing a random subsample of the HST COSMOS images with a limiting</span>
<span class="sd">       magnitude of F814W=25.2.  More information about downloading these catalogs can be found on</span>
<span class="sd">       the RealGalaxy Data Download page linked above.</span>

<span class="sd">    4. Finally, we provide a program that will download the large COSMOS sample for you and</span>
<span class="sd">       put it in the $PREFIX/share/galsim directory of your installation path.  The program is::</span>

<span class="sd">           galsim_download_cosmos</span>

<span class="sd">       which gets installed in the $PREFIX/bin directory when you install GalSim.  If you use</span>
<span class="sd">       this program to download the COSMOS catalog, then you can use it with::</span>

<span class="sd">           &gt;&gt;&gt; rgc = galsim.RealGalaxyCatalog()</span>

<span class="sd">       GalSim knows the location of the installation share directory, so it will automatically</span>
<span class="sd">       look for it there.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        file_name:  The file containing the catalog. [default: None, which will look for the</span>
<span class="sd">                    F814W&lt;25.2 COSMOS catalog in $PREFIX/share/galsim.  It will raise an</span>
<span class="sd">                    exception if the catalog is not there telling you to run</span>
<span class="sd">                    galsim_download_cosmos.]</span>
<span class="sd">        sample:     A keyword argument that can be used to specify the sample to use, i.e.,</span>
<span class="sd">                    &quot;23.5&quot; or &quot;25.2&quot;.  At most one of ``file_name`` and ``sample`` should be</span>
<span class="sd">                    specified.</span>
<span class="sd">                    [default: None, which results in the same default as ``file_name=None``.]</span>
<span class="sd">        dir:        The directory containing the catalog, image, and noise files, or symlinks to</span>
<span class="sd">                    them. [default: None]</span>
<span class="sd">        preload:    Whether to preload the header information.  If ``preload=True``, the bulk of</span>
<span class="sd">                    the I/O time is in the constructor.  If ``preload=False``, there is</span>
<span class="sd">                    approximately the same total I/O time (assuming you eventually use most of</span>
<span class="sd">                    the image files referenced in the catalog), but it is spread over the</span>
<span class="sd">                    various calls to `getGalImage` and `getPSFImage`.  [default: False]</span>
<span class="sd">        logger:     An optional logger object to log progress. [default: None]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_opt_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;file_name&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;preload&#39;</span> <span class="p">:</span> <span class="nb">bool</span> <span class="p">}</span>

    <span class="c1"># _nobject_only is an intentionally undocumented kwarg that should be used only by</span>
    <span class="c1"># the config structure.  It indicates that all we care about is the nobjects parameter.</span>
    <span class="c1"># So skip any other calculations that might normally be necessary on construction.</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot specify both the sample and file_name.&quot;</span><span class="p">,</span>
                <span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">_parse_files_dirs</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fits</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cat</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobjects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="p">)</span> <span class="c1"># number of objects in the catalog</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;RealGalaxyCatalog </span><span class="si">%s</span><span class="s1"> has </span><span class="si">%d</span><span class="s1"> objects&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nobjects</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_preload</span> <span class="o">=</span> <span class="n">preload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_noise_im</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># The pyfits commands aren&#39;t thread safe.  So we need to make sure the methods that</span>
        <span class="c1"># use pyfits are not run concurrently from multiple threads.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>  <span class="c1"># Use this when accessing gal files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>  <span class="c1"># Use this when accessing psf files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>  <span class="c1"># Use this when opening new files from disk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>  <span class="c1"># Use this for building the noise image(s) (usually just one)</span>


    <span class="c1"># Some lazy properties that we set up the first time they are used.</span>
    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">ident</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;ident&#39;</span><span class="p">)</span> <span class="c1"># ID for object in the training sample</span>
        <span class="c1"># We want to make sure that the ident array contains all strings.</span>
        <span class="c1"># Strangely, ident.astype(str) produces a string with each element == &#39;1&#39;.</span>
        <span class="c1"># Hence this way of doing the conversion:</span>
        <span class="k">return</span> <span class="p">[</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">ident</span> <span class="p">]</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">gal_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gal_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;gal_filename&#39;</span><span class="p">)</span> <span class="c1"># file containing the galaxy image</span>
        <span class="c1"># Add the directories:</span>
        <span class="c1"># Note the strip call.  Sometimes the filenames have an extra space at the end.</span>
        <span class="c1"># This gets rid of that space.</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">gal_file_name</span><span class="p">]</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">psf_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">psf_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;PSF_filename&#39;</span><span class="p">)</span> <span class="c1"># file containing the PSF image</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">psf_file_name</span><span class="p">]</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">noise_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We don&#39;t require the noise_filename column.  If it is not present, we will use</span>
        <span class="c1"># Uncorrelated noise based on the variance column.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">noise_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;noise_filename&#39;</span><span class="p">)</span> <span class="c1"># file containing the noise cf</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">noise_file_name</span><span class="p">]</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">gal_hdu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;gal_hdu&#39;</span><span class="p">)</span> <span class="c1"># HDU containing the galaxy image</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">psf_hdu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;PSF_hdu&#39;</span><span class="p">)</span> <span class="c1"># HDU containing the PSF image</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">pixel_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;pixel_scale&#39;</span><span class="p">)</span> <span class="c1"># pixel scale for image (could be different</span>
        <span class="c1"># if we have training data from other datasets... let&#39;s be general here and make it a</span>
        <span class="c1"># vector in case of mixed training set)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;noise_variance&#39;</span><span class="p">)</span> <span class="c1"># noise variance for image</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">mag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;mag&#39;</span><span class="p">)</span>   <span class="c1"># apparent magnitude</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">band</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;band&#39;</span><span class="p">)</span> <span class="c1"># bandpass in which apparent mag is measured, e.g., F814W</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The weight factor should be a float value &gt;=0 (so that random selections of indices can</span>
        <span class="c1"># use it to remove any selection effects in the catalog creation process).</span>
        <span class="c1"># Here we renormalize by the maximum weight.  If the maximum is below 1, that just means</span>
        <span class="c1"># that all galaxies were subsampled at some level, and here we only want to account for</span>
        <span class="c1"># relative selection effects within the catalog, not absolute subsampling.  If the maximum</span>
        <span class="c1"># is above 1, then our random number generation test used to draw a weighted sample will</span>
        <span class="c1"># fail since we use uniform deviates in the range 0 to 1.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;You still have the old COSMOS catalog.  Run the program &quot;</span>
                          <span class="s2">&quot;`galsim_download_cosmos -s </span><span class="si">%s</span><span class="s2">` to upgrade.&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">weight</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">stamp_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;stamp_flux&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;You still have the old COSMOS catalog.  Run the program &quot;</span>
                          <span class="s2">&quot;`galsim_download_cosmos -s </span><span class="si">%s</span><span class="s2">` to upgrade.&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Make sure to clean up pyfits open files if people forget to call close()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Need to close any open files.</span>
        <span class="c1"># Make sure to check if loaded_files exists, since the constructor could abort</span>
        <span class="c1"># before it gets to the place where loaded_files is built.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;loaded_files&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">getNObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobjects</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobjects</span>
    <span class="k">def</span> <span class="nf">getFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span>

<div class="viewcode-block" id="RealGalaxyCatalog.getIndexForID"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxyCatalog.getIndexForID">[docs]</a>    <span class="k">def</span> <span class="nf">getIndexForID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal function to find which index number corresponds to the value ID in the ident</span>
<span class="sd">        field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Just to be completely consistent, convert id to a string in the same way we</span>
        <span class="c1"># did above for the ident array:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">id</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ident</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ident</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimValueError</span><span class="p">(</span><span class="s1">&#39;ID not found in list of IDs&#39;</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ident</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_maybe_preload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Preload all files if desired.</span>
        <span class="c1"># This is delayed until the first time we might need it, since we might only need</span>
        <span class="c1"># to know nobjects and not load the data at all.  The first time we try to do something</span>
        <span class="c1"># that needs the files, we&#39;ll call preload (if requested).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_preload</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Once we&#39;ve loaded them.  Don&#39;t do it again.</span>

<div class="viewcode-block" id="RealGalaxyCatalog.preload"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxyCatalog.preload">[docs]</a>    <span class="k">def</span> <span class="nf">preload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Preload the files into memory.</span>

<span class="sd">        There are memory implications to this, so we don&#39;t do this by default.  However, it can be</span>
<span class="sd">        a big speedup if memory isn&#39;t an issue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gal_file_name</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_file_name</span><span class="p">)):</span>
                <span class="c1"># numpy sometimes add a space at the end of the string that is not present in</span>
                <span class="c1"># the original file.  Stupid.  But this next line removes it.</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">file_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span><span class="p">:</span>
                    <span class="c1"># I use memmap=False, because I was getting problems with running out of</span>
                    <span class="c1"># file handles in the great3 real_gal run, which uses a lot of rgc files.</span>
                    <span class="c1"># I think there must be a bug in pyfits that leaves file handles open somewhere</span>
                    <span class="c1"># when memmap = True.  Anyway, I don&#39;t know what the performance implications</span>
                    <span class="c1"># are (since I couldn&#39;t finish the run with the default memmap=True), but I</span>
                    <span class="c1"># don&#39;t think there is much impact either way with memory mapping in our case.</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
                    <span class="c1"># Access all the data from all hdus to force PyFits to read the data</span>
                    <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">hdu</span><span class="o">.</span><span class="n">data</span></div>

    <span class="k">def</span> <span class="nf">_getFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_preload</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_lock</span><span class="p">:</span>
                <span class="c1"># Check again in case two processes both hit the else at the same time.</span>
                <span class="k">if</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loaded_files</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
        <span class="k">return</span> <span class="n">f</span>

<div class="viewcode-block" id="RealGalaxyCatalog.getBandpass"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxyCatalog.getBandpass">[docs]</a>    <span class="k">def</span> <span class="nf">getBandpass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a `Bandpass` object for the catalog.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="n">real_galaxy_bandpasses</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimValueError</span><span class="p">(</span><span class="s2">&quot;Bandpass not found.  To use this bandpass, please add an entry &quot;</span>
                                   <span class="s2">&quot;to the galsim.real.real_galaxy_bandpasses dictionary.&quot;</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">real_galaxy_bandpasses</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">Bandpass</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wave_type</span><span class="o">=</span><span class="s1">&#39;nm&#39;</span><span class="p">,</span> <span class="n">zeropoint</span><span class="o">=</span><span class="n">bp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="RealGalaxyCatalog.getGalImage"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxyCatalog.getGalImage">[docs]</a>    <span class="k">def</span> <span class="nf">getGalImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the galaxy at index ``i`` as an `Image` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gal_file_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GalSimIndexError</span><span class="p">(</span><span class="s1">&#39;index out of range (0..</span><span class="si">%d</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gal_file_name</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">i</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gal_file_name</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_lock</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gal_hdu</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_scale</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">im</span></div>

<div class="viewcode-block" id="RealGalaxyCatalog.getPSFImage"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxyCatalog.getPSFImage">[docs]</a>    <span class="k">def</span> <span class="nf">getPSFImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the PSF at index ``i`` as an `Image` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_file_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GalSimIndexError</span><span class="p">(</span><span class="s1">&#39;index out of range (0..</span><span class="si">%d</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_file_name</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">i</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_file_name</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_lock</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_hdu</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_scale</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

<div class="viewcode-block" id="RealGalaxyCatalog.getPSF"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxyCatalog.getPSF">[docs]</a>    <span class="k">def</span> <span class="nf">getPSF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x_interpolant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k_interpolant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the PSF at index ``i`` as a `GSObject`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">psf_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPSFImage</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">InterpolatedImage</span><span class="p">(</span><span class="n">psf_image</span><span class="p">,</span>
                                 <span class="n">x_interpolant</span><span class="o">=</span><span class="n">x_interpolant</span><span class="p">,</span> <span class="n">k_interpolant</span><span class="o">=</span><span class="n">k_interpolant</span><span class="p">,</span>
                                 <span class="n">flux</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">)</span></div>

<div class="viewcode-block" id="RealGalaxyCatalog.getNoiseProperties"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxyCatalog.getNoiseProperties">[docs]</a>    <span class="k">def</span> <span class="nf">getNoiseProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the components needed to make the noise correlation function at index ``i``.</span>
<span class="sd">           Specifically, the noise image (or None), the pixel_scale, and the noise variance,</span>
<span class="sd">           as a tuple (im, scale, var).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_file_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">GalSimIndexError</span><span class="p">(</span><span class="s1">&#39;index out of range (0..</span><span class="si">%d</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_file_name</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_file_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_noise_im</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_noise_im</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_file_name</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_lock</span><span class="p">:</span>
                    <span class="c1"># Again, a second check in case two processes get here at the same time.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_file_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_noise_im</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_noise_im</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_file_name</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_file_name</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">as</span> <span class="n">fits</span><span class="p">:</span>
                            <span class="n">array</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span>
                                        <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_scale</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">saved_noise_im</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_file_name</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">im</span>

        <span class="k">return</span> <span class="n">im</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_scale</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="RealGalaxyCatalog.getNoise"><a class="viewcode-back" href="../../real_gal.html#galsim.RealGalaxyCatalog.getNoise">[docs]</a>    <span class="k">def</span> <span class="nf">getNoise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the noise correlation function at index ``i`` as a `BaseCorrelatedNoise` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">im</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNoiseProperties</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">im</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cf</span> <span class="o">=</span> <span class="n">UncorrelatedNoise</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">InterpolatedImage</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="s2">&quot;sb&quot;</span><span class="p">,</span>
                                          <span class="n">calculate_stepk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calculate_maxk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">x_interpolant</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">)</span>
            <span class="n">cf</span> <span class="o">=</span> <span class="n">BaseCorrelatedNoise</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
            <span class="n">cf</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">withVariance</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cf</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;galsim.RealGalaxyCatalog(</span><span class="si">%r</span><span class="s1">)&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">RealGalaxyCatalog</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">file_name</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">image_dir</span><span class="p">))</span>
    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;loaded_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;saved_noise_im&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;gal_lock&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;psf_lock&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;loaded_lock&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;noise_lock&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="k">pass</span></div>

<span class="k">def</span> <span class="nf">_parse_files_dirs</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">image_dir</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_sample</span> <span class="o">=</span> <span class="s1">&#39;25.2&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;25.2&#39;</span> <span class="ow">in</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">use_sample</span> <span class="o">=</span> <span class="s1">&#39;25.2&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;23.5&#39;</span> <span class="ow">in</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">use_sample</span> <span class="o">=</span> <span class="s1">&#39;23.5&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_sample</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">use_sample</span> <span class="o">=</span> <span class="n">sample</span>

    <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;real_galaxy_catalog_&#39;</span> <span class="o">+</span> <span class="n">use_sample</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="k">if</span> <span class="n">image_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_meta_dir</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Used to give a more helpful error message</span>
            <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_data</span><span class="o">.</span><span class="n">share_dir</span><span class="p">,</span>
                                     <span class="s1">&#39;COSMOS_&#39;</span><span class="o">+</span><span class="n">use_sample</span><span class="o">+</span><span class="s1">&#39;_training_sample&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_meta_dir</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">full_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_file_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">use_meta_dir</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_sample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;23.5&#39;</span><span class="p">,</span> <span class="s1">&#39;25.2&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">GalSimValueError</span><span class="p">(</span><span class="s2">&quot;Sample name not recognized.&quot;</span><span class="p">,</span><span class="n">use_sample</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;23.5&#39;</span><span class="p">,</span> <span class="s1">&#39;25.2&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;No RealGalaxy catalog found in </span><span class="si">%s</span><span class="s1">. Run the program &#39;</span>
                              <span class="s1">&#39;galsim_download_cosmos -s </span><span class="si">%s</span><span class="s1"> to download catalog and accompanying &#39;</span>
                              <span class="s1">&#39;image files.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">use_sample</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">image_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">full_file_name</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">full_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_file_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">full_file_name</span><span class="o">+</span><span class="s1">&#39; not found.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">full_file_name</span><span class="p">,</span> <span class="n">image_dir</span><span class="p">,</span> <span class="n">use_sample</span>


<div class="viewcode-block" id="ChromaticRealGalaxy"><a class="viewcode-back" href="../../chromaticobject.html#galsim.ChromaticRealGalaxy">[docs]</a><span class="k">class</span> <span class="nc">ChromaticRealGalaxy</span><span class="p">(</span><span class="n">ChromaticSum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class describing real galaxies over multiple wavelengths, using some multi-band training</span>
<span class="sd">    dataset.  The underlying implementation models multi-band images of individual galaxies</span>
<span class="sd">    as chromatic PSF convolutions (and integrations over wavelength) with a sum of profiles</span>
<span class="sd">    separable into spatial and spectral components.  The spectral components are specified by the</span>
<span class="sd">    user, and the spatial components are determined one Fourier mode at a time by the class.  This</span>
<span class="sd">    decomposition can be thought of as a constrained chromatic deconvolution of the multi-band</span>
<span class="sd">    images by the associated PSFs, similar in spirit to `RealGalaxy`.</span>

<span class="sd">    Because ChromaticRealGalaxy involves an `InterpolatedKImage`, ``method = &#39;phot&#39;`` is unavailable</span>
<span class="sd">    for the `ChromaticObject.drawImage` function.</span>

<span class="sd">    Fundamentally, the required inputs for this class are:</span>

<span class="sd">    (1) a series of high resolution input `Image` instances of a single galaxy in different bands,</span>
<span class="sd">    (2) a list of `Bandpass` corresponding to those images,</span>
<span class="sd">    (3) the PSFs of those images as either `GSObject` or `ChromaticObject` instances, and</span>
<span class="sd">    (4) the noise properties of the input images as `BaseCorrelatedNoise` instances.</span>

<span class="sd">    If you want to specify these inputs directly, that is possible via the `makeFromImages` factory</span>
<span class="sd">    method of this class::</span>

<span class="sd">        &gt;&gt;&gt; crg = galsim.ChromaticRealGalaxy.makeFromImages(imgs, bands, PSFs, xis, ...)</span>

<span class="sd">    Alternatively, you may create a ChromaticRealGalaxy via a list of `RealGalaxyCatalog` that</span>
<span class="sd">    correspond to a set of galaxies observed in different bands::</span>

<span class="sd">        &gt;&gt;&gt; crg = galsim.ChromaticRealGalaxy(real_galaxy_catalogs, index=0, ...)</span>

<span class="sd">    The above will use the 1st object in the catalogs, which should be the same galaxy, just</span>
<span class="sd">    observed in different bands.  Note that there are multiple keywords for choosing a galaxy from</span>
<span class="sd">    a catalog; exactly one must be set.  In the future we may add more such options, e.g., to</span>
<span class="sd">    choose at random but accounting for the non-constant weight factors (probabilities for</span>
<span class="sd">    objects to make it into the training sample).</span>

<span class="sd">    The flux normalization of the returned object will by default match the original data, scaled to</span>
<span class="sd">    correspond to a 1 second HST exposure (though see the ``area_norm`` parameter).  If you want</span>
<span class="sd">    a flux appropriate for a longer exposure or telescope with different collecting area, you can</span>
<span class="sd">    use the `ChromaticObject.withScaledFlux` method on the returned object, or use the ``exptime``</span>
<span class="sd">    and ``area`` keywords to `ChromaticObject.drawImage`.</span>

<span class="sd">    Note that while you can also use `ChromaticObject.withFlux`, `ChromaticObject.withMagnitude`,</span>
<span class="sd">    and `ChromaticObject.withFluxDensity` to set the absolute normalization, these methods</span>
<span class="sd">    technically adjust the flux of the entire postage stamp image (including noise!) and not</span>
<span class="sd">    necessarily the flux of the galaxy itself.  (These two fluxes will be strongly correlated for</span>
<span class="sd">    high signal-to-noise ratio galaxies, but may be considerably different at low signal-to-noise</span>
<span class="sd">    ratio.)</span>

<span class="sd">    Note that ChromaticRealGalaxy objects use arcsec for the units of their linear dimension.  If</span>
<span class="sd">    you are using a different unit for other things (the PSF, WCS, etc.), then you should dilate the</span>
<span class="sd">    resulting object with ``gal.dilate(galsim.arcsec / scale_unit)``.</span>

<span class="sd">    Noise from the original images is propagated by this class, though certain restrictions apply</span>
<span class="sd">    to when and how that noise is made available.  The propagated noise depends on which `Bandpass`</span>
<span class="sd">    the ChromaticRealGalaxy is being imaged through, so the noise is only available after the</span>
<span class="sd">    `ChromaticObject.drawImage` method has been called.  Also, since ChromaticRealGalaxy will</span>
<span class="sd">    only produce reasonable images when convolved with a (suitably wide) PSF, the noise attribute is</span>
<span class="sd">    attached to the `ChromaticConvolution` (or `ChromaticTransformation` of the</span>
<span class="sd">    `ChromaticConvolution`) which holds as one of its convolutants the `ChromaticRealGalaxy`.::</span>

<span class="sd">        &gt;&gt;&gt; crg = galsim.ChromaticRealGalaxy(...)</span>
<span class="sd">        &gt;&gt;&gt; psf = ...</span>
<span class="sd">        &gt;&gt;&gt; obj = galsim.Convolve(crg, psf)</span>
<span class="sd">        &gt;&gt;&gt; bandpass = galsim.Bandpass(...)</span>
<span class="sd">        &gt;&gt;&gt; assert not hasattr(obj, &#39;noise&#39;)</span>
<span class="sd">        &gt;&gt;&gt; image = obj.drawImage(bandpass)</span>
<span class="sd">        &gt;&gt;&gt; assert hasattr(obj, &#39;noise&#39;)</span>
<span class="sd">        &gt;&gt;&gt; noise1 = obj.noise</span>

<span class="sd">    Note that the noise attribute is only associated with the most recently used bandpass.  If you</span>
<span class="sd">    draw another image of the same object using a different bandpass, the noise object will be</span>
<span class="sd">    replaced.::</span>

<span class="sd">        &gt;&gt;&gt; bandpass2 = galsim.Bandpass(...)</span>
<span class="sd">        &gt;&gt;&gt; image2 = obj.drawImage(bandpass2)</span>
<span class="sd">        &gt;&gt;&gt; assert noise1 != obj.noise</span>

<span class="sd">    Parameters:</span>
<span class="sd">        real_galaxy_catalogs:   A list of `RealGalaxyCatalog` objects from which to create</span>
<span class="sd">                                `ChromaticRealGalaxy` objects.  Each catalog should represent the</span>
<span class="sd">                                same set of galaxies, and in the same order, just imaged through</span>
<span class="sd">                                different filters.</span>
<span class="sd">        index:                  Index of the desired galaxy in the catalog. [One of ``index``,</span>
<span class="sd">                                ``id``, or ``random`` is required.]</span>
<span class="sd">        id:                     Object ID for the desired galaxy in the catalog. [One of ``index``,</span>
<span class="sd">                                ``id``, or ``random`` is required.]</span>
<span class="sd">        random:                 If True, then just select a completely random galaxy from the</span>
<span class="sd">                                catalog.  [One of ``index``, ``id``, or ``random`` is required.]</span>
<span class="sd">        rng:                    A random number generator to use for selecting a random galaxy (may</span>
<span class="sd">                                be any kind of `BaseDeviate` or None) and to use in generating any</span>
<span class="sd">                                noise field when padding.</span>
<span class="sd">        SEDs:                   An optional list of `SED` instances to use when representing real</span>
<span class="sd">                                galaxies as sums of separable profiles.  By default, it will use</span>
<span class="sd">                                ``len(real_galaxy_catalogs)`` SEDs that are polynomials in</span>
<span class="sd">                                wavelength.  Note that if given, ``len(SEDs)`` must equal</span>
<span class="sd">                                ``len(real_galaxy_catalogs)``. [default: None]</span>
<span class="sd">        k_interpolant:          Either an `Interpolant` instance or a string indicating which</span>
<span class="sd">                                k-space interpolant should be used.  Options are &#39;nearest&#39;, &#39;sinc&#39;,</span>
<span class="sd">                                &#39;linear&#39;, &#39;cubic&#39;, &#39;quintic&#39;, or &#39;lanczosN&#39; where N should be the</span>
<span class="sd">                                integer order to use.  We strongly recommend leaving this parameter</span>
<span class="sd">                                at its default value; see text above for details.</span>
<span class="sd">                                [default: galsim.Quintic()]</span>
<span class="sd">        maxk:                   Optional maxk argument.  If you know you will be convolving the</span>
<span class="sd">                                resulting `ChromaticRealGalaxy` with a &quot;fat&quot; PSF in a subsequent</span>
<span class="sd">                                step, then it can be more efficient to limit the range of Fourier</span>
<span class="sd">                                modes used when solving for the sum of separable profiles below.</span>
<span class="sd">                                [default: None]</span>
<span class="sd">        pad_factor:             Factor by which to internally oversample the Fourier-space images</span>
<span class="sd">                                that represent the `ChromaticRealGalaxy` (equivalent to zero-padding</span>
<span class="sd">                                the real-space profiles).  We strongly recommend leaving this</span>
<span class="sd">                                parameter at its default value; see text in Realgalaxy docstring</span>
<span class="sd">                                for details.  [default: 4]</span>
<span class="sd">        noise_pad_size:         If provided, the image will be padded out to this size (in arcsec)</span>
<span class="sd">                                with the noise specified in the real galaxy catalog. This is</span>
<span class="sd">                                important if you are planning to whiten the resulting image.  You</span>
<span class="sd">                                should make sure that the padded image is larger than the postage</span>
<span class="sd">                                stamp onto which you are drawing this object.</span>
<span class="sd">                                [default: None]</span>
<span class="sd">        area_norm:              Area in cm^2 by which to normalize the flux of the returned object.</span>
<span class="sd">                                When area_norm=1 (the default), using ``exptime=1`` and ``area=1``</span>
<span class="sd">                                arguments in `ChromaticObject.drawImage` (also the default) will</span>
<span class="sd">                                simulate an image with the appropriate number of counts for a 1</span>
<span class="sd">                                second exposure with the original telescope/camera (e.g., with HST</span>
<span class="sd">                                when using the COSMOS catalog).</span>
<span class="sd">                                If you would rather explicitly specify the collecting area of the</span>
<span class="sd">                                telescope when using `ChromaticObject.drawImage` with a</span>
<span class="sd">                                `ChromaticRealGalaxy`, then you should set area_norm equal to the</span>
<span class="sd">                                collecting area of the source catalog telescope when creating the</span>
<span class="sd">                                `ChromaticRealGalaxy` (e.g., area_norm=45238.93416 for HST).</span>
<span class="sd">                                [default: 1]</span>
<span class="sd">        gsparams:               An optional `GSParams` argument. [default: None]</span>
<span class="sd">        logger:                 A logger object for output of progress statements if the user wants</span>
<span class="sd">                                them.  [default: None]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: SEDs isn&#39;t implemented yet in config parser.</span>
    <span class="n">_opt_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;k_interpolant&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">,</span>
                    <span class="s2">&quot;maxk&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s2">&quot;pad_factor&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s2">&quot;noise_pad_size&quot;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s2">&quot;area_norm&quot;</span> <span class="p">:</span> <span class="nb">float</span>
                  <span class="p">}</span>
    <span class="n">_single_params</span> <span class="o">=</span> <span class="p">[</span> <span class="p">{</span> <span class="s2">&quot;index&quot;</span> <span class="p">:</span> <span class="nb">int</span> <span class="p">,</span> <span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="nb">str</span> <span class="p">,</span> <span class="s2">&quot;random&quot;</span> <span class="p">:</span> <span class="nb">bool</span> <span class="p">}</span> <span class="p">]</span>
    <span class="n">_takes_rng</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">real_galaxy_catalogs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">gsparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">BaseDeviate</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">BaseDeviate</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The rng provided to ChromaticRealGalaxy is not a BaseDeviate&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>  <span class="c1"># So don&#39;t need to check `if logger:` all the time.</span>

        <span class="c1"># Get the index to use in the catalog</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">random</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Too many methods for selecting a galaxy.&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">)</span>
            <span class="n">use_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">elif</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">random</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Too many methods for selecting a galaxy.&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">)</span>
            <span class="n">use_index</span> <span class="o">=</span> <span class="n">real_galaxy_catalogs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getIndexForID</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">random</span><span class="p">:</span>
            <span class="n">uniform_deviate</span> <span class="o">=</span> <span class="n">UniformDeviate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
            <span class="n">use_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">real_galaxy_catalogs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nobjects</span> <span class="o">*</span> <span class="n">uniform_deviate</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                <span class="s2">&quot;No method specified for selecting a galaxy.&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ChromaticRealGalaxy </span><span class="si">%d</span><span class="s1">: Start ChromaticRealGalaxy constructor.&#39;</span><span class="p">,</span> <span class="n">use_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">use_index</span>

        <span class="c1"># Read in the galaxy, PSF images; for now, rely on pyfits to make I/O errors.</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">rgc</span><span class="o">.</span><span class="n">getGalImage</span><span class="p">(</span><span class="n">use_index</span><span class="p">)</span> <span class="k">for</span> <span class="n">rgc</span> <span class="ow">in</span> <span class="n">real_galaxy_catalogs</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ChromaticRealGalaxy </span><span class="si">%d</span><span class="s1">: Got gal_image&#39;</span><span class="p">,</span> <span class="n">use_index</span><span class="p">)</span>

        <span class="n">PSFs</span> <span class="o">=</span> <span class="p">[</span><span class="n">rgc</span><span class="o">.</span><span class="n">getPSF</span><span class="p">(</span><span class="n">use_index</span><span class="p">)</span> <span class="k">for</span> <span class="n">rgc</span> <span class="ow">in</span> <span class="n">real_galaxy_catalogs</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ChromaticRealGalaxy </span><span class="si">%d</span><span class="s1">: Got psf&#39;</span><span class="p">,</span> <span class="n">use_index</span><span class="p">)</span>

        <span class="n">bands</span> <span class="o">=</span> <span class="p">[</span><span class="n">rgc</span><span class="o">.</span><span class="n">getBandpass</span><span class="p">()</span> <span class="k">for</span> <span class="n">rgc</span> <span class="ow">in</span> <span class="n">real_galaxy_catalogs</span><span class="p">]</span>

        <span class="n">xis</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rgc</span> <span class="ow">in</span> <span class="n">real_galaxy_catalogs</span><span class="p">:</span>
            <span class="n">noise_image</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">rgc</span><span class="o">.</span><span class="n">getNoiseProperties</span><span class="p">(</span><span class="n">use_index</span><span class="p">)</span>
            <span class="c1"># Make sure xi image is odd-sized.</span>
            <span class="k">if</span> <span class="n">noise_image</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#pragma: no branch</span>
                <span class="n">bds</span> <span class="o">=</span> <span class="n">noise_image</span><span class="o">.</span><span class="n">bounds</span>
                <span class="n">new_bds</span> <span class="o">=</span> <span class="n">BoundsI</span><span class="p">(</span><span class="n">bds</span><span class="o">.</span><span class="n">xmin</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bds</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="n">bds</span><span class="o">.</span><span class="n">ymin</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bds</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>
                <span class="n">noise_image</span> <span class="o">=</span> <span class="n">noise_image</span><span class="p">[</span><span class="n">new_bds</span><span class="p">]</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">InterpolatedImage</span><span class="p">(</span><span class="n">noise_image</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span>
                                   <span class="n">calculate_stepk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calculate_maxk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">x_interpolant</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">)</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">BaseCorrelatedNoise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">noise_image</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">xi</span><span class="o">.</span><span class="n">withVariance</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="n">xis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ChromaticRealGalaxy </span><span class="si">%d</span><span class="s1">: Got noise_image&#39;</span><span class="p">,</span><span class="n">use_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">rgc</span><span class="o">.</span><span class="n">getFileName</span><span class="p">()</span> <span class="k">for</span> <span class="n">rgc</span> <span class="ow">in</span> <span class="n">real_galaxy_catalogs</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">xis</span><span class="p">,</span> <span class="n">PSFs</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ChromaticRealGalaxy.makeFromImages"><a class="viewcode-back" href="../../chromaticobject.html#galsim.ChromaticRealGalaxy.makeFromImages">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">makeFromImages</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">PSFs</span><span class="p">,</span> <span class="n">xis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a `ChromaticRealGalaxy` directly from images, bandpasses, PSFs, and noise</span>
<span class="sd">        descriptions.  See the `ChromaticRealGalaxy` docstring for more information.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            images:             An iterable of high resolution `Image` instances of a galaxy</span>
<span class="sd">                                through different bandpasses.</span>
<span class="sd">            bands:              An iterable of `Bandpass` objects corresponding to the  input</span>
<span class="sd">                                images.</span>
<span class="sd">            PSFs:               Either an iterable of `GSObject` or `ChromaticObject` indicating</span>
<span class="sd">                                the PSFs of the different input images, or potentially a single</span>
<span class="sd">                                `GSObject` or `ChromaticObject` that will be used as the PSF for</span>
<span class="sd">                                all images.</span>
<span class="sd">            xis:                An iterable of `BaseCorrelatedNoise` objects characterizing the</span>
<span class="sd">                                noise in the input images.</span>
<span class="sd">            SEDs:               An optional list of `SED` instances to use when representing real</span>
<span class="sd">                                galaxies as sums of separable profiles.  By default, it will use</span>
<span class="sd">                                ``len(images)`` SEDs that are polynomials in wavelength.  Note that</span>
<span class="sd">                                if given, ``len(SEDs)`` must equal ``len(images)``. [default: None]</span>
<span class="sd">            k_interpolant:      Either an `Interpolant` instance or a string indicating which</span>
<span class="sd">                                k-space interpolant should be used.  Options are &#39;nearest&#39;, &#39;sinc&#39;,</span>
<span class="sd">                                &#39;linear&#39;, &#39;cubic&#39;, &#39;quintic&#39;, or &#39;lanczosN&#39; where N should be the</span>
<span class="sd">                                integer order to use.  We strongly recommend leaving this parameter</span>
<span class="sd">                                at its default value; see text above for details.  [default:</span>
<span class="sd">                                galsim.Quintic()]</span>
<span class="sd">            maxk:               Optional maxk argument.  If you know you will be convolving the</span>
<span class="sd">                                resulting `ChromaticRealGalaxy` with a &quot;fat&quot; PSF in a subsequent</span>
<span class="sd">                                step, then it can be more efficient to limit the range of Fourier</span>
<span class="sd">                                modes used when solving for the sum of separable profiles below.</span>
<span class="sd">                                [default: None]</span>
<span class="sd">            pad_factor:         Factor by which to internally oversample the Fourier-space images</span>
<span class="sd">                                that represent the `ChromaticRealGalaxy` (equivalent to zero-padding</span>
<span class="sd">                                the real-space profiles).  We strongly recommend leaving this</span>
<span class="sd">                                parameter at its default value; see text in Realgalaxy docstring</span>
<span class="sd">                                for details.  [default: 4]</span>
<span class="sd">            noise_pad_size:     If provided, the image will be padded out to this size (in arcsec)</span>
<span class="sd">                                with the noise specified in the real galaxy catalog. This is</span>
<span class="sd">                                important if you are planning to whiten the resulting image.  You</span>
<span class="sd">                                should make sure that the padded image is larger than the postage</span>
<span class="sd">                                stamp onto which you are drawing this object.</span>
<span class="sd">                                [default: None]</span>
<span class="sd">            area_norm:          Area in cm^2 by which to normalize the flux of the returned object.</span>
<span class="sd">                                When area_norm=1 (the default), using ``exptime=1`` and ``area=1``</span>
<span class="sd">                                arguments in `ChromaticObject.drawImage` (also the default) will</span>
<span class="sd">                                simulate an image with the appropriate number of counts for a 1</span>
<span class="sd">                                second exposure with the original telescope/camera (e.g., with HST</span>
<span class="sd">                                when using the COSMOS catalog).</span>
<span class="sd">                                If you would rather explicitly specify the collecting area of the</span>
<span class="sd">                                telescope when using `ChromaticObject.drawImage` with a</span>
<span class="sd">                                `ChromaticRealGalaxy`, then you should set area_norm equal to the</span>
<span class="sd">                                collecting area of the source catalog telescope when creating the</span>
<span class="sd">                                `ChromaticRealGalaxy` (e.g., area_norm=45238.93416 for HST).</span>
<span class="sd">                                [default: 1]</span>
<span class="sd">            gsparams:           An optional `GSParams` argument. [default: None]</span>
<span class="sd">            logger:             A logger object for output of progress statements if the user wants</span>
<span class="sd">                                them.  [default: None]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">PSFs</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="n">PSFs</span> <span class="o">=</span> <span class="p">[</span><span class="n">PSFs</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">catalog_files</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;rng&#39;</span><span class="p">,</span> <span class="n">BaseDeviate</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xis</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">PSFs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                <span class="s2">&quot;The number of images, bands, xis, and PSFs must match.&quot;</span><span class="p">,</span>
                <span class="n">images</span><span class="o">=</span><span class="n">images</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="n">bands</span><span class="p">,</span> <span class="n">xis</span><span class="o">=</span><span class="n">xis</span><span class="p">,</span> <span class="n">PSFs</span><span class="o">=</span><span class="n">PSFs</span><span class="p">)</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">xis</span><span class="p">,</span> <span class="n">PSFs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>

    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">xis</span><span class="p">,</span> <span class="n">PSFs</span><span class="p">,</span>
                    <span class="n">SEDs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k_interpolant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pad_factor</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span> <span class="n">area_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">noise_pad_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">SEDs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">SEDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poly_SEDs</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">SEDs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                <span class="s2">&quot;The number of SEDs must be &lt;= the number of images&quot;</span><span class="p">,</span>
                <span class="n">images</span><span class="o">=</span><span class="n">imgs</span><span class="p">,</span> <span class="n">SEDs</span><span class="o">=</span><span class="n">SEDs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SEDs</span> <span class="o">=</span> <span class="n">SEDs</span>

        <span class="k">if</span> <span class="n">k_interpolant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k_interpolant</span> <span class="o">=</span> <span class="n">Quintic</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_interpolant</span> <span class="o">=</span> <span class="n">convert_interpolant</span><span class="p">(</span><span class="n">k_interpolant</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_area_norm</span> <span class="o">=</span> <span class="n">area_norm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_k_interpolant</span> <span class="o">=</span> <span class="n">k_interpolant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span> <span class="o">=</span> <span class="n">GSParams</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">gsparams</span><span class="p">)</span>

        <span class="n">NSED</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SEDs</span><span class="p">)</span>
        <span class="n">Nim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
        <span class="c1">#assert Nim == len(bands)</span>
        <span class="c1">#assert Nim == len(xis)</span>
        <span class="c1">#assert Nim == len(PSFs)</span>
        <span class="c1">#assert Nim &gt;= NSED</span>

        <span class="k">if</span> <span class="n">area_norm</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span><span class="o">/</span><span class="n">area_norm</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">]</span>
            <span class="n">xis</span> <span class="o">=</span> <span class="p">[</span><span class="n">xi</span><span class="o">/</span><span class="n">area_norm</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">xis</span><span class="p">]</span>

        <span class="c1"># Need to sample three different types of objects on the same Fourier grid: the input</span>
        <span class="c1"># effective PSFs, the input images, and the input correlation-functions/power-spectra.</span>
        <span class="c1"># There are quite a few potential options for implementing this Fourier sampling.  Some</span>
        <span class="c1"># examples include:</span>
        <span class="c1">#   * draw object in real space, interpolate onto the real-space grid conjugate to the</span>
        <span class="c1">#     desired Fourier-space grid and then DFT with numpy.fft methods.</span>
        <span class="c1">#   * Use numpy.fft methods on pre-sampled real-space input (like the input images), then</span>
        <span class="c1">#     use an InterpolatedKImage object to regrid onto desired Fourier grid.</span>
        <span class="c1">#   * Create an InterpolatedImage from pre-sampled input then use drawKImage to directly</span>
        <span class="c1">#     sample on desired Fourier grid.</span>
        <span class="c1"># I&#39;m sure there are other options too.  The options chosen below were chosen empirically</span>
        <span class="c1"># based on tests of propagating both (chromatic) galaxy images and images of pure noise.</span>

        <span class="c1"># Select maxk by requiring modes to be resolved both by the marginal PSFs (i.e., the</span>
        <span class="c1"># achromatic PSFs obtained by evaluating the chromatic PSF at the blue and red edges of</span>
        <span class="c1"># each of the filters provided) and also by the input images&#39; pixel scales.</span>

        <span class="n">img_maxk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">img</span><span class="o">.</span><span class="n">scale</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">])</span>
        <span class="n">marginal_PSFs</span> <span class="o">=</span> <span class="p">[</span><span class="n">PSF</span><span class="o">.</span><span class="n">evaluateAtWavelength</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">blue_limit</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">PSF</span> <span class="ow">in</span> <span class="n">PSFs</span> <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">]</span>
        <span class="n">marginal_PSFs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">PSF</span><span class="o">.</span><span class="n">evaluateAtWavelength</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">red_limit</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">PSF</span> <span class="ow">in</span> <span class="n">PSFs</span> <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">]</span>
        <span class="n">psf_maxk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">maxk</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">marginal_PSFs</span><span class="p">])</span>

        <span class="c1"># In practice, the output PSF should almost always cut off at smaller maxk than obtained</span>
        <span class="c1"># above.  In this case, the user can set the maxk keyword argument for improved efficiency.</span>
        <span class="k">if</span> <span class="n">maxk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maxk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">img_maxk</span><span class="p">,</span> <span class="n">psf_maxk</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">img_maxk</span><span class="p">,</span> <span class="n">psf_maxk</span><span class="p">,</span> <span class="n">maxk</span><span class="p">])</span>

        <span class="c1"># Setting stepk is trickier.  We&#39;ll assume that the postage stamp inputs are already at the</span>
        <span class="c1"># critical size to avoid significant aliasing and use the implied stepk.  We&#39;ll insist that</span>
        <span class="c1"># the WCS is a simple PixelScale.  We&#39;ll also use the same trick that InterpolatedImage</span>
        <span class="c1"># uses to improve accuracy, namely, increase the Fourier-space resolution a factor of</span>
        <span class="c1"># `pad_factor`.</span>
        <span class="n">stepk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">/</span><span class="n">pad_factor</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">])</span>
        <span class="n">nk</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">maxk</span><span class="o">/</span><span class="n">stepk</span><span class="p">))</span>

        <span class="c1"># Create Fourier-space kimages of effective PSFs</span>
        <span class="n">PSF_eff_kimgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nim</span><span class="p">,</span> <span class="n">NSED</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">PSF</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">PSFs</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SEDs</span><span class="p">):</span>
                <span class="c1"># assume that PSF already includes pixel, so don&#39;t convolve one in again.</span>
                <span class="n">PSF_eff_kimgs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSF</span> <span class="o">*</span> <span class="n">sed</span><span class="p">)</span><span class="o">.</span><span class="n">drawKImage</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nk</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">nk</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">stepk</span><span class="p">)</span><span class="o">.</span><span class="n">array</span>

        <span class="c1"># Get Fourier-space representations of input imgs.</span>
        <span class="n">kimgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nim</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">noise_pad_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">noise_pad</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">xis</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">noise_pad_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">noise_pad</span> <span class="o">=</span> <span class="n">xi</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">InterpolatedImage</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">noise_pad_size</span><span class="o">=</span><span class="n">noise_pad_size</span><span class="p">,</span> <span class="n">noise_pad</span><span class="o">=</span><span class="n">noise_pad</span><span class="p">,</span>
                                   <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">pad_factor</span><span class="o">=</span><span class="n">pad_factor</span><span class="p">)</span>
            <span class="n">kimgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="n">drawKImage</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="n">nk</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">nk</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">stepk</span><span class="p">)</span><span class="o">.</span><span class="n">array</span>

        <span class="c1"># Setup input noise power spectra</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nim</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">xis</span><span class="p">)):</span>
            <span class="n">pks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi</span><span class="o">.</span><span class="n">drawKImage</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="n">nk</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">nk</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">stepk</span><span class="p">)</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">real</span> <span class="o">/</span> <span class="n">xi</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">pixelArea</span><span class="p">()</span>
            <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">pks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pks</span><span class="p">)</span>

        <span class="c1"># Allocate and fill output coefficients and covariances.</span>
        <span class="c1"># Note: put NSED axis last, since significantly faster to compute them this way,</span>
        <span class="c1"># even though we eventually convert to images which are strided in this format.</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">NSED</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="n">Sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">NSED</span><span class="p">,</span> <span class="n">NSED</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

        <span class="c1"># Solve the weighted linear least squares problem for each Fourier mode.  This is</span>
        <span class="c1"># effectively a constrained chromatic deconvolution.  Take advantage of symmetries.</span>
        <span class="n">_coef</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_Sigma</span> <span class="o">=</span> <span class="n">Sigma</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_kimgs</span> <span class="o">=</span> <span class="n">kimgs</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_psf</span> <span class="o">=</span> <span class="n">PSF_eff_kimgs</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_galsim</span><span class="o">.</span><span class="n">ComputeCRGCoefficients</span><span class="p">(</span><span class="n">_coef</span><span class="p">,</span> <span class="n">_Sigma</span><span class="p">,</span> <span class="n">_w</span><span class="p">,</span> <span class="n">_kimgs</span><span class="p">,</span> <span class="n">_psf</span><span class="p">,</span> <span class="n">NSED</span><span class="p">,</span> <span class="n">Nim</span><span class="p">,</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nk</span><span class="p">)</span>

        <span class="c1"># Reorder these so they correspond to (NSED, nky, nkx) and (NSED, NSED, nky, nkx) shapes.</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">Sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Sigma</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Set up obj_list as required of ChromaticSum subclass.</span>
        <span class="n">obj_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SEDs</span><span class="p">):</span>
            <span class="n">obj_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sed</span> <span class="o">*</span> <span class="n">_InterpolatedKImage</span><span class="p">(</span>
                    <span class="n">ImageCD</span><span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">stepk</span><span class="p">),</span>
                    <span class="n">k_interpolant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_k_interpolant</span><span class="p">,</span>
                    <span class="n">gsparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">))</span>

        <span class="n">Sigma_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NSED</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">NSED</span><span class="p">):</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">_InterpolatedKImage</span><span class="p">(</span>
                        <span class="n">ImageCD</span><span class="p">(</span><span class="n">Sigma</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">stepk</span><span class="p">),</span>
                        <span class="n">k_interpolant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_k_interpolant</span><span class="p">,</span>
                        <span class="n">gsparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">/=</span> <span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">Sigma_dict</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">covspec</span> <span class="o">=</span> <span class="n">CovarianceSpectrum</span><span class="p">(</span><span class="n">Sigma_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SEDs</span><span class="p">)</span>

        <span class="n">ChromaticSum</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_list</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_poly_SEDs</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>
        <span class="c1"># Use polynomial SEDs by default; up to the number of bands provided.</span>
        <span class="n">waves</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
            <span class="n">waves</span> <span class="o">=</span> <span class="n">merge_sorted</span><span class="p">([</span><span class="n">waves</span><span class="p">,</span> <span class="n">bp</span><span class="o">.</span><span class="n">wave_list</span><span class="p">])</span>
        <span class="n">SEDs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)):</span>
            <span class="n">SEDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">SED</span><span class="p">(</span><span class="n">LookupTable</span><span class="p">(</span><span class="n">waves</span><span class="p">,</span> <span class="n">waves</span><span class="o">**</span><span class="n">i</span><span class="p">,</span> <span class="n">interpolant</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">),</span> <span class="s1">&#39;nm&#39;</span><span class="p">,</span> <span class="s1">&#39;fphotons&#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">withFlux</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">SEDs</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ChromaticRealGalaxy</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">catalog_files</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">catalog_files</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">SEDs</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">SEDs</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_k_interpolant</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_k_interpolant</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_area_norm</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_area_norm</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">))</span>
    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="s2">&quot;galsim.ChromaticRealGalaxy&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog_files</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                     <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SEDs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_k_interpolant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_area_norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;galsim.ChromaticRealGalaxy(</span><span class="si">%r</span><span class="s2">, index=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog_files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;galsim.ChromaticRealGalaxy(</span><span class="si">%r</span><span class="s2">, SEDs=</span><span class="si">%r</span><span class="s2">, index=</span><span class="si">%r</span><span class="s2">, k_interpolant=</span><span class="si">%r</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;area_norm=</span><span class="si">%r</span><span class="s2">, gsparams=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog_files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SEDs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_k_interpolant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_area_norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsparams</span><span class="p">))</span></div>

<span class="c1"># Put this at the bottom to avoid circular import error.</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">LoggerWrapper</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, GalSim-developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>