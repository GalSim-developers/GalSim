<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>galsim.galaxy_sample &mdash; GalSim 2.4.3 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> GalSim
          </a>
              <div class="version">
                2.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../image.html">Images and Related Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sb.html">Surface Brightness Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chromatic.html">Wavelength-dependent Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wcs.html">World Coordinate Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../random.html">Noise and Random Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wl.html">Weak Lensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../photon.html">Photon Shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Helper Functions and Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../errors.html">Errors and Warnings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">The Config Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hsm.html">The HSM Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../des.html">The DES Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roman.html">The Roman Space Telescope Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpp.html">C++ Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared.html">Shared Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">Revision History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GalSim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>galsim.galaxy_sample</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for galsim.galaxy_sample</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2012-2022 by the GalSim developers team on GitHub</span>
<span class="c1"># https://github.com/GalSim-developers</span>
<span class="c1">#</span>
<span class="c1"># This file is part of GalSim: The modular galaxy image simulation toolkit.</span>
<span class="c1"># https://github.com/GalSim-developers/GalSim</span>
<span class="c1">#</span>
<span class="c1"># GalSim is free software: redistribution and use in source and binary forms,</span>
<span class="c1"># with or without modification, are permitted provided that the following</span>
<span class="c1"># conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#    list of conditions, and the disclaimer given in the accompanying LICENSE</span>
<span class="c1">#    file.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#    this list of conditions, and the disclaimer given in the documentation</span>
<span class="c1">#    and/or other materials provided with the distribution.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">.real</span> <span class="kn">import</span> <span class="n">RealGalaxy</span><span class="p">,</span> <span class="n">RealGalaxyCatalog</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="kn">import</span> <span class="n">GalSimError</span><span class="p">,</span> <span class="n">GalSimValueError</span><span class="p">,</span> <span class="n">GalSimIncompatibleValuesError</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="kn">import</span> <span class="n">GalSimNotImplementedError</span><span class="p">,</span> <span class="n">galsim_warn</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">lazy_property</span>

<span class="c1"># Below is a number that is needed to relate the COSMOS parametric galaxy fits to quantities that</span>
<span class="c1"># GalSim needs to make a GSObject representing that fit.  It is simply the pixel scale, in arcsec,</span>
<span class="c1"># in the COSMOS weak lensing reductions used for the fits.</span>
<span class="c1"># Note: This isn&#39;t used anywhere.  This is just informational, really.</span>
<span class="n">cosmos_pix_scale</span> <span class="o">=</span> <span class="mf">0.03</span>

<div class="viewcode-block" id="GalaxySample"><a class="viewcode-back" href="../../real_gal.html#galsim.GalaxySample">[docs]</a><span class="k">class</span> <span class="nc">GalaxySample</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class representing a random subsample of galaxies from an arbitrary deep survey.</span>

<span class="sd">    Depending on the keyword arguments, particularly ``use_real``, a `GalaxySample` may be able to</span>
<span class="sd">    generate real galaxies, parametric galaxies, or both.</span>

<span class="sd">    The original version of this functionality is now in the subclass `COSMOSCatalog`, which</span>
<span class="sd">    specializes to HST observations of the COSMOS field.  `GalaxySample` is a generalization of</span>
<span class="sd">    that, which works for arbitrary data sets, although the user is responsible for building</span>
<span class="sd">    the appropriate input files to use with it.</span>

<span class="sd">    Unlike `COSMOSCatalog`, which has easy options for picking out one of the two galaxy subsets</span>
<span class="sd">    that are available for download using ``galsim_download_cosmos``, for this class you need to</span>
<span class="sd">    manually specify the file name.</span>

<span class="sd">        &gt;&gt;&gt; sample = galsim.GalaxySample(file_name)</span>

<span class="sd">    Other than this difference, the functionality of this class is the same as `COSMOSCatalog`.</span>
<span class="sd">    See the documentation of that function for more detail.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        file_name:          The file containing the catalog.</span>
<span class="sd">        dir:                The directory with the catalog file and, if making realistic galaxies,</span>
<span class="sd">                            the image and noise files (or symlinks to them). [default: None, which</span>
<span class="sd">                            will look in $PREFIX/share/galsim.]</span>
<span class="sd">        preload:            Keyword that is only used for real galaxies, not parametric ones, to</span>
<span class="sd">                            choose whether to preload the header information.  If ``preload=True``,</span>
<span class="sd">                            the bulk of the I/O time is in the constructor.  If ``preload=False``,</span>
<span class="sd">                            there is approximately the same total I/O time (assuming you eventually</span>
<span class="sd">                            use most of the image files referenced in the catalog), but it is spread</span>
<span class="sd">                            over the calls to makeGalaxy().  [default: False]</span>
<span class="sd">        orig_exptime:       The exposure time (in seconds) of the original observations.</span>
<span class="sd">                            [default: 1]</span>
<span class="sd">        orig_area:          The effective collecting area (in cm^2) of the original observations.</span>
<span class="sd">                            [default: 1]</span>
<span class="sd">        use_real:           Enable the use of realistic galaxies?  [default: True]</span>
<span class="sd">                            If this parameter is False, then ``makeGalaxy(gal_type=&#39;real&#39;)`` will</span>
<span class="sd">                            not be allowed, and there will be a (modest) decrease in RAM and time</span>
<span class="sd">                            spent on I/O when initializing the COSMOSCatalog. If the real</span>
<span class="sd">                            catalog is not available for some reason, it will still be possible to</span>
<span class="sd">                            make parametric images.</span>
<span class="sd">        exclusion_level:    Level of additional cuts to make on the galaxies based on the quality</span>
<span class="sd">                            of postage stamp definition and/or parametric fit quality [beyond the</span>
<span class="sd">                            minimal cuts imposed when making the catalog - see Mandelbaum et</span>
<span class="sd">                            al. (2012, MNRAS, 420, 1518) for details].  Options:</span>

<span class="sd">                            - &quot;none&quot;: No cuts.</span>
<span class="sd">                            - &quot;bad_stamp&quot;: Apply cuts to eliminate galaxies that have failures in</span>
<span class="sd">                              postage stamp definition.  These cuts may also eliminate a small</span>
<span class="sd">                              subset of the good postage stamps as well.</span>
<span class="sd">                            - &quot;bad_fits&quot;: Apply cuts to eliminate galaxies that have failures in the</span>
<span class="sd">                              parametric fits.  These cuts may also eliminate a small</span>
<span class="sd">                              subset of the good parametric fits as well.</span>
<span class="sd">                            - &quot;marginal&quot;: Apply the above cuts, plus ones that eliminate some more</span>
<span class="sd">                              marginal cases.</span>

<span class="sd">                            Use of &quot;bad_stamp&quot; or &quot;marginal&quot; requires a ``CATALOG_selection.fits``</span>
<span class="sd">                            file (where CATALOG is ``file_name`` without the &quot;.fits&quot; extension).</span>
<span class="sd">                            [default: &quot;none&quot;]</span>
<span class="sd">        min_hlr:            Exclude galaxies whose fitted half-light radius is smaller than this</span>
<span class="sd">                            value (in arcsec).  [default: 0, meaning no limit]</span>
<span class="sd">        max_hlr:            Exclude galaxies whose fitted half-light radius is larger than this</span>
<span class="sd">                            value (in arcsec).  [default: 0, meaning no limit]</span>
<span class="sd">        min_flux:           Exclude galaxies whose fitted flux is smaller than this value.</span>
<span class="sd">                            [default: 0, meaning no limit]</span>
<span class="sd">        max_flux:           Exclude galaxies whose fitted flux is larger than this value.</span>
<span class="sd">                            [default: 0, meaning no limit]</span>
<span class="sd">        cut_ratio:          For the &quot;bad_stamp&quot; exclusions, cut out any stamps with average</span>
<span class="sd">                            adjacent pixels larger than this fraction of the peak pixel count.</span>
<span class="sd">                            [default: 0.8]</span>
<span class="sd">        sn_limit:           For the &quot;bad_stamp&quot; exclusions, cut out any stamps with estimated</span>
<span class="sd">                            S/N for an elliptical Gaussian less than this limit. [default: 10.]</span>
<span class="sd">        min_mask_dist:      For the &quot;bad_stamp&quot; exclusions, remove any stamps that have some</span>
<span class="sd">                            masked pixels closer to the center than this minimum distance</span>
<span class="sd">                            (in pixels). [default: 10]</span>
<span class="sd">        exptime:            The exposure time (in seconds) to assume when creating galaxies.</span>
<span class="sd">                            [default: None, which means to use orig_exptime]</span>
<span class="sd">        area:               The effective collecting area (in cm^2) to assume when creating</span>
<span class="sd">                            galaxies. [default: None, which means to use orig_area]</span>

<span class="sd">    After construction, the following attributes are available:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nobjects:       The number of objects in the sample</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_opt_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;file_name&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;orig_exptime&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;orig_area&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;preload&#39;</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="s1">&#39;use_real&#39;</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                    <span class="s1">&#39;exclusion_level&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;min_hlr&#39;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;max_hlr&#39;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;min_flux&#39;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;max_flux&#39;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;cut_ratio&#39;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;sn_limit&#39;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;min_mask_dist&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">orig_exptime</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">orig_area</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                 <span class="n">use_real</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclusion_level</span><span class="o">=</span><span class="s1">&#39;marginal&#39;</span><span class="p">,</span> <span class="n">min_hlr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_hlr</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                 <span class="n">min_flux</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">max_flux</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">cut_ratio</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">sn_limit</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">min_mask_dist</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
                 <span class="n">exptime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_use_sample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">._pyfits</span> <span class="kn">import</span> <span class="n">pyfits</span>
        <span class="kn">from</span> <span class="nn">.real</span> <span class="kn">import</span> <span class="n">_parse_files_dirs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_real</span> <span class="o">=</span> <span class="n">use_real</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut_ratio</span> <span class="o">=</span> <span class="n">cut_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sn_limit</span> <span class="o">=</span> <span class="n">sn_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_mask_dist</span> <span class="o">=</span> <span class="n">min_mask_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_exptime</span> <span class="o">=</span> <span class="n">orig_exptime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_area</span> <span class="o">=</span> <span class="n">orig_area</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exptime</span> <span class="o">=</span> <span class="n">exptime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">area</span>

        <span class="c1"># We&#39;ll set these up if and when we need them.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bandpass</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sed</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">exclusion_level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;bad_stamp&#39;</span><span class="p">,</span> <span class="s1">&#39;bad_fits&#39;</span><span class="p">,</span> <span class="s1">&#39;marginal&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GalSimValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value of exclusion_level.&quot;</span><span class="p">,</span> <span class="n">exclusion_level</span><span class="p">,</span>
                                   <span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;bad_stamp&#39;</span><span class="p">,</span> <span class="s1">&#39;bad_fits&#39;</span><span class="p">,</span> <span class="s1">&#39;marginal&#39;</span><span class="p">))</span>

        <span class="c1"># Parse the file name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_file_name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_parse_files_dirs</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_sample</span> <span class="o">=</span> <span class="n">_use_sample</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read in data.</span>
            <span class="k">with</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fits</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="c1"># Check if this was the right file.  It should have a &#39;fit_status&#39; column.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">[</span><span class="s1">&#39;fit_status&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># But if that doesn&#39;t work, then the name might be the name of the real catalog,</span>
            <span class="c1"># so try adding _fits to it as above.</span>
            <span class="n">param_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_fits.fits&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">param_file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fits</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># NB. The pyfits FITS_Rec class has a bug where it makes a copy of the full</span>
        <span class="c1"># record array in each record (e.g. in getParametricRecord) and then doesn&#39;t</span>
        <span class="c1"># garbage collect it until the top-level FITS_Record goes out of scope.</span>
        <span class="c1"># This leads to a memory leak of order 10MB or so each time we make a parametric</span>
        <span class="c1"># galaxy.</span>
        <span class="c1"># cf. https://mail.scipy.org/pipermail/astropy/2014-June/003218.html</span>
        <span class="c1"># also https://github.com/astropy/astropy/pull/520</span>
        <span class="c1"># The simplest workaround seems to be to convert it to a regular numpy recarray.</span>
        <span class="c1"># (This also makes it run much faster, as an extra bonus!)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orig_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_exclusion</span><span class="p">(</span><span class="n">exclusion_level</span><span class="p">,</span> <span class="n">min_hlr</span><span class="p">,</span> <span class="n">max_hlr</span><span class="p">,</span> <span class="n">min_flux</span><span class="p">,</span> <span class="n">max_flux</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">real_cat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_real</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RealGalaxyCatalog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_file_name</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_apply_exclusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclusion_level</span><span class="p">,</span> <span class="n">min_hlr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_hlr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_flux</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_flux</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">._pyfits</span> <span class="kn">import</span> <span class="n">pyfits</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_index</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exclusion_level</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;marginal&#39;</span><span class="p">,</span> <span class="s1">&#39;bad_stamp&#39;</span><span class="p">):</span>
            <span class="c1"># First, read in what we need to impose selection criteria, if the appropriate</span>
            <span class="c1"># exclusion_level was chosen.</span>

            <span class="c1"># This should work if the user passed in (or we defaulted to) the real galaxy</span>
            <span class="c1"># catalog name:</span>
            <span class="n">selection_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_selection.fits&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">selection_file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fits</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">selection_cat</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="c1"># There&#39;s one more option: full_file_name might be the parametric fit file, so</span>
                <span class="c1"># we have to strip off the _fits.fits (instead of just the .fits)</span>
                <span class="n">selection_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_selection&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">selection_file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fits</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">selection_cat</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;File with GalSim selection criteria not found. &quot;</span>
                                      <span class="s2">&quot;Run the program `galsim_download_cosmos -s </span><span class="si">%s</span><span class="s2">` to get the &quot;</span>
                                      <span class="s2">&quot;necessary selection file.&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_sample</span><span class="p">))</span>

            <span class="c1"># We proceed to select galaxies in a way that excludes suspect postage stamps (e.g.,</span>
            <span class="c1"># with deblending issues), suspect parametric model fits, or both of the above plus</span>
            <span class="c1"># marginal ones.  These two options for &#39;exclusion_level&#39; involve placing cuts on</span>
            <span class="c1"># the S/N of the object detection in the original postage stamp, and on issues with</span>
            <span class="c1"># masking that can indicate deblending or detection failures.  These cuts were used</span>
            <span class="c1"># in GREAT3.  In the case of the masking cut, in some cases there are messed up ones</span>
            <span class="c1"># that have a 0 for self.selection_cat[&#39;peak_image_pixel_count&#39;].  To make sure we</span>
            <span class="c1"># don&#39;t divide by zero (generating a RuntimeWarning), and still eliminate those, we</span>
            <span class="c1"># will first set that column to 1.e-5.  We choose a sample-dependent mask ratio cut,</span>
            <span class="c1"># since this depends on the peak object flux, which will differ for the two samples</span>
            <span class="c1"># (and we can&#39;t really cut on this for arbitrary user-defined samples).</span>
            <span class="n">div_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_cat</span><span class="p">[</span><span class="s1">&#39;peak_image_pixel_count&#39;</span><span class="p">]</span>
            <span class="n">div_val</span><span class="p">[</span><span class="n">div_val</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e-5</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_cat</span><span class="p">[</span><span class="s1">&#39;sn_ellip_gauss&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sn_limit</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_cat</span><span class="p">[</span><span class="s1">&#39;min_mask_dist_pixels&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_mask_dist</span><span class="p">)</span> <span class="o">|</span>
                       <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_cat</span><span class="p">[</span><span class="s1">&#39;average_mask_adjacent_pixel_count&#39;</span><span class="p">]</span> <span class="o">/</span> \
                           <span class="n">div_val</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut_ratio</span><span class="p">))</span> <span class="p">)</span>

            <span class="c1"># Finally, impose a cut that the total flux in the postage stamp should be positive,</span>
            <span class="c1"># which excludes a tiny number of galaxies (of order 10 in each sample) with some sky</span>
            <span class="c1"># subtraction or deblending errors.  Some of these are eliminated by other cuts when</span>
            <span class="c1"># using exclusion_level=&#39;marginal&#39;.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_cat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_cat</span><span class="o">.</span><span class="n">stamp_flux</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">exclusion_level</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;bad_fits&#39;</span><span class="p">,</span> <span class="s1">&#39;marginal&#39;</span><span class="p">):</span>
            <span class="c1"># This &#39;exclusion_level&#39; involves eliminating failed parametric fits (bad fit status</span>
            <span class="c1"># flags).  In this case we only get rid of those with failed bulge+disk AND failed</span>
            <span class="c1"># Sersic fits, so there is no viable parametric model for the galaxy.</span>
            <span class="n">sersicfit_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">[</span><span class="s1">&#39;fit_status&#39;</span><span class="p">][:,</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">bulgefit_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">[</span><span class="s1">&#39;fit_status&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span> <span class="p">((</span><span class="n">sersicfit_status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="n">sersicfit_status</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="o">|</span>
                      <span class="p">((</span><span class="n">bulgefit_status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="n">bulgefit_status</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">exclusion_level</span> <span class="o">==</span> <span class="s1">&#39;marginal&#39;</span><span class="p">:</span>
            <span class="c1"># We have already placed some cuts (above) in this case, but we&#39;ll do some more.  For</span>
            <span class="c1"># example, a failed bulge+disk fit often indicates difficulty in fit convergence due to</span>
            <span class="c1"># noisy surface brightness profiles, so we might want to toss out those that have a</span>
            <span class="c1"># failure in EITHER fit.</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span> <span class="p">((</span><span class="n">sersicfit_status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="n">sersicfit_status</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="o">&amp;</span>
                      <span class="p">((</span><span class="n">bulgefit_status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                      <span class="p">(</span><span class="n">bulgefit_status</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="p">)</span>

            <span class="c1"># Some fit parameters can indicate a likely sky subtraction error: very high sersic n</span>
            <span class="c1"># AND abnormally large half-light radius (&gt;1 arcsec).</span>
            <span class="k">if</span> <span class="s1">&#39;hlr&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;You still have the old COSMOS catalog.  Run the program &quot;</span>
                              <span class="s2">&quot;`galsim_download_cosmos -s </span><span class="si">%s</span><span class="s2">` to upgrade.&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_sample</span><span class="p">))</span>
            <span class="n">hlr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">[</span><span class="s1">&#39;hlr&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">[</span><span class="s1">&#39;sersicfit&#39;</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hlr</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">)</span> <span class="p">)</span>

            <span class="c1"># Major flux differences in the parametric model vs. the COSMOS catalog can indicate fit</span>
            <span class="c1"># issues, deblending problems, etc.</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_cat</span><span class="p">[</span><span class="s1">&#39;dmag&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">min_hlr</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">max_hlr</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">min_flux</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">max_flux</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;hlr&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;You still have the old COSMOS catalog.  Run the program &quot;</span>
                              <span class="s2">&quot;`galsim_download_cosmos -s </span><span class="si">%s</span><span class="s2">` to upgrade.&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_sample</span><span class="p">))</span>

            <span class="n">hlr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">[</span><span class="s1">&#39;hlr&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># sersic half-light radius</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">min_hlr</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">hlr</span> <span class="o">&gt;</span> <span class="n">min_hlr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_hlr</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">hlr</span> <span class="o">&lt;</span> <span class="n">max_hlr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">min_flux</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">flux</span> <span class="o">&gt;</span> <span class="n">min_flux</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_flux</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">flux</span> <span class="o">&lt;</span> <span class="n">max_flux</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orig_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_index</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobjects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_index</span><span class="p">)</span>

    <span class="c1"># We need this method because the config apparatus will use this via a Proxy, and they cannot</span>
    <span class="c1"># access attributes directly -- just call methods.  So this is how we get nobjects there.</span>
    <span class="k">def</span> <span class="nf">getNObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobjects</span>
    <span class="k">def</span> <span class="nf">getUseSample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sample</span>
    <span class="k">def</span> <span class="nf">getOrigIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_index</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">getNTot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobjects</span>

<div class="viewcode-block" id="GalaxySample.makeGalaxy"><a class="viewcode-back" href="../../real_gal.html#galsim.GalaxySample.makeGalaxy">[docs]</a>    <span class="k">def</span> <span class="nf">makeGalaxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gal_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chromatic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">noise_pad_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                   <span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sersic_prec</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_random</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Routine to construct one or more `GSObject` instances corresponding to the catalog entry</span>
<span class="sd">        with a particular index or indices.</span>

<span class="sd">        The flux of the galaxy corresponds to a 1 second exposure time with the Hubble Space</span>
<span class="sd">        Telescope.  Users who wish to simulate F814W images with a different telescope and an</span>
<span class="sd">        exposure time longer than 1 second should multiply by that exposure time, and by the square</span>
<span class="sd">        of the ratio of the effective diameter of their telescope compared to that of HST.</span>
<span class="sd">        (Effective diameter may differ from the actual diameter if there is significant</span>
<span class="sd">        obscuration.)  See demo11.py for an example that explicitly takes this normalization into</span>
<span class="sd">        account.</span>

<span class="sd">        Due to the adopted flux normalization, drawing into an image with the COSMOS bandpass,</span>
<span class="sd">        zeropoint of 25.94, and pixel scale should give the right pixel values to mimic the actual</span>
<span class="sd">        COSMOS science images.  The COSMOS science images that we use are normalized to a count rate</span>
<span class="sd">        of 1 second, which is why there is no need to rescale to account for the COSMOS exposure</span>
<span class="sd">        time.</span>

<span class="sd">        There is an option to make chromatic objects (``chromatic=True``); however, it is important</span>
<span class="sd">        to bear in mind that we do not actually have spatially-resolved color information for these</span>
<span class="sd">        galaxies, so this keyword can only be True if we are using parametric galaxies.  Even then,</span>
<span class="sd">        we simply do the most arbitrary thing possible, which is to assign bulges an elliptical</span>
<span class="sd">        `SED`, disks a disk-like `SED`, and `Sersic` galaxies with intermediate values of n some</span>
<span class="sd">        intermediate `SED`.  We assume that the photometric redshift is the correct redshift for</span>
<span class="sd">        these galaxies (which is a good assumption for COSMOS 30-band photo-z for these bright</span>
<span class="sd">        galaxies).  For the given `SED` and redshift, we then normalize to give the right (observed)</span>
<span class="sd">        flux in F814W.  Note that for a mock &quot;deep&quot; sample, the redshift distributions of the</span>
<span class="sd">        galaxies would be modified, which is not included here.</span>

<span class="sd">        For this chromatic option, it is still the case that the output flux normalization is</span>
<span class="sd">        appropriate for the HST effective telescope diameter and a 1 second exposure time, so users</span>
<span class="sd">        who are simulating another scenario should account for this.</span>

<span class="sd">        Note that the returned objects use arcsec for the units of their linear dimension.  If you</span>
<span class="sd">        are using a different unit for other things (the PSF, WCS, etc.), then you should dilate</span>
<span class="sd">        the resulting object with ``gal.dilate(galsim.arcsec / scale_unit)``.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            index:          Index of the desired galaxy in the catalog for which a `GSObject`</span>
<span class="sd">                            should be constructed.  You may also provide a list or array of</span>
<span class="sd">                            indices, in which case a list of objects is returned. If None,</span>
<span class="sd">                            then a random galaxy (or more: see n_random kwarg) is chosen,</span>
<span class="sd">                            correcting for catalog-level selection effects if weights are</span>
<span class="sd">                            available. [default: None]</span>
<span class="sd">            gal_type:       Either &#39;real&#39; or &#39;parametric&#39;.  This determines which kind of</span>
<span class="sd">                            galaxy model is made. [If catalog was loaded with ``use_real=False``,</span>
<span class="sd">                            then this defaults to &#39;parametric&#39;, and in fact &#39;real&#39; is</span>
<span class="sd">                            not allowed.  If catalog was loaded with ``use_real=True``, then</span>
<span class="sd">                            this defaults to &#39;real&#39;.]</span>
<span class="sd">            chromatic:      Make this a chromatic object, or not?  [default: False]</span>
<span class="sd">            noise_pad_size: For realistic galaxies, the size of region to pad with noise,</span>
<span class="sd">                            in arcsec.  [default: 5, an arbitrary, but not completely</span>
<span class="sd">                            ridiculous choice.]</span>
<span class="sd">            deep:           Modify fluxes and sizes of galaxies from the F814W&lt;23.5 sample in</span>
<span class="sd">                            order to roughly simulate an F814W&lt;25 sample but with higher S/N, as</span>
<span class="sd">                            in GREAT3? [default: False]  Note that this keyword will be ignored</span>
<span class="sd">                            (except for issuing a warning) if the input catalog already</span>
<span class="sd">                            represents the F814W&lt;25.2 sample.</span>
<span class="sd">            sersic_prec:    The desired precision on the Sersic index n in parametric galaxies.</span>
<span class="sd">                            GalSim is significantly faster if it gets a smallish number of</span>
<span class="sd">                            Sersic values, so it can cache some of the calculations and use</span>
<span class="sd">                            them again the next time it gets a galaxy with the same index.</span>
<span class="sd">                            If ``sersic_prec`` is 0.0, then use the exact value of index n from</span>
<span class="sd">                            the catalog.  But if it is &gt;0, then round the index to that</span>
<span class="sd">                            precision.  [default: 0.05]</span>
<span class="sd">            rng:            A random number generator to use for selecting a random galaxy</span>
<span class="sd">                            (may be any kind of `BaseDeviate` or None) and to use in generating</span>
<span class="sd">                            any noise field when padding.  [default: None]</span>
<span class="sd">            n_random:       The number of random galaxies to build, if &#39;index&#39; is None.</span>
<span class="sd">                            [default: 1]</span>
<span class="sd">            gsparams:       An optional `GSParams` argument. [default: None]</span>

<span class="sd">        Returns:</span>
<span class="sd">            Either a `GSObject` or a `ChromaticObject` depending on the value of ``chromatic``,</span>
<span class="sd">            or a list of them if ``index`` is an iterable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeGalaxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">gal_type</span><span class="p">,</span> <span class="n">chromatic</span><span class="p">,</span> <span class="n">noise_pad_size</span><span class="p">,</span>
                                <span class="n">deep</span><span class="p">,</span> <span class="n">sersic_prec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exptime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">area</span><span class="p">,</span>
                                <span class="n">rng</span><span class="p">,</span> <span class="n">n_random</span><span class="p">,</span> <span class="n">gsparams</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_makeGalaxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gal_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chromatic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">noise_pad_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sersic_prec</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">exptime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_random</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.random</span> <span class="kn">import</span> <span class="n">BaseDeviate</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">canMakeReal</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">gal_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gal_type</span> <span class="o">=</span> <span class="s1">&#39;parametric&#39;</span>
            <span class="k">elif</span> <span class="n">gal_type</span> <span class="o">!=</span> <span class="s1">&#39;parametric&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Only &#39;parametric&#39; galaxy type is allowed when use_real == False&quot;</span><span class="p">,</span>
                    <span class="n">gal_type</span><span class="o">=</span><span class="n">gal_type</span><span class="p">,</span> <span class="n">use_real</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">canMakeReal</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gal_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gal_type</span> <span class="o">=</span> <span class="s1">&#39;real&#39;</span>

        <span class="k">if</span> <span class="n">gal_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;real&#39;</span><span class="p">,</span> <span class="s1">&#39;parametric&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">GalSimValueError</span><span class="p">(</span><span class="s2">&quot;Invalid galaxy type </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">gal_type</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;real&#39;</span><span class="p">,</span> <span class="s1">&#39;parametric&#39;</span><span class="p">))</span>

        <span class="c1"># Make rng if we will need it.</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">gal_type</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="n">BaseDeviate</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">BaseDeviate</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The rng provided to makeGalaxy is not a BaseDeviate&quot;</span><span class="p">)</span>

        <span class="c1"># Select random indices if necessary (no index given).</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_random</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">n_random</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectRandomIndex</span><span class="p">(</span><span class="n">n_random</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_random</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot specify both index and n_random&quot;</span><span class="p">,</span> <span class="n">n_random</span><span class="o">=</span><span class="n">n_random</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># Check whether this is a COSMOSCatalog meant to represent real or parametric objects, then</span>
        <span class="c1"># call the appropriate helper routine for that case.</span>
        <span class="k">if</span> <span class="n">gal_type</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chromatic</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GalSimNotImplementedError</span><span class="p">(</span><span class="s2">&quot;Cannot yet make real chromatic galaxies!&quot;</span><span class="p">)</span>
            <span class="n">gal_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                <span class="n">real_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRealParams</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">gal</span> <span class="o">=</span> <span class="n">RealGalaxy</span><span class="p">(</span><span class="n">real_params</span><span class="p">,</span> <span class="n">noise_pad_size</span><span class="o">=</span><span class="n">noise_pad_size</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
                                 <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">)</span>
                <span class="n">gal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gal</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chromatic</span><span class="p">:</span>
                <span class="n">bandpass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBandpass</span><span class="p">()</span>
                <span class="n">sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSED</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bandpass</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">sed</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gal_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParametricRecord</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">gal</span> <span class="o">=</span> <span class="n">COSMOSCatalog</span><span class="o">.</span><span class="n">_buildParametric</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">sersic_prec</span><span class="p">,</span> <span class="n">gsparams</span><span class="p">,</span>
                                                     <span class="n">chromatic</span><span class="p">,</span> <span class="n">bandpass</span><span class="p">,</span> <span class="n">sed</span><span class="p">)</span>
                <span class="n">gal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gal</span><span class="p">)</span>

        <span class="n">flux_scaling</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">if</span> <span class="n">exptime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">flux_scaling</span> <span class="o">*=</span> <span class="n">exptime</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_exptime</span>
        <span class="k">if</span> <span class="n">area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">flux_scaling</span> <span class="o">*=</span> <span class="n">area</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_area</span>
        <span class="k">if</span> <span class="n">flux_scaling</span> <span class="o">!=</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">gal_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gal</span> <span class="o">*</span> <span class="n">flux_scaling</span> <span class="k">for</span> <span class="n">gal</span> <span class="ow">in</span> <span class="n">gal_list</span><span class="p">]</span>

        <span class="c1"># If trying to use the 23.5 sample and &quot;fake&quot; a deep sample, rescale the size and flux as</span>
        <span class="c1"># suggested in the GREAT3 handbook.</span>
        <span class="k">if</span> <span class="n">deep</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUseSample</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;23.5&#39;</span><span class="p">:</span>
                <span class="c1"># Rescale the flux to get a limiting mag of 25 in F814W when starting with a</span>
                <span class="c1"># limiting mag of 23.5.  Make the galaxies a factor of 0.6 smaller and appropriately</span>
                <span class="c1"># fainter.</span>
                <span class="n">flux_factor</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span>
                <span class="n">size_factor</span> <span class="o">=</span> <span class="mf">0.6</span>
                <span class="n">gal_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">gal</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">size_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">flux_factor</span> <span class="k">for</span> <span class="n">gal</span> <span class="ow">in</span> <span class="n">gal_list</span> <span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUseSample</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;25.2&#39;</span><span class="p">:</span>
                <span class="n">galsim_warn</span><span class="p">(</span><span class="s2">&quot;Ignoring `deep` argument, because the sample being used already &quot;</span>
                            <span class="s2">&quot;corresponds to a flux limit of F814W&lt;25.2&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">galsim_warn</span><span class="p">(</span><span class="s2">&quot;Ignoring `deep` argument, because the sample being used does not &quot;</span>
                            <span class="s2">&quot;corresponds to a flux limit of F814W&lt;23.5&quot;</span><span class="p">)</span>

        <span class="c1"># Store the orig_index as gal.index regardless of whether we have a RealGalaxy or not.</span>
        <span class="c1"># It gets set as part of making a real galaxy, but not by _buildParametric.</span>
        <span class="c1"># And if we are doing the deep scaling, then it gets messed up by that.</span>
        <span class="c1"># So just put it in here at the end to be sure.</span>
        <span class="k">for</span> <span class="n">gal</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gal_list</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
            <span class="n">gal</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrigIndex</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gal</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">):</span> <span class="n">gal</span><span class="o">.</span><span class="n">original</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">gal</span><span class="o">.</span><span class="n">index</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">gal_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gal_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="GalaxySample.selectRandomIndex"><a class="viewcode-back" href="../../real_gal.html#galsim.GalaxySample.selectRandomIndex">[docs]</a>    <span class="k">def</span> <span class="nf">selectRandomIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_random</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_n_rng_calls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Routine to select random indices out of the catalog.  This routine does a weighted random</span>
<span class="sd">        selection with replacement (i.e., there is no guarantee of uniqueness of the selected</span>
<span class="sd">        indices).  Weighting uses the weight factors available in the catalog, if any; these weights</span>
<span class="sd">        are typically meant to remove any selection effects in the catalog creation process.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            n_random:   Number of random indices to return. [default: 1]</span>
<span class="sd">            rng:        A random number generator to use for selecting a random galaxy</span>
<span class="sd">                        (may be any kind of `BaseDeviate` or None). [default: None]</span>

<span class="sd">        Returns:</span>
<span class="sd">            A single index if n_random==1 or a NumPy array containing the randomly-selected</span>
<span class="sd">            indices if n_random&gt;1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.random</span> <span class="kn">import</span> <span class="n">BaseDeviate</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utilities</span>
        <span class="c1"># Set up the random number generator.</span>
        <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">BaseDeviate</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_cat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_cat</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">galsim_warn</span><span class="p">(</span><span class="s2">&quot;Selecting random object without correcting for catalog-level &quot;</span>
                        <span class="s2">&quot;selection effects.  This correction requires the existence of &quot;</span>
                        <span class="s2">&quot;real catalog with valid weights in addition to parametric one. &quot;</span>
                        <span class="s2">&quot;Create the COSMOSCatalog with use_real=True to avoid this warning.&quot;</span><span class="p">)</span>
            <span class="n">use_weights</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># By default, get the number of RNG calls.  We then decide whether or not to return them</span>
        <span class="c1"># based on _n_rng_calls.</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">n_rng_calls</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">rand_with_replacement</span><span class="p">(</span>
                <span class="n">n_random</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobjects</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">use_weights</span><span class="p">,</span> <span class="n">_n_rng_calls</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_random</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_n_rng_calls</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">n_rng_calls</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_n_rng_calls</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_rng_calls</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">getBandpass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.bandpass</span> <span class="kn">import</span> <span class="n">Bandpass</span>
        <span class="c1"># Defer making the Bandpass and reading in SEDs until we actually are going to use them.</span>
        <span class="c1"># It&#39;s not a huge calculation, but the thin() call especially isn&#39;t trivial.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bandpass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We have to set an appropriate zeropoint.  This is slightly complicated: The</span>
            <span class="c1"># nominal COSMOS zeropoint for single-orbit depth (2000s of usable exposure time,</span>
            <span class="c1"># across 4 dithered exposures) is supposedly 25.94.  But the science images that we</span>
            <span class="c1"># are using were normalized to count rate, not counts, meaning that an object with</span>
            <span class="c1"># mag=25.94 has a count rate of 1 photon/sec, not 1 photon total.  Since we&#39;ve</span>
            <span class="c1"># declared our flux normalization for the outputs to be appropriate for a 1s</span>
            <span class="c1"># exposure, we use this zeropoint directly.</span>
            <span class="c1"># This means that when drawing chromatic parametric galaxies, the outputs will be</span>
            <span class="c1"># properly normalized in terms of counts.</span>
            <span class="n">zp</span> <span class="o">=</span> <span class="mf">25.94</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bandpass</span> <span class="o">=</span> <span class="n">Bandpass</span><span class="p">(</span><span class="s1">&#39;ACS_wfc_F814W.dat&#39;</span><span class="p">,</span> <span class="n">wave_type</span><span class="o">=</span><span class="s1">&#39;nm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">withZeropoint</span><span class="p">(</span><span class="n">zp</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bandpass</span>

    <span class="k">def</span> <span class="nf">getSED</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.sed</span> <span class="kn">import</span> <span class="n">SED</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Read in some SEDs.  We are using some fairly truncated and thinned ones, because</span>
            <span class="c1"># in any case the SED assignment here is somewhat arbitrary and should not be taken</span>
            <span class="c1"># too seriously.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sed</span> <span class="o">=</span> <span class="p">[</span>
                <span class="c1"># bulge</span>
                <span class="n">SED</span><span class="p">(</span><span class="s1">&#39;CWW_E_ext_more.sed&#39;</span><span class="p">,</span> <span class="n">wave_type</span><span class="o">=</span><span class="s1">&#39;Ang&#39;</span><span class="p">,</span> <span class="n">flux_type</span><span class="o">=</span><span class="s1">&#39;flambda&#39;</span><span class="p">),</span>
                <span class="c1"># disk</span>
                <span class="n">SED</span><span class="p">(</span><span class="s1">&#39;CWW_Scd_ext_more.sed&#39;</span><span class="p">,</span> <span class="n">wave_type</span><span class="o">=</span><span class="s1">&#39;Ang&#39;</span><span class="p">,</span> <span class="n">flux_type</span><span class="o">=</span><span class="s1">&#39;flambda&#39;</span><span class="p">),</span>
                <span class="c1"># intermediate</span>
                <span class="n">SED</span><span class="p">(</span><span class="s1">&#39;CWW_Sbc_ext_more.sed&#39;</span><span class="p">,</span> <span class="n">wave_type</span><span class="o">=</span><span class="s1">&#39;Ang&#39;</span><span class="p">,</span> <span class="n">flux_type</span><span class="o">=</span><span class="s1">&#39;flambda&#39;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sed</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_round_sersic</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">sersic_prec</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">sersic_prec</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">*</span> <span class="n">sersic_prec</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_buildParametric</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">sersic_prec</span><span class="p">,</span> <span class="n">gsparams</span><span class="p">,</span> <span class="n">chromatic</span><span class="p">,</span> <span class="n">bandpass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.angle</span> <span class="kn">import</span> <span class="n">radians</span>
        <span class="kn">from</span> <span class="nn">.exponential</span> <span class="kn">import</span> <span class="n">Exponential</span>
        <span class="kn">from</span> <span class="nn">.sersic</span> <span class="kn">import</span> <span class="n">DeVaucouleurs</span><span class="p">,</span> <span class="n">Sersic</span>
        <span class="c1"># Get fit parameters.  For &#39;sersicfit&#39;, the result is an array of 8 numbers for each</span>
        <span class="c1"># galaxy:</span>
        <span class="c1">#     SERSICFIT[0]: intensity of light profile at the half-light radius.</span>
        <span class="c1">#     SERSICFIT[1]: half-light radius measured along the major axis, in units of pixels</span>
        <span class="c1">#                   in the COSMOS lensing data reductions (0.03 arcsec).</span>
        <span class="c1">#     SERSICFIT[2]: Sersic n.</span>
        <span class="c1">#     SERSICFIT[3]: q, the ratio of minor axis to major axis length.</span>
        <span class="c1">#     SERSICFIT[4]: boxiness, currently fixed to 0, meaning isophotes are all</span>
        <span class="c1">#                   elliptical.</span>
        <span class="c1">#     SERSICFIT[5]: x0, the central x position in pixels.</span>
        <span class="c1">#     SERSICFIT[6]: y0, the central y position in pixels.</span>
        <span class="c1">#     SERSICFIT[7]: phi, the position angle in radians.  If phi=0, the major axis is</span>
        <span class="c1">#                   lined up with the x axis of the image.</span>
        <span class="c1"># For &#39;bulgefit&#39;, the result is an array of 16 parameters that comes from doing a</span>
        <span class="c1"># 2-component sersic fit.  The first 8 are the parameters for the disk, with n=1, and</span>
        <span class="c1"># the last 8 are for the bulge, with n=4.</span>
        <span class="n">bparams</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;bulgefit&#39;</span><span class="p">]</span>
        <span class="n">sparams</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;sersicfit&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;hlr&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">record</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;You still have the old COSMOS catalog.  Run the program &quot;</span>
                          <span class="s2">&quot;`galsim_download_cosmos -s </span><span class="si">%s</span><span class="s2">` to upgrade.&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_sample</span><span class="p">))</span>

        <span class="n">use_bulgefit</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;use_bulgefit&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_bulgefit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;viable_sersic&#39;</span><span class="p">]:</span>  <span class="c1"># pragma: no cover</span>
            <span class="c1"># This shouldn&#39;t be possible I think...</span>
            <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s2">&quot;Cannot make parametric model for this galaxy!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_bulgefit</span><span class="p">:</span>
            <span class="c1"># Bulge parameters:</span>
            <span class="c1"># Minor-to-major axis ratio:</span>
            <span class="n">bulge_q</span> <span class="o">=</span> <span class="n">bparams</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
            <span class="c1"># Position angle, now represented as a galsim.Angle:</span>
            <span class="n">bulge_beta</span> <span class="o">=</span> <span class="n">bparams</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">*</span><span class="n">radians</span>
            <span class="n">disk_q</span> <span class="o">=</span> <span class="n">bparams</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">disk_beta</span> <span class="o">=</span> <span class="n">bparams</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">radians</span>
            <span class="n">bulge_hlr</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;hlr&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">bulge_flux</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">disk_hlr</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;hlr&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">disk_flux</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># Make sure the bulge-to-total flux ratio is not nonsense.</span>
            <span class="n">bfrac</span> <span class="o">=</span> <span class="n">bulge_flux</span><span class="o">/</span><span class="p">(</span><span class="n">bulge_flux</span><span class="o">+</span><span class="n">disk_flux</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bfrac</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bfrac</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bfrac</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                <span class="c1"># This shouldn&#39;t be possible I think...</span>
                <span class="k">raise</span> <span class="n">GalSimError</span><span class="p">(</span><span class="s2">&quot;Cannot make parametric model for this galaxy&quot;</span><span class="p">)</span>

            <span class="c1"># Then combine the two components of the galaxy.</span>
            <span class="k">if</span> <span class="n">chromatic</span><span class="p">:</span>
                <span class="c1"># We define the GSObjects with flux=1, then multiply by an SED defined to have</span>
                <span class="c1"># the appropriate (observed) magnitude at the redshift in the COSMOS passband.</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;zphot&#39;</span><span class="p">]</span>
                <span class="n">target_bulge_mag</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;mag_auto&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">bfrac</span><span class="p">)</span>
                <span class="n">bulge_sed</span> <span class="o">=</span> <span class="n">sed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atRedshift</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">withMagnitude</span><span class="p">(</span>
                    <span class="n">target_bulge_mag</span><span class="p">,</span> <span class="n">bandpass</span><span class="p">)</span>
                <span class="n">bulge</span> <span class="o">=</span> <span class="n">DeVaucouleurs</span><span class="p">(</span><span class="n">half_light_radius</span><span class="o">=</span><span class="n">bulge_hlr</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">)</span>
                <span class="n">bulge</span> <span class="o">*=</span> <span class="n">bulge_sed</span>
                <span class="n">target_disk_mag</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;mag_auto&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="n">bfrac</span><span class="p">))</span>
                <span class="n">disk_sed</span> <span class="o">=</span> <span class="n">sed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">atRedshift</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">withMagnitude</span><span class="p">(</span><span class="n">target_disk_mag</span><span class="p">,</span> <span class="n">bandpass</span><span class="p">)</span>
                <span class="n">disk</span> <span class="o">=</span> <span class="n">Exponential</span><span class="p">(</span><span class="n">half_light_radius</span><span class="o">=</span><span class="n">disk_hlr</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">)</span>
                <span class="n">disk</span> <span class="o">*=</span> <span class="n">disk_sed</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bulge</span> <span class="o">=</span> <span class="n">DeVaucouleurs</span><span class="p">(</span><span class="n">flux</span><span class="o">=</span><span class="n">bulge_flux</span><span class="p">,</span> <span class="n">half_light_radius</span><span class="o">=</span><span class="n">bulge_hlr</span><span class="p">,</span>
                                             <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">)</span>
                <span class="n">disk</span> <span class="o">=</span> <span class="n">Exponential</span><span class="p">(</span><span class="n">flux</span><span class="o">=</span><span class="n">disk_flux</span><span class="p">,</span> <span class="n">half_light_radius</span><span class="o">=</span><span class="n">disk_hlr</span><span class="p">,</span>
                                          <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">)</span>

            <span class="c1"># Apply shears for intrinsic shape.</span>
            <span class="k">if</span> <span class="n">bulge_q</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>  <span class="c1"># pragma: no branch</span>
                <span class="n">bulge</span> <span class="o">=</span> <span class="n">bulge</span><span class="o">.</span><span class="n">shear</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">bulge_q</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">bulge_beta</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">disk_q</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>  <span class="c1"># pragma: no branch</span>
                <span class="n">disk</span> <span class="o">=</span> <span class="n">disk</span><span class="o">.</span><span class="n">shear</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">disk_q</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">disk_beta</span><span class="p">)</span>

            <span class="n">gal</span> <span class="o">=</span> <span class="n">bulge</span> <span class="o">+</span> <span class="n">disk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Do a similar manipulation to the stored quantities for the single Sersic profiles.</span>
            <span class="n">gal_n</span> <span class="o">=</span> <span class="n">sparams</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="c1"># Fudge this if it is at the edge of the allowed n values.  Since GalSim (as of #325 and</span>
            <span class="c1"># #449) allow Sersic n in the range 0.3&lt;=n&lt;=6, the only problem is that the fits</span>
            <span class="c1"># occasionally go as low as n=0.2.  The fits in this file only go to n=6, so there is no</span>
            <span class="c1"># issue with too-high values, but we also put a guard on that side in case other samples</span>
            <span class="c1"># are swapped in that go to higher value of sersic n.</span>
            <span class="k">if</span> <span class="n">gal_n</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span> <span class="n">gal_n</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="k">if</span> <span class="n">gal_n</span> <span class="o">&gt;</span> <span class="mf">6.0</span><span class="p">:</span> <span class="n">gal_n</span> <span class="o">=</span> <span class="mf">6.0</span>
            <span class="c1"># GalSim is much more efficient if only a finite number of Sersic n values are used.</span>
            <span class="c1"># This (optionally given constructor args) rounds n to the nearest 0.05.</span>
            <span class="k">if</span> <span class="n">sersic_prec</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">gal_n</span> <span class="o">=</span> <span class="n">COSMOSCatalog</span><span class="o">.</span><span class="n">_round_sersic</span><span class="p">(</span><span class="n">gal_n</span><span class="p">,</span> <span class="n">sersic_prec</span><span class="p">)</span>
            <span class="n">gal_q</span> <span class="o">=</span> <span class="n">sparams</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">gal_beta</span> <span class="o">=</span> <span class="n">sparams</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">radians</span>
            <span class="n">gal_hlr</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;hlr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">gal_flux</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">chromatic</span><span class="p">:</span>
                <span class="n">gal</span> <span class="o">=</span> <span class="n">Sersic</span><span class="p">(</span><span class="n">gal_n</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">half_light_radius</span><span class="o">=</span><span class="n">gal_hlr</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gal_n</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">:</span>
                    <span class="n">use_sed</span> <span class="o">=</span> <span class="n">sed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># disk</span>
                <span class="k">elif</span> <span class="n">gal_n</span> <span class="o">&gt;=</span> <span class="mf">1.5</span> <span class="ow">and</span> <span class="n">gal_n</span> <span class="o">&lt;</span> <span class="mf">3.0</span><span class="p">:</span>
                    <span class="n">use_sed</span> <span class="o">=</span> <span class="n">sed</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># intermediate</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">use_sed</span> <span class="o">=</span> <span class="n">sed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># bulge</span>
                <span class="n">target_mag</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;mag_auto&#39;</span><span class="p">]</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;zphot&#39;</span><span class="p">]</span>
                <span class="n">gal</span> <span class="o">*=</span> <span class="n">use_sed</span><span class="o">.</span><span class="n">atRedshift</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">withMagnitude</span><span class="p">(</span><span class="n">target_mag</span><span class="p">,</span> <span class="n">bandpass</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gal</span> <span class="o">=</span> <span class="n">Sersic</span><span class="p">(</span><span class="n">gal_n</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">gal_flux</span><span class="p">,</span> <span class="n">half_light_radius</span><span class="o">=</span><span class="n">gal_hlr</span><span class="p">,</span> <span class="n">gsparams</span><span class="o">=</span><span class="n">gsparams</span><span class="p">)</span>

            <span class="c1"># Apply shears for intrinsic shape.</span>
            <span class="k">if</span> <span class="n">gal_q</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>  <span class="c1"># pragma: no branch</span>
                <span class="n">gal</span> <span class="o">=</span> <span class="n">gal</span><span class="o">.</span><span class="n">shear</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">gal_q</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">gal_beta</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gal</span>

<div class="viewcode-block" id="GalaxySample.getRealParams"><a class="viewcode-back" href="../../real_gal.html#galsim.GalaxySample.getRealParams">[docs]</a>    <span class="k">def</span> <span class="nf">getRealParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the parameters needed to make a `RealGalaxy` for a given index.&quot;&quot;&quot;</span>
        <span class="c1"># Used by COSMOSGalaxy to circumvent making the RealGalaxy here and potentially having</span>
        <span class="c1"># to pickle the result.  These raw materials should be smaller, so quicker to pickle.</span>
        <span class="n">orig_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_index</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">gal_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_cat</span><span class="o">.</span><span class="n">getGalImage</span><span class="p">(</span><span class="n">orig_index</span><span class="p">)</span>
        <span class="n">psf_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_cat</span><span class="o">.</span><span class="n">getPSFImage</span><span class="p">(</span><span class="n">orig_index</span><span class="p">)</span>
        <span class="n">noise_image</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_cat</span><span class="o">.</span><span class="n">getNoiseProperties</span><span class="p">(</span><span class="n">orig_index</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">gal_image</span><span class="p">,</span> <span class="n">psf_image</span><span class="p">,</span> <span class="n">noise_image</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span></div>

<div class="viewcode-block" id="GalaxySample.getParametricRecord"><a class="viewcode-back" href="../../real_gal.html#galsim.GalaxySample.getParametricRecord">[docs]</a>    <span class="k">def</span> <span class="nf">getParametricRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the parametric record for a given index&quot;&quot;&quot;</span>
        <span class="c1"># Used by _makeGalaxy to circumvent pickling the result.</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_index</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
        <span class="c1"># Convert to a dict, since on some systems, the numpy record doesn&#39;t seem to</span>
        <span class="c1"># pickle correctly.</span>
        <span class="n">record_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span><span class="p">:</span><span class="n">record</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">record_dict</span></div>

<div class="viewcode-block" id="GalaxySample.getValue"><a class="viewcode-back" href="../../real_gal.html#galsim.GalaxySample.getValue">[docs]</a>    <span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the value in the parametric catalog at the given key and index&quot;&quot;&quot;</span>
        <span class="c1"># Used by _makeGalaxy to circumvent pickling the result.</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_index</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="GalaxySample.canMakeReal"><a class="viewcode-back" href="../../real_gal.html#galsim.GalaxySample.canMakeReal">[docs]</a>    <span class="k">def</span> <span class="nf">canMakeReal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is it permissible to call makeGalaxy with gal_type=&#39;real&#39;?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_real</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">GalaxySample</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">use_real</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">use_real</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">real_cat</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">real_cat</span> <span class="ow">and</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_cat</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">param_cat</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_index</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">orig_index</span><span class="p">)))</span></div>

<div class="viewcode-block" id="COSMOSCatalog"><a class="viewcode-back" href="../../real_gal.html#galsim.COSMOSCatalog">[docs]</a><span class="k">class</span> <span class="nc">COSMOSCatalog</span><span class="p">(</span><span class="n">GalaxySample</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class representing a random subsample of galaxies from the COSMOS sample with F814W&lt;25.2</span>
<span class="sd">    (default), or alternatively the entire sample with F814W&lt;23.5.</span>

<span class="sd">    Depending on the keyword arguments, particularly ``use_real``, the catalog may be able to</span>
<span class="sd">    generate real galaxies, parametric galaxies, or both.  To use this with either type of</span>
<span class="sd">    galaxies, you need to get the COSMOS datasets in the format that GalSim recognizes; see</span>

<span class="sd">    https://github.com/GalSim-developers/GalSim/wiki/RealGalaxy-Data</span>

<span class="sd">    option (1) for more information.  Note that if you want to make real galaxies you need to</span>
<span class="sd">    download and store the full tarball with all galaxy images, whereas if you want to make</span>
<span class="sd">    parametric galaxies you only need the catalog real_galaxy_catalog_25.2_fits.fits (and the</span>
<span class="sd">    selection file real_galaxy_catalog_25.2_selection.fits if you want to place cuts on the</span>
<span class="sd">    postage stamp quality) and can delete the galaxy and PSF image files.</span>

<span class="sd">    Finally, we provide a program that will download the large COSMOS sample for you and</span>
<span class="sd">    put it in the $PREFIX/share/galsim directory of your installation path.  The program is::</span>

<span class="sd">            galsim_download_cosmos</span>

<span class="sd">    which gets installed in the $PREFIX/bin directory when you install GalSim.  If you use</span>
<span class="sd">    this program to download the COSMOS catalog, then you can use it with::</span>

<span class="sd">            cat = galsim.COSMOSCatalog()</span>

<span class="sd">    GalSim knows the location of the installation share directory, so it will automatically</span>
<span class="sd">    look for it there.</span>

<span class="sd">    In addition to the option of specifying catalog names, this class also accepts a keyword</span>
<span class="sd">    argument ``sample`` that can be used to switch between the samples with limiting magnitudes of</span>
<span class="sd">    23.5 and 25.2.</span>

<span class="sd">    After getting the catalogs, there is a method makeGalaxy() that can make a `GSObject`</span>
<span class="sd">    corresponding to any chosen galaxy in the catalog (whether real or parametric).  See</span>
<span class="sd">    `GalaxySample.makeGalaxy` for more information.  As an interesting application and example of</span>
<span class="sd">    the usage of these routines, consider the following code::</span>

<span class="sd">        &gt;&gt;&gt; im_size = 64</span>
<span class="sd">        &gt;&gt;&gt; pix_scale = 0.05</span>
<span class="sd">        &gt;&gt;&gt; bp_file = os.path.join(galsim.meta_data.share_dir, &#39;wfc_F814W.dat.gz&#39;)</span>
<span class="sd">        &gt;&gt;&gt; bandpass = galsim.Bandpass(bp_file, wave_type=&#39;ang&#39;).thin().withZeropoint(25.94)</span>
<span class="sd">        &gt;&gt;&gt; cosmos_cat = galsim.COSMOSCatalog()</span>
<span class="sd">        &gt;&gt;&gt; psf = galsim.OpticalPSF(diam=2.4, lam=1000.) # bigger than HST F814W PSF.</span>
<span class="sd">        &gt;&gt;&gt; indices = np.arange(10)</span>
<span class="sd">        &gt;&gt;&gt; real_gal_list = cosmos_cat.makeGalaxy(indices, gal_type=&#39;real&#39;,</span>
<span class="sd">        ...                                       noise_pad_size=im_size*pix_scale)</span>
<span class="sd">        &gt;&gt;&gt; param_gal_list = cosmos_cat.makeGalaxy(indices, gal_type=&#39;parametric&#39;, chromatic=True)</span>
<span class="sd">        &gt;&gt;&gt; for ind in indices:</span>
<span class="sd">        &gt;&gt;&gt;     real_gal = galsim.Convolve(real_gal_list[ind], psf)</span>
<span class="sd">        &gt;&gt;&gt;     param_gal = galsim.Convolve(param_gal_list[ind], psf)</span>
<span class="sd">        &gt;&gt;&gt;     im_real = galsim.Image(im_size, im_size)</span>
<span class="sd">        &gt;&gt;&gt;     im_param = galsim.Image(im_size, im_size)</span>
<span class="sd">        &gt;&gt;&gt;     real_gal.drawImage(image=im_real, scale=pix_scale)</span>
<span class="sd">        &gt;&gt;&gt;     param_gal.drawImage(bandpass, image=im_param, scale=pix_scale)</span>
<span class="sd">        &gt;&gt;&gt;     im_real.write(&#39;im_real_&#39;+str(ind)+&#39;.fits&#39;)</span>
<span class="sd">        &gt;&gt;&gt;     im_param.write(&#39;im_param_&#39;+str(ind)+&#39;.fits&#39;)</span>

<span class="sd">    This code snippet will draw images of the first 10 entries in the COSMOS catalog, at slightly</span>
<span class="sd">    lower resolution than in COSMOS, with a real image and its parametric representation for each of</span>
<span class="sd">    those objects.</span>

<span class="sd">    When using the &#39;real&#39; rather than &#39;parametric&#39; option, please read the documentation for the</span>
<span class="sd">    `RealGalaxy` class for additional caveats about the available drawing methods and</span>
<span class="sd">    the need to convolve with a suitable PSF.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        file_name:          The file containing the catalog. [default: None, which will look for the</span>
<span class="sd">                            F814W&lt;25.2 COSMOS catalog in $PREFIX/share/galsim.  It will raise an</span>
<span class="sd">                            exception if the catalog is not there telling you to run</span>
<span class="sd">                            galsim_download_cosmos.]</span>
<span class="sd">        sample:             A keyword argument that can be used to specify the sample to use, i.e.,</span>
<span class="sd">                            &quot;23.5&quot; or &quot;25.2&quot;.  At most one of ``file_name`` and ``sample`` should be</span>
<span class="sd">                            specified.  [default: None, which results in the same default as</span>
<span class="sd">                            ``file_name=None``.]</span>
<span class="sd">        dir:                The directory with the catalog file and, if making realistic galaxies,</span>
<span class="sd">                            the image and noise files (or symlinks to them). [default: None, which</span>
<span class="sd">                            will look in $PREFIX/share/galsim.]</span>
<span class="sd">        preload:            Keyword that is only used for real galaxies, not parametric ones, to</span>
<span class="sd">                            choose whether to preload the header information.  If ``preload=True``,</span>
<span class="sd">                            the bulk of the I/O time is in the constructor.  If ``preload=False``,</span>
<span class="sd">                            there is approximately the same total I/O time (assuming you eventually</span>
<span class="sd">                            use most of the image files referenced in the catalog), but it is spread</span>
<span class="sd">                            over the calls to makeGalaxy().  [default: False]</span>
<span class="sd">        use_real:           Enable the use of realistic galaxies?  [default: True]</span>
<span class="sd">                            If this parameter is False, then ``makeGalaxy(gal_type=&#39;real&#39;)`` will</span>
<span class="sd">                            not be allowed, and there will be a (modest) decrease in RAM and time</span>
<span class="sd">                            spent on I/O when initializing the COSMOSCatalog. If the real</span>
<span class="sd">                            catalog is not available for some reason, it will still be possible to</span>
<span class="sd">                            make parametric images.</span>
<span class="sd">        exclusion_level:    Level of additional cuts to make on the galaxies based on the quality</span>
<span class="sd">                            of postage stamp definition and/or parametric fit quality [beyond the</span>
<span class="sd">                            minimal cuts imposed when making the catalog - see Mandelbaum et</span>
<span class="sd">                            al. (2012, MNRAS, 420, 1518) for details].  Options:</span>

<span class="sd">                            - &quot;none&quot;: No cuts.</span>
<span class="sd">                            - &quot;bad_stamp&quot;: Apply cuts to eliminate galaxies that have failures in</span>
<span class="sd">                              postage stamp definition.  These cuts may also eliminate a small</span>
<span class="sd">                              subset of the good postage stamps as well.</span>
<span class="sd">                            - &quot;bad_fits&quot;: Apply cuts to eliminate galaxies that have failures in the</span>
<span class="sd">                              parametric fits.  These cuts may also eliminate a small</span>
<span class="sd">                              subset of the good parametric fits as well.</span>
<span class="sd">                            - &quot;marginal&quot;: Apply the above cuts, plus ones that eliminate some more</span>
<span class="sd">                              marginal cases.</span>

<span class="sd">                            [default: &quot;marginal&quot;]</span>
<span class="sd">        min_hlr:            Exclude galaxies whose fitted half-light radius is smaller than this</span>
<span class="sd">                            value (in arcsec).  [default: 0, meaning no limit]</span>
<span class="sd">        max_hlr:            Exclude galaxies whose fitted half-light radius is larger than this</span>
<span class="sd">                            value (in arcsec).  [default: 0, meaning no limit]</span>
<span class="sd">        min_flux:           Exclude galaxies whose fitted flux is smaller than this value.</span>
<span class="sd">                            [default: 0, meaning no limit]</span>
<span class="sd">        max_flux:           Exclude galaxies whose fitted flux is larger than this value.</span>
<span class="sd">                            [default: 0, meaning no limit]</span>
<span class="sd">        exptime:            The exposure time (in seconds) to assume when creating galaxies.</span>
<span class="sd">                            .. note::</span>

<span class="sd">                                The processed COSMOS ACS/HST science images have units of</span>
<span class="sd">                                counts/second; i.e. they have an effective exposure time of 1</span>
<span class="sd">                                second in terms of their flux levels. The default value</span>
<span class="sd">                                corresponds to a 1 second exposure on HST, which will match</span>
<span class="sd">                                these processed images.</span>

<span class="sd">                            [default: 1]</span>
<span class="sd">        area:               The effective collecting area (in cm^2) to assume when creating</span>
<span class="sd">                            galaxies. [default: None, which means to use the original HST</span>
<span class="sd">                            collecting area = pi/4 * 240**2 * (1.-0.33**2)]</span>

<span class="sd">    After construction, the following attributes are available:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nobjects:       The number of objects in the catalog</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_opt_params</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;file_name&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;dir&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;preload&#39;</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="s1">&#39;use_real&#39;</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                    <span class="s1">&#39;exclusion_level&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;min_hlr&#39;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;max_hlr&#39;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;min_flux&#39;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;max_flux&#39;</span> <span class="p">:</span> <span class="nb">float</span>
                  <span class="p">}</span>

    <span class="n">hst_eff_area</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">120</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.33</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GalSimIncompatibleValuesError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot specify both the sample and file_name.&quot;</span><span class="p">,</span>
                <span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">._pyfits</span> <span class="kn">import</span> <span class="n">pyfits</span>
        <span class="kn">from</span> <span class="nn">.real</span> <span class="kn">import</span> <span class="n">_parse_files_dirs</span>

        <span class="c1"># Parse the file name</span>
        <span class="n">file_name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">use_sample</span> <span class="o">=</span> <span class="n">_parse_files_dirs</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_sample</span> <span class="o">==</span> <span class="s2">&quot;23.5&quot;</span><span class="p">:</span>
            <span class="n">cut_ratio</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="n">sn_limit</span> <span class="o">=</span> <span class="mf">20.0</span>
            <span class="n">min_mask_dist</span> <span class="o">=</span> <span class="mf">11.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cut_ratio</span> <span class="o">=</span> <span class="mf">0.8</span>
            <span class="n">sn_limit</span> <span class="o">=</span> <span class="mf">12.0</span>
            <span class="n">min_mask_dist</span> <span class="o">=</span> <span class="mf">11.</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">_use_sample</span><span class="o">=</span><span class="n">use_sample</span><span class="p">,</span>
                         <span class="n">orig_exptime</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">orig_area</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hst_eff_area</span><span class="p">,</span>
                         <span class="n">cut_ratio</span><span class="o">=</span><span class="n">cut_ratio</span><span class="p">,</span> <span class="n">sn_limit</span><span class="o">=</span><span class="n">sn_limit</span><span class="p">,</span> <span class="n">min_mask_dist</span><span class="o">=</span><span class="n">min_mask_dist</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, GalSim-developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>