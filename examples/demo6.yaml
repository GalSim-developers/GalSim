#
# Demo #6
#
# The sixth YAML configuration file in our tutorial about using Galsim config files
# (This file is designed to be viewed in a window 100 characters wide.)
#
# This script uses real galaxy images from COSMOS observations.  The catalog of real galaxy
# images distributed with GalSim only includes 100 galaxies, but you can download a much
# larger set of images.  See https://github.com/GalSim-developers/GalSim/wiki for a link
# to the download page.
#
# The galaxy images include images of the effective PSF for the original observations, 
# so GalSim first deconvolves by that PSF, and then convolves by whatever PSF you desire.
# In this case, we use a double Gaussian PSF.  The galaxies are randomly rotated and then
# given an applied gravitational shear as well as gravitational magnification.
# The output for this script is to a FITS "data cube".  With DS9, this can be viewed with a
# slider to quickly move through the different images.
#
# New features introduced in this demo:
#
# - input : real_catalog (file_name, image_dir, preload)
# - obj type : RealGalaxy (index)
# - obj : rotate 
# - obj : magnify
# - image : sky_level
# - value type : Sequence
# - output type : DataCube (file_name, dir, nimages)
# - Using YAML's multiple document feature to do more than one thing


# In this file, we use yaml's multiple documents feature.
# This can be useful if you are doing similar things, but have a couple differences
# for the different output files.
# In this case, we output the PSF image as a single-image fits file, 
# and the galaxies are output as 100 images in both a multi-extension fits file
# and a fits data cube.

# The multiple yaml documents are separated by a line with three dashes "---"
# The first document has all the parts that are common to all the output files.
# Then each subsequent document defines its particular additions to that base.
# These are combined with the first document's information for processing.
# So if we start numbering the documents at 0, we effectively process:
#   doc[0] + doc[1]
#   doc[0] + doc[2]
#   doc[0] + doc[3]
#   ...

# So start with the common information:

# Define the PSF profile
psf : 
    type : Sum
    items :
        - { type : Gaussian, fwhm : 0.6, flux : 0.8 }
        - { type : Gaussian, fwhm : 2.3, flux : 0.2 }


# Define some other information about the images 
image :
    # The pixel size applies to both outputs, so put that here in the first document.
    pixel_scale : 0.15  # arcsec / pixel

    # This time, we'll leave the size unspecified to let GalSim automatically choose 
    # an appropriate size.  So no image : size item.
    

---

# The first specialization document is for the psf output.

# Define the name and format of the output file
output :
    dir : output_yaml
    file_name : psf_real.fits
 
---

# The next document is for the galaxy output.

# Define the galaxy profile
gal :
    type : RealGalaxy
    flux : 1.e5

    index : 
        type : Sequence 
        # Sequence can optionally take first, last, and step, however, the defaults 
        # are fine here: 
        #   first = 0
        #   last = <num entries in catalog> - 1
        #   step = 1
        # If the sequential values get past last, they will repeat back at first, so it's
        # ok to have nobjects greater than the number of real galaxies in the catalog.
    
    rotate :
        # An angle of type Random means uniform within 0 .. 2pi radians
        type : Random

    shear : 
        type : G1G2 
        g1 : -0.027
        g2 : 0.031

    # Also apply a magnification mu = ( (1-kappa)^2 - |gamma|^2 )^-1
    # This conserves surface brightness, so it scales both the size and flux.
    magnify : 1.082

# Define some other information about the images 
image :
    
    # If we specify the sky_level as an image attribute, it will be used
    # as a background level for the image.  
    sky_level : 1.e6  # ADU / arcsec^2

    # Since we already specified a sky_level for the whole image, we don't need
    # to repeat it for the noise.  So in fact, everything is default here.
    # So we can just set the noise to an empty dictionary, which means use all defaults.
    # (If we omit it entirely, that would mean no noise, which isn't what we want.)
    noise : {}

    random_seed : 1512413

    # Note: since the output includes a data_cube output, which requires all the
    # images to be the same size, GalSim will choose the size of the first image
    # automatically from the profile (since we aren't setting any image : size here), 
    # but then subsequent images will be forced to be the same size as the first one.


# Define the input files
input :
    # In this case, we need to define where the real galaxy input catalog is.
    real_catalog :
        image_dir : data
        file_name : real_galaxy_catalog_example.fits
        preload : True   # This usually makes a big improvement in speed


# Define the name and format of the output file
output :
    type : DataCube
    dir : output_yaml
    file_name : cube_real.fits
    nimages : 100
 
